<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <title>NusaTask – Earning</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
  <style>
    :root { color-scheme: dark; }
    body { min-height:100vh; background: radial-gradient(1200px 600px at 20% -10%, rgba(168,85,247,.25), transparent), radial-gradient(900px 450px at 120% 10%, rgba(59,130,246,.2), transparent), #0b0b0f; }
    .glass { background: rgba(23,23,28,.7); backdrop-filter: blur(10px); }
    .card { border:1px solid rgba(148,163,184,.15); }
    .shine { position:relative; overflow:hidden; }
    .shine::after{content:""; position:absolute; inset:-150% -50%; background:linear-gradient(120deg, transparent 30%, rgba(255,255,255,.08) 50%, transparent 70%); transform:rotate(12deg); animation:shine 6s linear infinite; }
    @keyframes shine { from{transform:translateX(-20%) rotate(12deg)} to{transform:translateX(120%) rotate(12deg)} }
    .fade-in { animation: fade .25s ease-out; } @keyframes fade{from{opacity:0; transform:translateY(4px)} to{opacity:1; transform:none}}
    .pop { animation: pop .18s ease-out; } @keyframes pop{from{transform:scale(.98)} to{transform:scale(1)}}
    .btn-disabled { background:#4b5563 !important; cursor:not-allowed !important; }
    .spinner { width:1rem; height:1rem; border:.18rem solid rgba(255,255,255,.25); border-top-color:#fff; border-radius:50%; animation:spin .7s linear infinite; display:inline-block; vertical-align:-2px; margin-right:.5rem;}
    @keyframes spin{to{transform:rotate(360deg)}}
  </style>
</head>
<body class="text-slate-200 flex items-center justify-center p-4">

  <!-- Toast -->
  <div id="toast" class="fixed top-4 right-4 hidden z-50"></div>

  <!-- Modal Iklan -->
  <div id="adModal" class="hidden fixed inset-0 z-40 bg-black/70 backdrop-blur-sm">
    <div class="h-full w-full flex items-center justify-center p-4">
      <div class="glass card w-full max-w-md rounded-2xl p-6 fade-in">
        <div class="mb-4">
          <h3 id="adTitle" class="text-xl font-semibold text-violet-300">Iklan</h3>
          <p id="adDesc" class="text-slate-300 mt-1">Memuat…</p>
        </div>
        <!-- Tempat slot script iklan produksi -->
        <div id="adSlot" class="h-36 rounded-lg border border-slate-700/60 flex items-center justify-center text-slate-400 text-sm mb-5">
          <span>Preview iklan (dummy)</span>
        </div>
        <button id="adClose" class="w-full py-2.5 rounded-xl bg-violet-600 hover:bg-violet-700 transition">
          Tutup
        </button>
      </div>
    </div>
  </div>

  <!-- Auth Card -->
  <div id="authCard" class="glass card w-full max-w-md rounded-2xl p-6 fade-in">
    <div class="flex items-center gap-2 mb-6">
      <div class="h-9 w-9 rounded-xl bg-violet-600/20 border border-violet-500/30 flex items-center justify-center">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none"><path d="M12 3l8 4-8 4-8-4 8-4ZM4 12l8 4 8-4M4 17l8 4 8-4" stroke="#c4b5fd" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg>
      </div>
      <div>
        <h1 class="text-xl font-semibold">NusaTask</h1>
        <p class="text-xs text-slate-400 -mt-0.5">Earning Panel</p>
      </div>
    </div>

    <div class="space-y-3">
      <input id="email" type="email" placeholder="Email" class="w-full bg-slate-900/60 border border-slate-700/60 rounded-xl px-3.5 py-2.5 focus:outline-none focus:ring-2 focus:ring-violet-600" />
      <input id="password" type="password" placeholder="Password" class="w-full bg-slate-900/60 border border-slate-700/60 rounded-xl px-3.5 py-2.5 focus:outline-none focus:ring-2 focus:ring-violet-600" />
      <button id="btnLogin" class="w-full py-2.5 rounded-xl bg-violet-600 hover:bg-violet-700 transition">Masuk</button>
      <button id="btnRegister" class="w-full py-2.5 rounded-xl bg-slate-700/60 hover:bg-slate-700 transition">Daftar</button>
    </div>

    <div class="mt-6 p-3 rounded-xl bg-amber-500/10 border border-amber-500/30 text-amber-200 text-xs">
      <b>Peringatan:</b> 1 IP hanya boleh untuk 1 akun. Pelanggaran akan diblokir otomatis.
    </div>
  </div>

  <!-- Dashboard -->
  <div id="dash" class="hidden w-full max-w-2xl space-y-5 fade-in">
    <div class="glass card rounded-2xl p-5 shine pop">
      <div class="flex items-center justify-between gap-4">
        <div class="flex items-center gap-3">
          <div class="h-10 w-10 rounded-xl bg-violet-600/20 border border-violet-500/30 flex items-center justify-center">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none"><path d="M4 7h16M4 12h16M4 17h16" stroke="#c4b5fd" stroke-width="1.5" stroke-linecap="round"/></svg>
          </div>
          <div>
            <h2 class="text-lg font-semibold">NusaTask</h2>
            <p class="text-xs text-slate-400">Panel Earning</p>
          </div>
        </div>
        <div class="text-right">
          <p class="text-xs text-slate-400">Saldo Anda</p>
          <p id="saldoText" class="text-3xl font-bold tracking-tight">Rp0</p>
        </div>
      </div>
    </div>

    <div class="grid md:grid-cols-2 gap-5">
      <!-- Tugas Harian -->
      <div class="glass card rounded-2xl p-5">
        <h3 class="font-semibold mb-3">Tugas Harian (Monetag)</h3>
        <button id="earn1" class="task-btn w-full py-3 rounded-xl bg-gradient-to-r from-emerald-500 to-emerald-700 hover:opacity-90 transition mb-3">
          Menghasilkan 1 (Rp200)
        </button>
        <button id="earn2" class="task-btn w-full py-3 rounded-xl bg-gradient-to-r from-emerald-500 to-emerald-700 hover:opacity-90 transition">
          Menghasilkan 2 (Rp200)
        </button>
        <p class="text-[11px] text-slate-400 mt-3">*Max 20x per tombol • Cooldown 2 menit</p>
      </div>

      <!-- Bonus -->
      <div class="glass card rounded-2xl p-5">
        <h3 class="font-semibold mb-3">Xstra Bonus (KlikAdila)</h3>
        <button id="bonus1" class="task-btn w-full py-3 rounded-xl bg-gradient-to-r from-amber-400 to-amber-600 text-black font-semibold hover:opacity-90 transition mb-3">
          Xstra Bonus 1 (Rp500)
        </button>
        <button id="bonus2" class="task-btn w-full py-3 rounded-xl bg-gradient-to-r from-amber-400 to-amber-600 text-black font-semibold hover:opacity-90 transition">
          Xstra Bonus 2 (Rp500)
        </button>
        <p class="text-[11px] text-slate-400 mt-3">*Inpage 4 detik → Popunder 2 detik</p>
      </div>
    </div>

    <div class="text-[11px] text-slate-400 text-center">
      Reset batas harian otomatis pukul <b>03:00 WIB</b>.
    </div>
  </div>

  <script>
    // ================== Firebase ==================
    const firebaseConfig = {
      apiKey: "AIzaSyCrFmaHbmL299cum51EtJIjt5NpukpTmho",
      authDomain: "penyimpanansaldo-280df.firebaseapp.com",
      databaseURL: "https://penyimpanansaldo-280df-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "penyimpanansaldo-280df",
      storageBucket: "penyimpanansaldo-280df.firebasestorage.app",
      messagingSenderId: "659609775130",
      appId: "1:659609775130:web:bdd088ca5a877498c5b5a3",
      measurementId: "G-L4TW7E23H2"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.database();
    let currentUser = null;
    let saldoAnim = 0, saldoTimer = null;

    // ================== UI Helpers ==================
    function toast(msg, type="info"){
      const el = document.getElementById("toast");
      el.className = "fixed top-4 right-4 z-50";
      const color = type==="success"?"bg-emerald-600":type==="error"?"bg-rose-600":"bg-slate-700";
      el.innerHTML = `<div class="rounded-xl ${color} px-4 py-3 shadow-xl border border-white/10 fade-in">${msg}</div>`;
      el.classList.remove("hidden");
      setTimeout(()=> el.classList.add("hidden"), 2500);
    }

    function setBtnLoading(btn, isLoading, baseText){
      if(isLoading){
        btn.dataset.base = baseText || btn.textContent.trim();
        btn.disabled = true;
        btn.classList.add("btn-disabled");
        btn.innerHTML = `<span class="spinner"></span>Memproses…`;
      }else{
        btn.disabled = false;
        btn.classList.remove("btn-disabled");
        btn.textContent = baseText || btn.dataset.base || "Selesai";
      }
    }

    function setCooldown(btn, seconds){
      btn.disabled = true;
      btn.classList.add("btn-disabled");
      const label = btn.dataset.base || btn.textContent.trim();
      let remain = seconds;
      btn.textContent = `Cooldown (${remain}s)`;
      const t = setInterval(()=>{
        remain--;
        btn.textContent = `Cooldown (${remain}s)`;
        if(remain<=0){
          clearInterval(t);
          btn.disabled = false;
          btn.classList.remove("btn-disabled");
          btn.textContent = label;
        }
      },1000);
    }

    function animateSaldo(toVal){
      clearInterval(saldoTimer);
      const steps = 24;
      let i = 0;
      const from = saldoAnim;
      const diff = toVal - from;
      saldoTimer = setInterval(()=>{
        i++;
        const v = Math.round(from + diff * (i/steps));
        saldoAnim = v;
        document.getElementById("saldoText").textContent = "Rp" + (v).toLocaleString("id-ID");
        if(i>=steps) clearInterval(saldoTimer);
      }, 20);
    }

    // ================== Auth & Init ==================
    function initUserData(user){
      const ref = db.ref("users/"+user.uid);
      ref.once("value").then(s=>{
        if(!s.exists()){
          return ref.set({ saldo:0, createdAt: Date.now(), status:"active" });
        }
      });
    }

    function bindSaldo(user){
      db.ref("users/"+user.uid+"/saldo").on("value", snap=>{
        animateSaldo((snap.val()||0));
      });
    }

    auth.onAuthStateChanged(u=>{
      if(u){
        currentUser = u;
        document.getElementById("authCard").classList.add("hidden");
        document.getElementById("dash").classList.remove("hidden");
        initUserData(u);
        bindSaldo(u);
      }else{
        currentUser = null;
        document.getElementById("dash").classList.add("hidden");
        document.getElementById("authCard").classList.remove("hidden");
      }
    });

    document.getElementById("btnLogin").onclick = ()=>{
      const email = document.getElementById("email").value.trim();
      const pass  = document.getElementById("password").value.trim();
      auth.signInWithEmailAndPassword(email, pass)
        .then(()=> toast("Login sukses","success"))
        .catch(e=> toast(e.message,"error"));
    };

    document.getElementById("btnRegister").onclick = ()=>{
      const email = document.getElementById("email").value.trim();
      const pass  = document.getElementById("password").value.trim();
      auth.createUserWithEmailAndPassword(email, pass)
        .then(()=> { initUserData(auth.currentUser); toast("Akun dibuat","success"); })
        .catch(e=> toast(e.message,"error"));
    };

    // ================== Reset Harian 03:00 WIB ==================
    function getResetKeyWIB(now=new Date()){
      // WIB = UTC+7; hitung tanggal berdasarkan WIB
      const utc = now.getTime() + now.getTimezoneOffset()*60000;
      const wib = new Date(utc + 7*3600000);
      const reset = new Date(wib.getFullYear(), wib.getMonth(), wib.getDate(), 3, 0, 0); // 03:00 WIB
      if(wib < reset) reset.setDate(reset.getDate()-1);
      // key harian pakai tanggal reset berikutnya (YYYY-MM-DD)
      return reset.toISOString().split("T")[0];
    }

    function ensureDaily(uid){
      const key = getResetKeyWIB();
      const ref = db.ref(`daily/${uid}/lastReset`);
      return ref.get().then(s=>{
        if(s.val() !== key){
          return db.ref(`daily/${uid}`).set({ lastReset: key });
        }
      }).then(()=> key);
    }

    // ================== Modal Iklan ==================
    function showAd({title, desc, duration=3000}, cb){
      const modal = document.getElementById("adModal");
      const adTitle = document.getElementById("adTitle");
      const adDesc  = document.getElementById("adDesc");
      const adSlot  = document.getElementById("adSlot");
      if(!modal || !adTitle || !adDesc){ console.warn("Modal tidak ditemukan"); cb && cb(); return; }

      adTitle.textContent = title;
      adDesc.textContent  = desc;

      // TODO: pasang script Monetag / KlikAdila di sini (produksi)
      adSlot.innerHTML = `<span>Preview iklan (dummy)</span>`;

      modal.classList.remove("hidden");
      const timer = setTimeout(()=>{ closeAd(); cb && cb(); }, duration);
      document.getElementById("adClose").onclick = ()=>{ clearTimeout(timer); closeAd(); cb && cb(); };
    }
    function closeAd(){ document.getElementById("adModal").classList.add("hidden"); }

    // ================== Core Earning Logic ==================
    const LIMIT_PER_BUTTON = 20;
    const COOLDOWN_SEC = 120;

    function addSaldo(uid, amount){
      return db.ref(`users/${uid}/saldo`).transaction(v => (v||0) + amount);
    }

    function handleTask(btnId, amount, adFlow){
      const btn = document.getElementById(btnId);
      if(!currentUser){ toast("Harus login dulu!","error"); return; }

      setBtnLoading(btn, true, btn.textContent.trim());

      ensureDaily(currentUser.uid).then(key=>{
        const cdRef   = db.ref(`cooldowns/${currentUser.uid}/${btnId}`);
        const dailyRef= db.ref(`daily/${currentUser.uid}/${key}/${btnId}`);

        const now = Date.now();
        return cdRef.get().then(cd=>{
          const last = cd.val() || 0;
          if(now - last < COOLDOWN_SEC*1000){
            setBtnLoading(btn, false);
            const s = Math.ceil((COOLDOWN_SEC*1000 - (now-last))/1000);
            toast(`Cooldown aktif ${s}s`, "error");
            return Promise.reject("cooldown");
          }
          return dailyRef.get().then(d=>{
            const cnt = d.val() || 0;
            if(cnt >= LIMIT_PER_BUTTON){
              setBtnLoading(btn, false);
              toast("Limit harian tombol ini sudah tercapai", "error");
              return Promise.reject("limit");
            }

            // Jalankan flow iklan
            const runAdFlow = () => new Promise(resolve=>{
              // adFlow: array langkah iklan {title, desc, duration}
              const steps = [...adFlow];
              const next = ()=>{
                if(steps.length === 0) return resolve();
                const step = steps.shift();
                showAd(step, next);
              };
              next();
            });

            return runAdFlow().then(()=>{
              return addSaldo(currentUser.uid, amount).then(()=>{
                cdRef.set(now);
                dailyRef.set(cnt+1);
                toast(`+Rp${amount.toLocaleString("id-ID")} berhasil`, "success");
                setBtnLoading(btn, false);
                setCooldown(btn, COOLDOWN_SEC);
              });
            });
          });
        });
      }).catch(err=>{
        if(err!=="cooldown" && err!=="limit"){
          console.error(err);
          setBtnLoading(btn, false);
          toast("Terjadi kesalahan, coba lagi", "error");
        }
      });
    }

    // ================== Bind Buttons ==================
    document.getElementById("earn1").onclick = ()=> handleTask(
      "earn1",
      200,
      [
        { title:"Monetag – Inpage", desc:"Tunggu 3 detik", duration:3000 }
      ]
    );
    document.getElementById("earn2").onclick = ()=> handleTask(
      "earn2",
      200,
      [
        { title:"Monetag – Inpage", desc:"Tunggu 3 detik", duration:3000 }
      ]
    );
    document.getElementById("bonus1").onclick = ()=> handleTask(
      "bonus1",
      500,
      [
        { title:"KlikAdila – Inpage", desc:"Tunggu 4 detik", duration:4000 },
        { title:"KlikAdila – Popunder", desc:"Tunggu 2 detik", duration:2000 }
      ]
    );
    document.getElementById("bonus2").onclick = ()=> handleTask(
      "bonus2",
      500,
      [
        { title:"KlikAdila – Inpage", desc:"Tunggu 4 detik", duration:4000 },
        { title:"KlikAdila – Popunder", desc:"Tunggu 2 detik", duration:2000 }
      ]
    );
  </script>
</body>
</html>
