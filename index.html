<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Penghasil Uang</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50 dark:bg-gray-900 text-gray-800 dark:text-gray-200 min-h-screen">

  <!-- Toast -->
  <div id="toast" class="fixed bottom-5 left-1/2 -translate-x-1/2 hidden px-4 py-2 rounded-lg bg-gray-800 text-white text-sm shadow-lg"></div>

  <!-- Auth Section -->
  <div id="authSection" class="p-6 space-y-6">
    <div class="text-center text-2xl font-bold">🔑 Masuk / Daftar</div>
    
    <div class="space-y-3">
      <h3 class="font-semibold">Login</h3>
      <input id="loginEmail" type="email" placeholder="Email" class="w-full p-3 rounded-lg border dark:bg-gray-800" />
      <input id="loginPassword" type="password" placeholder="Password" class="w-full p-3 rounded-lg border dark:bg-gray-800" />
      <button onclick="login()" class="w-full bg-blue-600 text-white py-3 rounded-lg">Login</button>
    </div>

    <div class="space-y-3">
      <h3 class="font-semibold">Register</h3>
      <input id="registerEmail" type="email" placeholder="Email" class="w-full p-3 rounded-lg border dark:bg-gray-800" />
      <input id="registerPassword" type="password" placeholder="Password" class="w-full p-3 rounded-lg border dark:bg-gray-800" />
      <button onclick="register()" class="w-full bg-green-600 text-white py-3 rounded-lg">Register</button>
    </div>
  </div>

  <!-- Main Section -->
  <div id="mainSection" class="hidden p-6 space-y-6">
    <!-- Header -->
    <header class="flex justify-between items-center">
      <span id="userInfo" class="font-semibold"></span>
      <button onclick="logout()" class="text-red-500">Logout</button>
    </header>

    <!-- Saldo Card -->
    <div class="bg-gradient-to-r from-blue-500 to-indigo-600 text-white p-6 rounded-2xl shadow-lg">
      <div>Saldo</div>
      <div class="text-3xl font-bold">Rp <span id="saldo">0</span></div>
    </div>

    <!-- Aksi -->
    <div class="grid grid-cols-1 gap-4">
      <button id="monetagBtn" onclick="klikIklanMonetag()" class="flex items-center justify-center gap-2 bg-blue-600 text-white py-4 rounded-2xl shadow-md">
        📺 Klik Iklan Monetag (+Rp30.000)
      </button>
      <button id="hiltoadsBtn" onclick="klikIklanHiltoads()" class="flex items-center justify-center gap-2 bg-purple-600 text-white py-4 rounded-2xl shadow-md">
        🎯 Tugas Hiltoads (+Rp30.000)
      </button>
    </div>

    <!-- Riwayat WD -->
    <div>
      <h3 class="text-lg font-semibold mb-2">Riwayat WD</h3>
      <ul id="riwayatWd" class="space-y-2 text-sm"></ul>
    </div>

    <!-- Withdraw -->
    <div class="space-y-3">
      <h3 class="text-lg font-semibold">Withdraw</h3>
      <input id="ewallet" type="text" placeholder="Nomor E-Wallet" class="w-full p-3 rounded-lg border dark:bg-gray-800" />
      <button onclick="withdraw()" class="w-full bg-green-600 text-white py-3 rounded-lg">Ajukan WD (Min Rp30.000)</button>
    </div>

    <!-- Footer -->
    <div class="flex justify-between items-center pt-4 border-t dark:border-gray-700">
      <button onclick="toggleTheme()" class="px-4 py-2 bg-gray-200 dark:bg-gray-700 rounded-lg">🌙 / ☀️</button>
      <button onclick="window.open('https://t.me/usernamekamu','_blank')" class="px-4 py-2 bg-blue-500 text-white rounded-lg">Help</button>
    </div>
  </div>

  <!-- Firebase + Script -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import { getFirestore, doc, setDoc, getDoc, updateDoc, addDoc, collection, query, where, getDocs, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCrFmaHbmL299cum51EtJIjt5NpukpTmho",
      authDomain: "penyimpanansaldo-280df.firebaseapp.com",
      projectId: "penyimpanansaldo-280df",
      storageBucket: "penyimpanansaldo-280df.firebasestorage.app",
      messagingSenderId: "659609775130",
      appId: "1:659609775130:web:bdd088ca5a877498c5b5a3",
      measurementId: "G-L4TW7E23H2"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    function showToast(msg) {
      const t = document.getElementById("toast");
      t.innerText = msg;
      t.classList.remove("hidden");
      setTimeout(()=>t.classList.add("hidden"),3000);
    }

    async function register() {
      try {
        const email = registerEmail.value, pass = registerPassword.value;
        await createUserWithEmailAndPassword(auth, email, pass);
        showToast("✅ Registrasi sukses!");
      } catch (e) { showToast("❌ "+e.message); }
    }

    async function login() {
      try {
        const email = loginEmail.value, pass = loginPassword.value;
        await signInWithEmailAndPassword(auth, email, pass);
        showToast("✅ Login sukses!");
      } catch (e) { showToast("❌ "+e.message); }
    }

    async function logout(){ await signOut(auth); }

    onAuthStateChanged(auth, async (user)=>{
      if(user){
        authSection.classList.add("hidden");
        mainSection.classList.remove("hidden");
        loadUserData(user);
      } else {
        authSection.classList.remove("hidden");
        mainSection.classList.add("hidden");
      }
    });

    async function loadUserData(user){
      userInfo.innerText="👤 "+user.email;
      const ref=doc(db,"users",user.uid);
      const snap=await getDoc(ref);
      if(!snap.exists()){
        await setDoc(ref,{saldo:0,lastMonetag:null,monetagCount:0,lastHiltoads:null});
        saldo.innerText=0;
      } else saldo.innerText=snap.data().saldo;
      loadRiwayatWD(user.uid);
    }

    async function klikIklanMonetag(){
      const user=auth.currentUser, ref=doc(db,"users",user.uid);
      const snap=await getDoc(ref), d=snap.data(), now=new Date();
      const last=d.lastMonetag?.toDate?.()||new Date(0);
      if(last.toDateString()!==now.toDateString() && now.getHours()>=3){await updateDoc(ref,{monetagCount:0}); d.monetagCount=0;}
      if(d.monetagCount>=20) return showToast("⚠️ Batas harian 20x!");
      await updateDoc(ref,{saldo:d.saldo+30000,lastMonetag:serverTimestamp(),monetagCount:(d.monetagCount||0)+1});
      saldo.innerText=d.saldo+30000; showToast("+Rp30.000 dari Monetag!");
    }

    async function klikIklanHiltoads(){
      const user=auth.currentUser, ref=doc(db,"users",user.uid);
      const snap=await getDoc(ref), d=snap.data(), now=new Date();
      if(d.lastHiltoads){const diff=(now-d.lastHiltoads.toDate())/60000; if(diff<10)return showToast("⏳ Tunggu "+Math.ceil(10-diff)+" menit");}
      await updateDoc(ref,{saldo:d.saldo+30000,lastHiltoads:serverTimestamp()});
      saldo.innerText=d.saldo+30000; showToast("+Rp30.000 dari Hiltoads!");
    }

    async function withdraw(){
      const user=auth.currentUser, ref=doc(db,"users",user.uid);
      const snap=await getDoc(ref), d=snap.data();
      const ewallet=ewallet.value;
      if(!ewallet) return showToast("❌ Masukkan nomor e-wallet");
      if(d.saldo<30000) return showToast("⚠️ Minimal Rp30.000");
      await addDoc(collection(db,"withdrawals"),{uid:user.uid,ewallet,amount:30000,status:"pending",createdAt:serverTimestamp()});
      await updateDoc(ref,{saldo:d.saldo-30000});
      saldo.innerText=d.saldo-30000; showToast("✅ WD diajukan!"); loadRiwayatWD(user.uid);
    }

    async function loadRiwayatWD(uid){
      const q=query(collection(db,"withdrawals"),where("uid","==",uid));
      const snaps=await getDocs(q); riwayatWd.innerHTML="";
      snaps.forEach(docu=>{
        const d=docu.data();
        riwayatWd.innerHTML+=`<li class="p-3 rounded-lg bg-gray-100 dark:bg-gray-800 flex justify-between">
          <span>Rp${d.amount}</span> <span class="capitalize">${d.status}</span>
        </li>`;
      });
    }

    function toggleTheme(){ document.body.classList.toggle("dark"); }
  </script>
</body>
</html>
