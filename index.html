<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Penghasil Uang ‚Äì Pro</title>
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- ====== ADS SDKs ====== -->
  <!-- RichAds (Telegram controller) -->
  <script src="https://richinfo.co/richpartners/telegram/js/tg-ob.js"></script>
  <script>
    window.TelegramAdsController = new TelegramAdsController();
    window.TelegramAdsController.initialize({ pubId: "984631", appId: "3504" });
  </script>

  <!-- Monetag SDK -->
  <script src="//libtl.com/sdk.js" data-zone="9779635" data-sdk="show_9779635"></script>

  <!-- Telegram WebApp + Adexium -->
  <script src="https://telegram.org/js/telegram-web-app.js?56"></script>
  <script src="https://cdn.tgads.space/assets/js/adexium-widget.min.js"></script>

  <style>
    :root{
      --btn: linear-gradient(135deg,#2563eb,#4f46e5);
      --btn2: linear-gradient(135deg,#7c3aed,#6d28d9);
      --cool: #9ca3af;
    }
    .hidden{display:none}
    .btn-main{background: var(--btn);}
    .btn-alt{background: var(--btn2);}
    .btn-cool{background: var(--cool)!important}
    body.dark{background:#0b1220}
    /* ripple */
    .ripple{position:relative;overflow:hidden}
    .ripple:after{
      content:""; position:absolute; inset:0; transform:scale(0);
      background:rgba(255,255,255,.25); border-radius:inherit;
      transition:transform .4s ease-out, opacity .6s ease-out; opacity:0;
    }
    .ripple:active:after{transform:scale(1); opacity:1}
    /* toast slide */
    #toast{transition:transform .3s ease, opacity .3s ease}
    #toast.show{transform:translate(-50%,0); opacity:1}
    #toast.hide{transform:translate(-50%,12px); opacity:0}
  </style>
</head>
<body class="bg-gray-50 dark:bg-slate-900 text-gray-800 dark:text-slate-100 min-h-screen">
  <!-- TOAST -->
  <div id="toast" class="fixed bottom-4 left-1/2 -translate-x-1/2 z-50 px-4 py-2 rounded-lg bg-gray-900 text-white text-sm shadow-lg hide opacity-0"></div>

  <main class="max-w-md mx-auto p-4">

    <!-- ===== AUTH SECTION ===== -->
    <section id="authSection" class="space-y-5">
      <h1 class="text-center text-2xl font-extrabold">üîê Masuk / Daftar</h1>

      <!-- 2 Banner atas -->
      <div class="grid grid-cols-2 gap-2">
        <img src="https://via.placeholder.com/300x80?text=Hiltoads+Banner+A" class="w-full rounded-lg shadow" alt="Hiltoads A">
        <img src="https://via.placeholder.com/300x80?text=Hiltoads+Banner+B" class="w-full rounded-lg shadow" alt="Hiltoads B">
      </div>

      <!-- Tabs -->
      <div class="flex rounded-xl overflow-hidden border dark:border-slate-700">
        <button id="btnLoginTab" class="flex-1 py-2 bg-blue-600 text-white font-medium">Login</button>
        <button id="btnRegisterTab" class="flex-1 py-2 bg-gray-200 dark:bg-slate-800">Register</button>
      </div>

      <!-- Login Form -->
      <div id="loginForm" class="space-y-3">
        <input id="loginEmail" type="email" placeholder="Email" class="w-full p-3 rounded-lg border dark:border-slate-700 dark:bg-slate-800">
        <input id="loginPassword" type="password" placeholder="Password" class="w-full p-3 rounded-lg border dark:border-slate-700 dark:bg-slate-800">
        <button id="btnLogin" class="w-full py-3 rounded-xl text-white font-semibold btn-main ripple">Login</button>
      </div>

      <!-- Register Form -->
      <div id="registerForm" class="space-y-3 hidden">
        <input id="registerEmail" type="email" placeholder="Email" class="w-full p-3 rounded-lg border dark:border-slate-700 dark:bg-slate-800">
        <input id="registerPassword" type="password" placeholder="Password (min 6)" class="w-full p-3 rounded-lg border dark:border-slate-700 dark:bg-slate-800">
        <button id="btnRegister" class="w-full py-3 rounded-xl text-white font-semibold bg-emerald-600 ripple">Register</button>
      </div>

      <!-- 2 Banner bawah -->
      <div class="grid grid-cols-2 gap-2">
        <img src="https://via.placeholder.com/300x80?text=Hiltoads+Banner+C" class="w-full rounded-lg shadow" alt="Hiltoads C">
        <img src="https://via.placeholder.com/300x80?text=Hiltoads+Banner+D" class="w-full rounded-lg shadow" alt="Hiltoads D">
      </div>
    </section>

    <!-- ===== MAIN SECTION ===== -->
    <section id="mainSection" class="hidden space-y-5">
      <!-- Header -->
      <header class="flex items-center justify-between">
        <div class="flex items-center gap-3">
          <img id="userPhoto" src="https://i.pravatar.cc/80" class="w-11 h-11 rounded-full ring-2 ring-white/50" alt="avatar">
          <div class="text-sm">
            <div class="font-semibold leading-tight" id="userName">username</div>
            <div class="text-gray-500 dark:text-slate-400 text-xs">Aktif</div>
          </div>
        </div>
        <div class="text-right">
          <div class="text-[11px] text-gray-500 dark:text-slate-400">Saldo</div>
          <div class="text-xl font-extrabold text-emerald-500 transition-all" id="saldoLabel">Rp 0</div>
          <div id="harianLabel" class="text-[11px] text-gray-500 dark:text-slate-400"></div>
        </div>
      </header>

      <!-- Username Telegram (editable sekali) -->
      <div class="p-3 rounded-xl bg-white dark:bg-slate-800 border dark:border-slate-700">
        <label class="text-xs text-gray-500 dark:text-slate-400">Username Telegram</label>
        <div class="flex gap-2 mt-1">
          <input id="tgUsername" type="text" placeholder="@username" class="flex-1 p-2 rounded-lg border dark:border-slate-700 dark:bg-slate-900">
          <button id="btnSaveUser" class="px-3 rounded-lg bg-gray-800 text-white text-sm">Simpan</button>
        </div>
        <p class="text-[11px] text-gray-500 dark:text-slate-400 mt-1">Nama & foto profil akan mengikuti username ini.</p>
      </div>

      <!-- ===== BUTTON GRID (3 baris x 2 tombol) ===== -->
      <div class="grid gap-3">

        <!-- ROW 1 -->
        <div class="grid grid-cols-2 gap-3">
          <button id="gen1" class="w-full py-4 rounded-2xl text-white font-semibold btn-main ripple">
            Menghasilkan
            <div class="text-[11px] opacity-90" id="cd-gen1"></div>
            <div class="text-[10px] mt-1 text-gray-100/90">Reward Rp30.000 ¬∑ Cooldown 3 mnt</div>
          </button>
          <button id="xtra1" class="w-full py-4 rounded-2xl text-white font-semibold btn-alt ripple">
            Xstra Bonus
            <div class="text-[11px] opacity-90" id="cd-xtra1"></div>
            <div class="text-[10px] mt-1 text-gray-100/90">Reward Rp30.000 ¬∑ Cooldown 3 mnt</div>
          </button>
        </div>

        <!-- ROW 2 -->
        <div class="grid grid-cols-2 gap-3">
          <button id="gen2" class="w-full py-4 rounded-2xl text-white font-semibold btn-main ripple">
            Menghasilkan
            <div class="text-[11px] opacity-90" id="cd-gen2"></div>
            <div class="text-[10px] mt-1 text-gray-100/90">Reward Rp30.000 ¬∑ Cooldown 3 mnt</div>
          </button>
          <button id="xtra2" class="w-full py-4 rounded-2xl text-white font-semibold btn-alt ripple">
            Xstra Bonus
            <div class="text-[11px] opacity-90" id="cd-xtra2"></div>
            <div class="text-[10px] mt-1 text-gray-100/90">Reward Rp30.000 ¬∑ Cooldown 3 mnt</div>
          </button>
        </div>

        <!-- ROW 3 -->
        <div class="grid grid-cols-2 gap-3">
          <button id="gen3" class="w-full py-4 rounded-2xl text-white font-semibold btn-main ripple">
            Menghasilkan
            <div class="text-[11px] opacity-90" id="cd-gen3"></div>
            <div class="text-[10px] mt-1 text-gray-100/90">Reward Rp30.000 ¬∑ Cooldown 3 mnt</div>
          </button>
          <button id="xtra3" class="w-full py-4 rounded-2xl text-white font-semibold btn-alt ripple">
            Xstra Bonus
            <div class="text-[11px] opacity-90" id="cd-xtra3"></div>
            <div class="text-[10px] mt-1 text-gray-100/90">Reward Rp30.000 ¬∑ Cooldown 3 mnt</div>
          </button>
        </div>

        <!-- Info sisa harian per grup -->
        <div class="text-center text-[11px] text-gray-500 dark:text-slate-400">
          Menghasilkan tersisa: <span id="leftGen">0</span>/20 ‚Ä¢ Xstra tersisa: <span id="leftXtra">0</span>/20 (reset 03:00 WIB)
        </div>
      </div>

      <!-- ACTION CARD (WD + Link Sosmed + Riwayat) -->
      <section class="space-y-3 p-4 rounded-2xl bg-white dark:bg-slate-800 border dark:border-slate-700">
        <h3 class="font-bold">Withdraw</h3>
        <div class="grid grid-cols-2 gap-3">
          <select id="walletType" class="p-3 rounded-lg border dark:border-slate-700 dark:bg-slate-900">
            <option value="Dana">Dana</option>
            <option value="OVO">OVO</option>
            <option value="GoPay">GoPay</option>
            <option value="ShopeePay">ShopeePay</option>
          </select>
          <input id="walletNumber" type="tel" inputmode="numeric" placeholder="Nomor e-wallet" class="p-3 rounded-lg border dark:border-slate-700 dark:bg-slate-900"/>
        </div>
        <input id="wdAmount" type="number" min="30000" step="1000" value="30000" class="w-full p-3 rounded-lg border dark:border-slate-700 dark:bg-slate-900"/>
        <button id="btnWD" class="w-full py-3 rounded-xl bg-emerald-600 text-white font-semibold ripple">Ajukan WD (Min Rp30.000)</button>

        <div class="flex gap-2 pt-2">
          <a href="https://t.me/nusataskproject" target="_blank" class="flex-1 text-center py-2 rounded-xl bg-blue-600 text-white ripple">Help</a>
          <a href="https://www.youtube.com/@NUSATASKPROJECTS" target="_blank" class="flex-1 text-center py-2 rounded-xl bg-red-600 text-white ripple">YouTube</a>
          <a href="https://www.instagram.com/nusataskproject?igsh=MTh5Ync0bjhqeGxtdg==" target="_blank" class="flex-1 text-center py-2 rounded-xl bg-pink-600 text-white ripple">Instagram</a>
        </div>

        <button id="btnRiwayat" class="w-full py-2 rounded-xl bg-gray-700 text-white ripple">Riwayat WD</button>

        <div class="flex items-center justify-between pt-3 border-t dark:border-slate-700">
          <div class="text-xs text-gray-500 dark:text-slate-400">Tema</div>
          <label class="inline-flex items-center cursor-pointer">
            <input id="themeToggle" type="checkbox" class="sr-only">
            <span class="w-10 h-6 bg-gray-300 dark:bg-slate-700 rounded-full relative">
              <span id="knob" class="absolute left-1 top-1 w-4 h-4 bg-white rounded-full transition-all"></span>
            </span>
          </label>
        </div>
      </section>
    </section>

    <!-- ===== HILTOADS SECTION (5 Banner, hold 5s) ===== -->
    <section id="hiltoadsSection" class="hidden space-y-4">
      <div class="flex items-center justify-between">
        <h3 class="text-xl font-bold">Iklan Hiltoads</h3>
        <button id="btnBackHiltoads" class="px-3 py-2 rounded-lg bg-gray-300 dark:bg-slate-800 text-gray-700 dark:text-slate-200" disabled>
          ‚è≥ Tunggu 5 dtk...
        </button>
      </div>
      <div class="grid gap-3">
        <img src="https://via.placeholder.com/600x150?text=Hiltoads+Banner+1" class="w-full rounded-xl shadow" alt="Banner 1">
        <img src="https://via.placeholder.com/600x150?text=Hiltoads+Banner+2" class="w-full rounded-xl shadow" alt="Banner 2">
        <img src="https://via.placeholder.com/600x150?text=Hiltoads+Banner+3" class="w-full rounded-xl shadow" alt="Banner 3">
        <img src="https://via.placeholder.com/600x150?text=Hiltoads+Banner+4" class="w-full rounded-xl shadow" alt="Banner 4">
        <img src="https://via.placeholder.com/600x150?text=Hiltoads+Banner+5" class="w-full rounded-xl shadow" alt="Banner 5">
      </div>
      <p class="text-xs text-gray-500 dark:text-slate-400">Tombol kembali akan aktif setelah 5 detik. Setelah kembali, reward akan ditambahkan jika tidak sedang cooldown (3 menit) & limit harian belum habis.</p>
    </section>

    <!-- ===== RIWAYAT WD PAGE ===== -->
    <section id="riwayatSection" class="hidden space-y-3">
      <div class="flex items-center justify-between">
        <h3 class="text-xl font-bold">Riwayat Withdraw</h3>
        <button id="btnBackMain" class="px-3 py-2 rounded-lg bg-gray-300 dark:bg-slate-800 text-gray-700 dark:text-slate-200">‚¨ÖÔ∏è Kembali</button>
      </div>
      <ul id="riwayatWd" class="space-y-2 text-sm"></ul>
    </section>

  </main>

  <!-- Firebase & App Script -->
  <script type="module">
    // ===== Firebase (v10) =====
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import {
      getAuth, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import {
      getFirestore, doc, getDoc, setDoc, updateDoc, addDoc, collection, query, where, onSnapshot,
      serverTimestamp, Timestamp, increment, runTransaction
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    // --- Config dari kamu ---
    const firebaseConfig = {
      apiKey: "AIzaSyCrFmaHbmL299cum51EtJIjt5NpukpTmho",
      authDomain: "penyimpanansaldo-280df.firebaseapp.com",
      databaseURL: "https://penyimpanansaldo-280df-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "penyimpanansaldo-280df",
      storageBucket: "penyimpanansaldo-280df.firebasestorage.app",
      messagingSenderId: "659609775130",
      appId: "1:659609775130:web:bdd088ca5a877498c5b5a3",
      measurementId: "G-L4TW7E23H2"
    };
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db   = getFirestore(app);

    // ===== Telegram Notif =====
    // (silakan ganti kalau perlu)
    const TELEGRAM_BOT_TOKEN = "8236562243:AAFIyLCk2fu9-4GxxYSuIoSKw9DEiv1DVko";
    const TELEGRAM_CHAT_ID   = "8322802091";

    // ===== Helpers =====
    const $ = (id)=>document.getElementById(id);
    const show = (el)=>el.classList.remove("hidden");
    const hide = (el)=>el.classList.add("hidden");
    const toast = (msg)=>{
      const t=$("toast");
      t.textContent=msg;
      t.classList.add("show"); t.classList.remove("hide");
      setTimeout(()=>{ t.classList.remove("show"); t.classList.add("hide"); }, 2600);
    };
    const formatRp = n => "Rp " + (n||0).toLocaleString("id-ID");
    const nowJakarta = ()=> new Date(new Date().toLocaleString("en-US",{timeZone:"Asia/Jakarta"}));
    // dayKey reset 03:00 WIB: geser -3 jam -> YYYYMMDD
    const dayKeyOf = (date)=>{ const d=new Date(date.getTime()-3*3600*1000); return `${d.getFullYear()}${String(d.getMonth()+1).padStart(2,'0')}${String(d.getDate()).padStart(2,'0')}`; };

    // Theme
    const applyTheme = ()=>{
      const m=localStorage.getItem("theme")||"light";
      if(m==="dark") document.body.classList.add("dark"); else document.body.classList.remove("dark");
      $("themeToggle").checked = m==="dark";
      $("knob").style.left = m==="dark" ? "calc(100% - 1.25rem)" : "0.25rem";
    };
    const toggleTheme = ()=>{
      const isDark=document.body.classList.toggle("dark");
      localStorage.setItem("theme", isDark?"dark":"light");
      $("knob").style.left = isDark ? "calc(100% - 1.25rem)" : "0.25rem";
    };
    $("themeToggle")?.addEventListener("change", toggleTheme); applyTheme();

    // Tabs
    $("btnLoginTab").onclick = ()=>{ show($("loginForm")); hide($("registerForm")); $("btnLoginTab").className="flex-1 py-2 bg-blue-600 text-white font-medium"; $("btnRegisterTab").className="flex-1 py-2 bg-gray-200 dark:bg-slate-800"; };
    $("btnRegisterTab").onclick = ()=>{ hide($("loginForm")); show($("registerForm")); $("btnRegisterTab").className="flex-1 py-2 bg-blue-600 text-white font-medium"; $("btnLoginTab").className="flex-1 py-2 bg-gray-200 dark:bg-slate-800"; };

    // Auth actions (auto-login: pindah via onAuthStateChanged)
    $("btnLogin").onclick = async ()=>{
      try{ await signInWithEmailAndPassword(auth, $("loginEmail").value.trim(), $("loginPassword").value.trim()); toast("‚úÖ Login sukses"); }
      catch(e){ toast("‚ùå "+e.message); }
    };
    $("btnRegister").onclick = async ()=>{
      try{
        const email=$("registerEmail").value.trim(); const pass=$("registerPassword").value.trim();
        if(pass.length<6) return toast("‚ö†Ô∏è Password minimal 6 karakter");
        const cred = await createUserWithEmailAndPassword(auth, email, pass);
        await setDoc(doc(db,"users",cred.user.uid),{
          email, username:"", photo:"", saldo:0,
          // hitungan & cooldown
          genCount:0, xtraCount:0,
          lastGen1:null, lastGen2:null, lastGen3:null,
          lastXtra1:null, lastXtra2:null, lastXtra3:null,
          dayKey: dayKeyOf(nowJakarta())
        });
        toast("‚úÖ Registrasi sukses");
      }catch(e){ toast("‚ùå "+e.message); }
    };

    // Global
    let currentUser=null, userDocRef=null;

    // Countdowns store
    const COOLDOWN_MS = 3*60*1000;
    const REWARD = 30000;

    // Button maps
    const GEN_BUTTONS = ["gen1","gen2","gen3"];     // RichAds, Monetag, Adexium
    const XTRA_BUTTONS = ["xtra1","xtra2","xtra3"]; // Hiltoads page (5s hold)

    // bind clicks
    GEN_BUTTONS.forEach(id => $(id).onclick = ()=> handleGen(id));
    XTRA_BUTTONS.forEach(id => $(id).onclick = ()=> handleXtra(id));
    $("btnBackHiltoads").onclick = backFromHiltoads;
    $("btnWD").onclick = withdraw;
    $("btnRiwayat").onclick = ()=>{ hide($("mainSection")); show($("riwayatSection")); };
    $("btnBackMain").onclick = ()=>{ hide($("riwayatSection")); show($("mainSection")); };
    $("btnSaveUser").onclick = saveUsername;

    // Auth state
    onAuthStateChanged(auth, async (user)=>{
      if(user){
        currentUser=user;
        userDocRef = doc(db,"users",user.uid);
        hide($("authSection")); show($("mainSection")); hide($("hiltoadsSection")); hide($("riwayatSection"));
        await ensureUserDoc();
        bindUserSnapshot();
        bindRiwayatSnapshot();
      }else{
        currentUser=null; userDocRef=null;
        show($("authSection")); hide($("mainSection")); hide($("hiltoadsSection")); hide($("riwayatSection"));
      }
    });

    async function ensureUserDoc(){
      const s=await getDoc(userDocRef);
      if(!s.exists()){
        await setDoc(userDocRef,{
          email: currentUser.email||"", username:"", photo:"",
          saldo:0,
          genCount:0, xtraCount:0,
          lastGen1:null, lastGen2:null, lastGen3:null,
          lastXtra1:null, lastXtra2:null, lastXtra3:null,
          dayKey: dayKeyOf(nowJakarta())
        });
      }
    }

    function bindUserSnapshot(){
      onSnapshot(userDocRef, snap=>{
        const d = snap.data()||{};
        $("userName").textContent = d.username || currentUser.email.split("@")[0];
        if(d.photo) $("userPhoto").src = d.photo;
        animateSaldo(d.saldo||0);
        $("harianLabel").textContent = `Reset 03:00 WIB`;
        $("leftGen").textContent = Math.max(0, 20 - (d.genCount||0));
        $("leftXtra").textContent = Math.max(0, 20 - (d.xtraCount||0));

        // per-button cooldown display
        updateCooldownDisplay("gen1", d.lastGen1);
        updateCooldownDisplay("gen2", d.lastGen2);
        updateCooldownDisplay("gen3", d.lastGen3);
        updateCooldownDisplay("xtra1", d.lastXtra1);
        updateCooldownDisplay("xtra2", d.lastXtra2);
        updateCooldownDisplay("xtra3", d.lastXtra3);
      });
    }

    // Animasi saldo halus
    let saldoAnim = {val:0, raf:null};
    function animateSaldo(target){
      const start = saldoAnim.val; const end = target; const dur = 400;
      const t0 = performance.now();
      if(saldoAnim.raf) cancelAnimationFrame(saldoAnim.raf);
      const tick = (t)=>{
        const p = Math.min(1, (t - t0)/dur);
        const v = Math.round(start + (end-start)*p);
        $("saldoLabel").textContent = formatRp(v);
        if(p<1) saldoAnim.raf = requestAnimationFrame(tick);
        else saldoAnim.val = end;
      };
      saldoAnim.raf = requestAnimationFrame(tick);
    }

    // Username save
    async function saveUsername(){
      if(!currentUser) return;
      const u = $("tgUsername").value.trim();
      if(!u) return toast("‚ùå Isi username dulu");
      await updateDoc(userDocRef,{ username:u, photo:`https://unavatar.io/telegram/${u.replace("@","")}` });
      toast("‚úÖ Username disimpan");
    }

    // Cooldown helpers
    function updateCooldownDisplay(btnId, lastTs){
      const btn = $(btnId);
      const lab = $("cd-"+btnId);
      if(!btn || !lab) return;
      if(!lastTs){ btn.disabled=false; btn.classList.remove("btn-cool"); lab.textContent=""; return; }
      const last = lastTs instanceof Timestamp ? lastTs.toDate() : new Date(lastTs);
      const remain = COOLDOWN_MS - (Date.now()-last.getTime());
      if(remain<=0){ btn.disabled=false; btn.classList.remove("btn-cool"); lab.textContent=""; return; }
      btn.disabled=true; btn.classList.add("btn-cool");
      startButtonCountdown(btn, lab, remain);
    }

    function startButtonCountdown(btn, lab, ms){
      const endAt = Date.now()+ms;
      if(btn._cd) cancelAnimationFrame(btn._cd);
      const tick = ()=>{
        const left = endAt - Date.now();
        if(left<=0){ btn.disabled=false; btn.classList.remove("btn-cool"); lab.textContent=""; return; }
        const s = Math.ceil(left/1000);
        const mm = String(Math.floor(s/60)).padStart(2,"0");
        const ss = String(s%60).padStart(2,"0");
        lab.textContent = `Cooldown ${mm}:${ss}`;
        btn._cd = requestAnimationFrame(tick);
      };
      tick();
    }

    // Reset harian field jika ganti hari (03:00 WIB)
    function dailyResetFields(d){
      const today = dayKeyOf(nowJakarta());
      const ups = {};
      if(d.dayKey !== today){
        ups.dayKey = today;
        ups.genCount = 0;
        ups.xtraCount = 0;
      }
      return ups;
    }

    // ====== MENGHASILKAN ======
    async function handleGen(btnId){
      if(!currentUser) return;
      const lastField = {gen1:"lastGen1", gen2:"lastGen2", gen3:"lastGen3"}[btnId];

      try{
        const provider = {gen1:"richads", gen2:"monetag", gen3:"adexium"}[btnId];

        await runTransaction(db, async (trx)=>{
          const snap = await trx.get(userDocRef);
          if(!snap.exists()) throw new Error("User tidak ditemukan");
          const d = snap.data();

          // daily reset
          const ups = dailyResetFields(d);

          // limit harian gabungan
          const count = ups.genCount ?? (d.genCount||0);
          if(count >= 20) throw new Error("‚ö†Ô∏è Limit Menghasilkan 20/hari");

          // cooldown per tombol
          const last = d[lastField]?.toDate ? d[lastField].toDate() : (d[lastField]? new Date(d[lastField]) : null);
          const remain = last ? COOLDOWN_MS - (Date.now()-last.getTime()) : 0;
          if(remain>0) throw new Error("‚è≥ Masih cooldown");

          // tulis last tombol dulu (anti spam), reward setelah ad selesai dipicu di callback
          trx.update(userDocRef,{ ...ups, [lastField]: serverTimestamp(), genCount: count }); // count naik setelah reward
        });

        // Tampilkan iklan sesuai provider
        await showAdFor(provider);

        // setelah iklan selesai ‚Üí kasih reward (cek lagi limit & cooldown)
        await runTransaction(db, async (trx)=>{
          const snap = await trx.get(userDocRef);
          const d = snap.data();
          const ups = dailyResetFields(d);

          const count = ups.genCount ?? (d.genCount||0);
          if(count >= 20) throw new Error("‚ö†Ô∏è Limit Menghasilkan 20/hari");

          // cooldown per tombol (cek ulang)
          const last = d[lastField]?.toDate ? d[lastField].toDate() : (d[lastField]? new Date(d[lastField]) : null);
          const remain = last ? COOLDOWN_MS - (Date.now()-last.getTime()) : 0;
          if(remain>0) throw new Error("‚è≥ Masih cooldown");

          trx.update(userDocRef,{
            ...ups,
            genCount: count+1,
            saldo: (d.saldo||0) + REWARD
          });
        });

        toast("‚úÖ +Rp30.000 (Menghasilkan)");
      }catch(e){
        toast("‚ùå "+(e.message||e));
      }
    }

    // tampilkan iklan per provider (promise resolve jika sukses menonton)
    function showAdFor(provider){
      return new Promise((resolve, reject)=>{
        try{
          if(provider==="richads"){
            // RichAds umumnya interstitial otomatis; jika perlu trigger tambahan, panggil controller/placement di sini
            // Simulasikan selesai (karena beberapa integrasi auto-mode) ‚Äì ganti sesuai dokumentasi jika ada callback
            setTimeout(resolve, 2000);
          }else if(provider==="monetag"){
            if(typeof window.show_9779635!=="function") return reject("Monetag SDK belum siap");
            window.show_9779635().then(()=>resolve()).catch(reject);
          }else if(provider==="adexium"){
            try{
              const adexiumWidget = new AdexiumWidget({wid:'b78f386d-0a18-43d6-b658-27055787953f', adFormat:'interstitial'});
              adexiumWidget.autoMode();
              // Tidak semua punya callback; berikan grace-time
              setTimeout(resolve, 2500);
            }catch(err){ reject("Adexium error"); }
          }else{
            reject("Provider tidak dikenal");
          }
        }catch(err){ reject(err); }
      });
    }

    // ====== XSTRA BONUS (ke halaman Hiltoads 5s) ======
    let holdTimer=null;
    async function handleXtra(btnId){
      if(!currentUser) return;
      const lastField = {xtra1:"lastXtra1", xtra2:"lastXtra2", xtra3:"lastXtra3"}[btnId];
      try{
        await runTransaction(db, async (trx)=>{
          const snap = await trx.get(userDocRef);
          const d = snap.data();
          const ups = dailyResetFields(d);

          const count = ups.xtraCount ?? (d.xtraCount||0);
          if(count >= 20) throw new Error("‚ö†Ô∏è Limit Xstra 20/hari");

          const last = d[lastField]?.toDate ? d[lastField].toDate() : (d[lastField]? new Date(d[lastField]) : null);
          const remain = last ? COOLDOWN_MS - (Date.now()-last.getTime()) : 0;
          if(remain>0) throw new Error("‚è≥ Masih cooldown");

          trx.update(userDocRef,{ ...ups, [lastField]: serverTimestamp(), xtraCount: count });
        });

        // buka halaman Hiltoads + wajib hold 5 dtk
        hide($("mainSection")); show($("hiltoadsSection"));
        let left=5; const b=$("btnBackHiltoads"); b.disabled=true; b.textContent=`‚è≥ Tunggu ${left} dtk...`;
        if(holdTimer) clearInterval(holdTimer);
        holdTimer = setInterval(()=>{
          left--; if(left<=0){ clearInterval(holdTimer); b.disabled=false; b.textContent="‚¨ÖÔ∏è Kembali & Klaim"; }
          else b.textContent=`‚è≥ Tunggu ${left} dtk...`;
        },1000);

        // simpan tombol mana yang memicu
        $("btnBackHiltoads").dataset.source = btnId;

      }catch(e){ toast("‚ùå "+(e.message||e)); }
    }

    async function backFromHiltoads(){
      const srcBtn = $("btnBackHiltoads").dataset.source || "xtra1";
      const lastField = {xtra1:"lastXtra1", xtra2:"lastXtra2", xtra3:"lastXtra3"}[srcBtn];

      hide($("hiltoadsSection")); show($("mainSection"));
      try{
        await runTransaction(db, async (trx)=>{
          const snap=await trx.get(userDocRef);
          const d=snap.data();
          const ups = dailyResetFields(d);

          const count = ups.xtraCount ?? (d.xtraCount||0);
          if(count >= 20) throw new Error("‚ö†Ô∏è Limit Xstra 20/hari");

          const last = d[lastField]?.toDate ? d[lastField].toDate() : (d[lastField]? new Date(d[lastField]) : null);
          const remain = last ? COOLDOWN_MS - (Date.now()-last.getTime()) : 0;
          if(remain>0) throw new Error("‚è≥ Masih cooldown");

          trx.update(userDocRef,{
            ...ups,
            xtraCount: count+1,
            saldo:(d.saldo||0)+REWARD
          });
        });
        toast("‚úÖ +Rp30.000 (Xstra)");
      }catch(e){ toast("‚ùå "+(e.message||e)); }
    }

    // ===== Withdraw (transaction + Telegram) =====
    async function withdraw(){
      if(!currentUser) return;
      const amount = parseInt($("wdAmount").value||"0",10);
      const walletType = $("walletType").value;
      const walletNumber= $("walletNumber").value.trim();

      if(!walletNumber) return toast("‚ùå Masukkan nomor e-wallet");
      if(isNaN(amount)||amount<30000) return toast("‚ö†Ô∏è Minimal WD Rp30.000");

      let newId="";
      try{
        await runTransaction(db, async (trx)=>{
          const snap = await trx.get(userDocRef);
          if(!snap.exists()) throw new Error("User tidak ditemukan");
          const d = snap.data();
          if((d.saldo||0)<amount) throw new Error("Saldo tidak cukup");

          trx.update(userDocRef,{ saldo: (d.saldo||0)-amount });

          const ref = doc(collection(db,"withdrawals"));
          newId = ref.id;
          trx.set(ref,{
            uid: currentUser.uid,
            email: currentUser.email||"",
            username: d.username||"",
            amount, walletType, walletNumber,
            status:"pending", createdAt: serverTimestamp()
          });
        });

        // Notif Telegram
        const when = nowJakarta().toLocaleString("id-ID",{ timeZone:"Asia/Jakarta" });
        const text = [
          "üì§ Permintaan WD Baru!",
          `üë§ User: ${$("userName").textContent} (${currentUser.email||"-"})`,
          `üí∞ Jumlah: ${formatRp(amount)}`,
          `üèß E-Wallet (${walletType}): ${walletNumber}`,
          `üïí Waktu: ${when} WIB`,
          `üÜî Firestore ID: ${newId}`
        ].join("\n");
        fetch(`https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage`,{
          method:"POST",
          headers:{ "Content-Type":"application/x-www-form-urlencoded;charset=UTF-8" },
          body: new URLSearchParams({ chat_id: TELEGRAM_CHAT_ID, text })
        }).catch(e=>console.error("Telegram error:",e));

        toast("‚úÖ WD diajukan (pending).");
      }catch(e){ toast("‚ùå "+(e.message||e)); }
    }

    // ===== Riwayat WD realtime =====
    function bindRiwayatSnapshot(){
      const qy = query(collection(db,"withdrawals"), where("uid","==", currentUser.uid));
      onSnapshot(qy, (snaps)=>{
        const list = $("riwayatWd");
        list.innerHTML = "";
        const items=[];
        snaps.forEach(s=>{
          const d=s.data(); const t=d.createdAt?.toDate? d.createdAt.toDate().getTime():0;
          items.push({id:s.id, ...d, _t:t});
        });
        items.sort((a,b)=>b._t-a._t);
        for(const d of items){
          const timeStr = d._t? new Date(d._t).toLocaleString("id-ID",{timeZone:"Asia/Jakarta"})+" WIB":"-";
          const li = document.createElement("li");
          li.className="flex items-center justify-between p-3 rounded-xl bg-white dark:bg-slate-800 border dark:border-slate-700";
          li.innerHTML = `
            <div>
              <div class="font-semibold">${formatRp(d.amount)} ‚Ä¢ <span class="capitalize">${d.walletType}</span></div>
              <div class="text-xs text-gray-500 dark:text-slate-400">${timeStr}</div>
              <div class="text-xs text-gray-500 dark:text-slate-400">No: ${d.walletNumber}</div>
            </div>
            <span class="text-xs px-2 py-1 rounded-lg ${
              d.status==="pending" ? "bg-yellow-100 text-yellow-800" :
              d.status==="success" ? "bg-emerald-100 text-emerald-700" :
              "bg-red-100 text-red-700"
            }">${d.status}</span>
          `;
          list.appendChild(li);
        }
        if(items.length===0){
          const li = document.createElement("li");
          li.className="p-3 text-center text-xs text-gray-500 dark:text-slate-400 rounded-xl bg-white dark:bg-slate-800 border dark:border-slate-700";
          li.textContent = "Belum ada riwayat WD.";
          list.appendChild(li);
        }
      });
    }

    // periodic UI refresh for cooldown labels (in case tab idle)
    setInterval(async ()=>{
      if(!userDocRef) return;
      const s = await getDoc(userDocRef);
      const d = s.data()||{};
      updateCooldownDisplay("gen1", d.lastGen1);
      updateCooldownDisplay("gen2", d.lastGen2);
      updateCooldownDisplay("gen3", d.lastGen3);
      updateCooldownDisplay("xtra1", d.lastXtra1);
      updateCooldownDisplay("xtra2", d.lastXtra2);
      updateCooldownDisplay("xtra3", d.lastXtra3);
    }, 4000);

  </script>
</body>
</html>
