<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <title>NusaTask - Earning</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
  <style>
    body { background: linear-gradient(to right, #0f0f0f, #1a1a1a); }
    .fade-in { animation: fadeIn .3s ease-in-out; }
    .zoom-in { animation: zoomIn .3s ease-in-out; }
    @keyframes fadeIn { from {opacity:0} to {opacity:1} }
    @keyframes zoomIn { from {transform:scale(0.8)} to {transform:scale(1)} }
  </style>
</head>
<body class="min-h-screen flex items-center justify-center text-gray-200">

  <!-- üîπ Notifikasi -->
  <div id="notif" class="hidden fixed top-5 right-5 px-4 py-3 rounded-lg shadow-lg transition-all duration-500"></div>

  <!-- üîπ Modal Iklan Dummy -->
  <div id="adModal" class="hidden fixed inset-0 bg-black bg-opacity-70 backdrop-blur-md flex items-center justify-center z-50 fade-in">
    <div id="adContent" class="bg-gray-900 p-6 rounded-2xl shadow-2xl text-center w-80 zoom-in border border-purple-600">
      <h2 id="adTitle" class="text-xl font-bold mb-4 text-purple-400">Iklan Test</h2>
      <p id="adDesc" class="text-gray-300 mb-4">Simulasi iklan ...</p>
      <button onclick="closeAd()" class="px-4 py-2 bg-purple-600 hover:bg-purple-700 text-white rounded-lg">Tutup</button>
    </div>
  </div>

  <!-- üîπ Login Page -->
  <div id="loginPage" class="w-full max-w-sm bg-gray-900 border border-gray-700 p-6 rounded-2xl shadow-xl fade-in">
    <h1 class="text-2xl font-bold text-center text-purple-400 mb-6">NusaTask - Earning</h1>
    <input id="email" type="email" placeholder="Email" class="w-full bg-gray-800 border border-gray-700 rounded-lg px-3 py-2 mb-3 focus:outline-purple-500 text-gray-200" />
    <input id="password" type="password" placeholder="Password" class="w-full bg-gray-800 border border-gray-700 rounded-lg px-3 py-2 mb-4 focus:outline-purple-500 text-gray-200" />
    <button onclick="login()" class="w-full bg-purple-600 hover:bg-purple-700 text-white py-2 rounded-lg mb-2 transition">Login</button>
    <button onclick="register()" class="w-full bg-gray-700 hover:bg-gray-600 text-gray-200 py-2 rounded-lg transition">Daftar</button>
  </div>

  <!-- üîπ Dashboard -->
  <div id="dashboard" class="hidden w-full max-w-md bg-gray-900 border border-gray-800 p-6 rounded-2xl shadow-xl fade-in">
    <h1 class="text-xl font-bold text-purple-400 mb-4">NusaTask</h1>

    <!-- Saldo -->
    <div class="bg-gradient-to-r from-purple-700 to-purple-900 p-6 rounded-xl text-center text-white mb-6 shadow-lg border border-purple-500">
      <p class="text-sm text-purple-200">Saldo Anda</p>
      <p id="saldo" class="text-3xl font-bold">Rp0</p>
    </div>

    <!-- Tombol Menghasilkan -->
    <h2 class="font-semibold mb-3 text-gray-300">Tugas Harian</h2>
    <button id="earn1" onclick="earn('earn1', 200, 'Monetag Test')" class="w-full bg-gradient-to-r from-green-500 to-green-700 hover:opacity-90 text-white py-3 rounded-xl mb-3 transition">Menghasilkan 1 (Rp200)</button>
    <button id="earn2" onclick="earn('earn2', 200, 'Monetag Test')" class="w-full bg-gradient-to-r from-green-500 to-green-700 hover:opacity-90 text-white py-3 rounded-xl mb-3 transition">Menghasilkan 2 (Rp200)</button>

    <!-- Tombol Bonus -->
    <h2 class="font-semibold mt-6 mb-3 text-gray-300">Bonus</h2>
    <button id="bonus1" onclick="bonus('bonus1', 500)" class="w-full bg-gradient-to-r from-yellow-400 to-yellow-600 hover:opacity-90 text-black font-semibold py-3 rounded-xl mb-3 transition">Xstra Bonus 1 (Rp500)</button>
    <button id="bonus2" onclick="bonus('bonus2', 500)" class="w-full bg-gradient-to-r from-yellow-400 to-yellow-600 hover:opacity-90 text-black font-semibold py-3 rounded-xl mb-3 transition">Xstra Bonus 2 (Rp500)</button>

    <!-- Peringatan -->
    <p class="text-xs text-yellow-400 mt-4">
      ‚ö†Ô∏è Peringatan: 1 IP hanya boleh digunakan untuk 1 akun. Pelanggaran akan diblokir otomatis.
    </p>
    <p class="text-xs text-gray-500 mt-2">
      *Cooldown 2 menit, limit 20x per tombol, reset jam 03:00 WIB
    </p>
  </div>

  <script>
    // Firebase Config
    const firebaseConfig = {
      apiKey: "AIzaSyCrFmaHbmL299cum51EtJIjt5NpukpTmho",
      authDomain: "penyimpanansaldo-280df.firebaseapp.com",
      databaseURL: "https://penyimpanansaldo-280df-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "penyimpanansaldo-280df",
      storageBucket: "penyimpanansaldo-280df.firebasestorage.app",
      messagingSenderId: "659609775130",
      appId: "1:659609775130:web:bdd088ca5a877498c5b5a3",
      measurementId: "G-L4TW7E23H2"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.database();
    let currentUser = null;

    // üîπ Notifikasi
    function showNotif(message, type = "error") {
      const notif = document.getElementById("notif");
      notif.className = "fixed top-5 right-5 px-4 py-3 rounded-lg shadow-lg fade-in";
      notif.classList.add(type==="success"?"bg-green-500 text-white": type==="info"?"bg-blue-500 text-white":"bg-red-500 text-white");
      notif.innerHTML = message;
      notif.classList.remove("hidden");
      setTimeout(() => notif.classList.add("hidden"), 2500);
    }

    // üîπ Modal Dummy Ads
    function showAd(title, desc, duration=3000, callback=null) {
      const modal = document.getElementById("adModal");
      document.getElementById("adTitle").innerText = title;
      document.getElementById("adDesc").innerText = desc;
      modal.classList.remove("hidden");
      setTimeout(() => {
        closeAd();
        if(callback) callback();
      }, duration);
    }
    function closeAd() {
      document.getElementById("adModal").classList.add("hidden");
    }

    // üîπ Auto Login + Anti Blokir
    auth.onAuthStateChanged(user => {
      if(user){
        currentUser=user;
        db.ref("users/"+user.uid+"/status").get().then(snap=>{
          if(snap.val()==="blocked"){
            auth.signOut();
            showNotif("Akun anda diblokir karena pelanggaran IP!","error");
          } else {
            checkIP(user.uid);
            showDashboard();
            loadSaldo();
          }
        });
      } else showLogin();
    });
    function showLogin(){ loginPage.classList.remove("hidden"); dashboard.classList.add("hidden"); }
    function showDashboard(){ loginPage.classList.add("hidden"); dashboard.classList.remove("hidden"); }

    // üîπ Auth
    function login(){ auth.signInWithEmailAndPassword(email.value,password.value).then(()=>showNotif("Login sukses","success")).catch(e=>showNotif(e.message)); }
    function register(){
      auth.createUserWithEmailAndPassword(email.value,password.value).then(()=>{
        fetch("https://api.ipify.org?format=json").then(r=>r.json()).then(d=>{
          db.ref("users/"+auth.currentUser.uid).set({
            saldo:0,
            device:navigator.userAgent,
            ip:d.ip,
            status:"active",
            createdAt:Date.now()
          });
        });
        showNotif("Akun dibuat","success");
      }).catch(e=>showNotif(e.message));
    }

    // üîπ Cek IP unik (blokir otomatis)
    function checkIP(uid){
      fetch("https://api.ipify.org?format=json").then(r=>r.json()).then(d=>{
        const myIp=d.ip;
        db.ref("users").once("value",snap=>{
          let conflict=false;
          snap.forEach(child=>{
            if(child.key!==uid && child.val().ip===myIp){
              conflict=true;
            }
          });
          if(conflict){
            db.ref("users/"+uid+"/status").set("blocked"); // üö´ blokir
            auth.signOut();
            showNotif("Akun diblokir: 1 IP hanya boleh 1 akun!","error");
          }
        });
      });
    }

    // üîπ Saldo realtime + animasi count up
    let saldoNow=0;
    function animateSaldo(target){
      const step=(target-saldoNow)/30;
      let count=0;
      const timer=setInterval(()=>{
        saldoNow+=step; count++;
        saldo.textContent="Rp"+Math.floor(saldoNow).toLocaleString();
        if(count>=30){ clearInterval(timer); saldoNow=target; saldo.textContent="Rp"+saldoNow.toLocaleString(); }
      },30);
    }
    function loadSaldo(){ db.ref("users/"+currentUser.uid+"/saldo").on("value",snap=>{
      const newVal=snap.val()||0;
      animateSaldo(newVal);
    }); }

    // üîπ Cooldown
    function setCooldown(btnId,seconds){
      const btn=document.getElementById(btnId);
      btn.disabled=true; 
      btn.classList.remove("bg-gradient-to-r","from-green-500","to-green-700","from-yellow-400","to-yellow-600");
      btn.classList.add("bg-gray-600","cursor-not-allowed");
      const text=btn.innerText; let remain=seconds; btn.innerText=`Cooldown (${remain}s)`;
      const timer=setInterval(()=>{
        remain--; btn.innerText=`Cooldown (${remain}s)`;
        if(remain<=0){ clearInterval(timer); btn.disabled=false; btn.innerText=text;
          btn.classList.remove("bg-gray-600","cursor-not-allowed");
          if(btnId.startsWith("earn")) btn.classList.add("bg-gradient-to-r","from-green-500","to-green-700");
          else btn.classList.add("bg-gradient-to-r","from-yellow-400","to-yellow-600");
        }
      },1000);
    }

    // üîπ Reset jam 03:00
    function checkReset(task,callback){
      const now=new Date(); const reset=new Date(now.getFullYear(),now.getMonth(),now.getDate(),3,0,0);
      if(now<reset) reset.setDate(reset.getDate()-1);
      const key=reset.toISOString().split("T")[0];
      const ref=db.ref("daily/"+currentUser.uid+"/lastReset");
      ref.get().then(s=>{ if(s.val()!==key) db.ref("daily/"+currentUser.uid).set({lastReset:key}); callback(key); });
    }

    // üîπ Earn
    function earn(task,amount,adName){
      const now=Date.now();
      checkReset(task,key=>{
        const cd=db.ref("cooldowns/"+currentUser.uid+"/"+task);
        const daily=db.ref("daily/"+currentUser.uid+"/"+key+"/"+task);
        cd.get().then(s=>{
          if(now-(s.val()||0)<120000) return showNotif("Cooldown aktif!","error");
          daily.get().then(d=>{
            if((d.val()||0)>=20) return showNotif("Limit harian tercapai!","error");
            showAd("Iklan "+adName,"Simulasi tampil selama 3 detik",3000,()=>{
              db.ref("users/"+currentUser.uid+"/saldo").transaction(v=>(v||0)+amount);
              cd.set(now); daily.set((d.val()||0)+1);
              showNotif("Berhasil klaim Rp"+amount,"success"); setCooldown(task,120);
            });
          });
        });
      });
    }

    // üîπ Bonus
    function bonus(task,amount){
      const now=Date.now();
      checkReset(task,key=>{
        const cd=db.ref("cooldowns/"+currentUser.uid+"/"+task);
        const daily=db.ref("daily/"+currentUser.uid+"/"+key+"/"+task);
        cd.get().then(s=>{
          if(now-(s.val()||0)<120000) return showNotif("Cooldown aktif!","error");
          daily.get().then(d=>{
            if((d.val()||0)>=20) return showNotif("Limit harian tercapai!","error");
            showAd("KlikAdilla Inpage","Simulasi inpage 4 detik",4000,()=>{
              showAd("KlikAdilla Popunder","Simulasi popunder 2 detik",2000,()=>{
                db.ref("users/"+currentUser.uid+"/saldo").transaction(v=>(v||0)+amount);
                cd.set(now); daily.set((d.val()||0)+1);
                showNotif("Bonus berhasil Rp"+amount,"success"); setCooldown(task,120);
              });
            });
          });
        });
      });
    }
  </script>
</body>
</html>
