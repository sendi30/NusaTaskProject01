<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>NusaTask01</title>

<!-- Tailwind -->
<script src="https://cdn.tailwindcss.com"></script>

<!-- Firebase (Compat untuk kesederhanaan) -->
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>

<style>
  :root { color-scheme: light dark; }
  .fade-in { animation: fade .35s ease-out; }
  .pop { transform: scale(.98); transition:.12s; }
  .pop:active { transform: scale(.96); }
  @keyframes fade { from{opacity:0; transform:translateY(6px)} to{opacity:1; transform:none} }
</style>
</head>
<body class="bg-slate-900 text-white min-h-screen flex flex-col">

<!-- ======= HALAMAN UTAMA ======= -->
<section id="homePage" class="flex-1 p-4 space-y-4 fade-in">

  <!-- Header Profil -->
  <div class="flex items-center justify-between rounded-2xl bg-slate-800 p-4">
    <div class="flex items-center gap-3">
      <img id="userPhoto" class="w-12 h-12 rounded-full ring-2 ring-slate-700"
           src="https://i.pravatar.cc/120?img=11" alt="user">
      <div>
        <p id="userName" class="font-bold">@username</p>
        <p class="text-xs text-green-400">Aktif</p>
      </div>
    </div>
    <div class="text-right">
      <p class="text-[12px] text-gray-300">Saldo</p>
      <p id="saldoText" class="text-lg font-bold text-emerald-400">Rp0</p>
      <p id="harianText" class="text-[11px] text-gray-400">Sisa harian: 0 / 20 (reset 03:00)</p>
    </div>
  </div>

  <!-- BANNER ATAS (2x) -->
  <div class="grid grid-cols-2 gap-3">
    <img class="w-full rounded-xl shadow" src="https://via.placeholder.com/600x150?text=Hiltoads+Top+1" alt="">
    <img class="w-full rounded-xl shadow" src="https://via.placeholder.com/600x150?text=Hiltoads+Top+2" alt="">
  </div>

  <!-- TOMBOL TUGAS -->
  <button id="btnMonetag"
          class="w-full py-3 rounded-2xl bg-blue-600 font-semibold pop">
    üì∫ Menghasilkan (+Rp30.000)
    <span id="monoTimer" class="ml-2 text-xs opacity-80"></span>
  </button>

  <button id="btnHiltoads"
          class="w-full py-3 rounded-2xl bg-purple-600 font-semibold pop">
    üéØ Xstra Bonus (+Rp30.000)
    <span id="hiltTimer" class="ml-2 text-xs opacity-80"></span>
  </button>

  <!-- WITHDRAW -->
  <div class="rounded-2xl bg-slate-800 p-4 space-y-3">
    <h3 class="font-bold text-lg">Withdraw</h3>
    <div class="grid grid-cols-2 gap-3">
      <select id="walletType" class="p-3 rounded-lg text-black">
        <option>Dana</option><option>OVO</option><option>GoPay</option><option>ShopeePay</option>
      </select>
      <input id="walletNumber" type="tel" inputmode="numeric" placeholder="Nomor e-wallet"
             class="p-3 rounded-lg text-black">
    </div>
    <input id="wdAmount" type="number" min="30000" step="1000" value="30000"
           class="w-full p-3 rounded-lg text-black">
    <button id="btnWD"
            class="w-full py-3 rounded-xl bg-emerald-600 font-semibold pop">
      Ajukan WD (Min Rp30.000)
    </button>

    <!-- Tombol Riwayat (kecil) -->
    <button id="btnOpenRiwayat"
            class="w-full mt-2 py-2 rounded-xl bg-slate-700 text-sm flex items-center justify-center gap-2">
      üìú Lihat Riwayat WD
    </button>

    <!-- BANNER BAWAH (2x) -->
    <div class="grid grid-cols-2 gap-3 pt-2">
      <img class="w-full rounded-xl shadow" src="https://via.placeholder.com/600x150?text=Hiltoads+Bottom+1" alt="">
      <img class="w-full rounded-xl shadow" src="https://via.placeholder.com/600x150?text=Hiltoads+Bottom+2" alt="">
    </div>
  </div>

</section>

<!-- ======= HALAMAN RIWAYAT WD ======= -->
<section id="riwayatPage" class="hidden p-4 space-y-3 fade-in">
  <div class="flex items-center justify-between">
    <h3 class="text-xl font-bold">Riwayat Withdraw</h3>
    <button id="btnBackHome"
            class="px-3 py-2 rounded-lg bg-gray-200 text-gray-900 dark:bg-slate-800 dark:text-white pop">
      ‚¨Ö Kembali
    </button>
  </div>
  <div id="riwayatList" class="space-y-2 text-sm"></div>
  <p class="text-xs text-gray-400">Riwayat ter-update otomatis (realtime).</p>
</section>

<!-- ======= HALAMAN HILTOADS ======= -->
<section id="hiltoadsPage" class="hidden p-4 space-y-4 fade-in">
  <div class="flex items-center justify-between">
    <h3 class="text-xl font-bold">Iklan Hiltoads</h3>
    <button id="btnBackClaim"
            class="px-3 py-2 rounded-lg bg-gray-200 text-gray-900 dark:bg-slate-800 dark:text-white"
            disabled>‚è≥ Tunggu 5 dtk‚Ä¶</button>
  </div>

  <!-- 5 Banner -->
  <div class="grid grid-cols-1 gap-3">
    <img class="w-full rounded-xl shadow" src="https://via.placeholder.com/600x150?text=Hiltoads+1" alt="">
    <img class="w-full rounded-xl shadow" src="https://via.placeholder.com/600x150?text=Hiltoads+2" alt="">
    <img class="w-full rounded-xl shadow" src="https://via.placeholder.com/600x150?text=Hiltoads+3" alt="">
    <img class="w-full rounded-xl shadow" src="https://via.placeholder.com/600x150?text=Hiltoads+4" alt="">
    <img class="w-full rounded-xl shadow" src="https://via.placeholder.com/600x150?text=Hiltoads+5" alt="">
  </div>
  <p class="text-xs text-gray-400">Tahan minimal 5 dtk lalu ‚ÄúKembali & Claim‚Äù.</p>
</section>

<!-- ======= FOOTER ======= -->
<footer class="p-4 border-t border-slate-800 flex flex-wrap gap-3">
  <button id="btnTheme" class="flex-1 min-w-[120px] py-2 rounded-xl bg-gray-700 pop">üåó Tema</button>
  <a class="flex-1 min-w-[120px] py-2 text-center rounded-xl bg-blue-600"
     href="https://t.me/nusataskproject" target="_blank" rel="noopener">Help</a>
  <a class="flex-1 min-w-[120px] py-2 text-center rounded-xl bg-red-600"
     href="https://www.youtube.com/@NUSATASKPROJECTS" target="_blank" rel="noopener">YouTube</a>
  <a class="flex-1 min-w-[120px] py-2 text-center rounded-xl bg-pink-600"
     href="https://www.instagram.com/nusataskproject?igsh=MTh5Ync0bjhqeGxtdg==" target="_blank" rel="noopener">Instagram</a>
</footer>

<!-- ======= TOAST ======= -->
<div id="toast" class="fixed bottom-5 left-1/2 -translate-x-1/2 hidden bg-black/90 px-4 py-2 rounded-xl text-sm"></div>

<!-- ======= MODAL USERNAME (sekali saja) ======= -->
<div id="modalUser" class="fixed inset-0 bg-black/50 hidden items-center justify-center p-6">
  <div class="w-full max-w-sm bg-white text-gray-900 rounded-2xl p-5 space-y-3">
    <h3 class="font-bold text-lg">Lengkapi Profil</h3>
    <p class="text-sm">Masukkan <b>@username</b> Telegram kamu (tanpa spasi).</p>
    <input id="inpTg" class="w-full p-3 rounded-lg border" placeholder="@namakamu">
    <button id="btnSaveTg" class="w-full py-2 rounded-xl bg-emerald-600 text-white pop">Simpan</button>
  </div>
</div>

<script>
/* ========= CONFIG ========= */
const firebaseConfig = {
  // TODO: ganti dengan config Firebase-mu
  apiKey: "FIREBASE_API_KEY",
  authDomain: "FIREBASE_AUTH_DOMAIN",
  projectId: "FIREBASE_PROJECT_ID",
  storageBucket: "FIREBASE_STORAGE_BUCKET",
  messagingSenderId: "FIREBASE_SENDER_ID",
  appId: "FIREBASE_APP_ID"
};
const TELEGRAM_BOT_TOKEN = "TELEGRAM_BOT_TOKEN";
const TELEGRAM_CHAT_ID  = "TELEGRAM_CHAT_ID"; // id/channel yang menerima notif

firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db   = firebase.firestore();

const el = id => document.getElementById(id);
const toast = (m)=>{ const t=el('toast'); t.textContent=m; t.classList.remove('hidden'); setTimeout(()=>t.classList.add('hidden'),2600); };

let serverNow = () => new Date(); // fallback lokal

// Ambil waktu server: tulis field serverTimestamp lalu baca balik
async function getServerTime(uid){
  const ref = db.collection('users').doc(uid);
  await ref.set({ ping: firebase.firestore.FieldValue.serverTimestamp() }, { merge:true });
  const snap = await ref.get();
  const ts = snap.data()?.ping;
  return ts?.toDate?.() || new Date();
}

// Hitung dayKey WIB dan jam reset
function getDayKeyWIB(d){
  // WIB = UTC+7
  const utc = d.getTime() + (d.getTimezoneOffset()*60000); // ms UTC
  const wib = new Date(utc + 7*3600*1000);
  const year=wib.getUTCFullYear(), mon=String(wib.getUTCMonth()+1).padStart(2,'0'), day=String(wib.getUTCDate()).padStart(2,'0');
  // reset 03:00 WIB ‚Üí jika jam<3, mundurkan ke hari sebelumnya
  const hour=wib.getUTCHours();
  if(hour < 3){
    const prev = new Date(wib.getTime() - 24*3600*1000);
    return `${prev.getUTCFullYear()}-${String(prev.getUTCMonth()+1).padStart(2,'0')}-${String(prev.getUTCDate()).padStart(2,'0')}`;
  }
  return `${year}-${mon}-${day}`;
}

/* ========= AUTH (auto-anon) ========= */
auth.onAuthStateChanged(async (u)=>{
  if(!u){
    await auth.signInAnonymously();
    return;
  }
  // init dokumen user bila belum ada
  const uref = db.collection('users').doc(u.uid);
  await db.runTransaction(async (tx)=>{
    const snap = await tx.get(uref);
    if(!snap.exists){
      tx.set(uref,{
        uid:u.uid, saldo:0, monetagCount:0,
        monetagLast:null, hiltoadsLast:null,
        dayKey:null, email:null, tgUsername:null,
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
      });
    }
  });
  // sync UI
  listenUser(u.uid);
  // reset harian kalau beda dayKey server
  const now = await getServerTime(u.uid);
  serverNow = ()=>now;
  await ensureDayKey(u.uid, now);
  // tampilkan modal username jika belum ada
  const snap = await db.collection('users').doc(u.uid).get();
  if(!snap.data()?.tgUsername) el('modalUser').classList.remove('hidden');
});

/* ========= USER UI ========= */
function listenUser(uid){
  db.collection('users').doc(uid).onSnapshot(s=>{
    const d=s.data()||{};
    el('saldoText').textContent = 'Rp'+(d.saldo||0).toLocaleString('id-ID');
    el('userName').textContent  = d.tgUsername ? '@'+d.tgUsername : (d.email||'@username');
    const remain = Math.max(0, 20 - (d.monetagCount||0));
    el('harianText').textContent = `Sisa harian: ${remain} / 20 (reset 03:00)`;
  });
}

/* ========= DAYKEY RESET 03:00 WIB ========= */
async function ensureDayKey(uid, now){
  const uref = db.collection('users').doc(uid);
  const dk = getDayKeyWIB(now);
  await db.runTransaction(async (tx)=>{
    const snap = await tx.get(uref);
    const d = snap.data()||{};
    if(d.dayKey !== dk){
      tx.update(uref,{ dayKey: dk, monetagCount: 0 });
    }
  });
}

/* ========= COUNTDOWN UI ========= */
let monoCooldownUntil = 0, hiltCooldownUntil = 0, hiltHoldUnlock = 0;
function tick(){
  const now = Date.now();
  const mLeft = Math.max(0, monoCooldownUntil - now);
  el('monoTimer').textContent = mLeft>0 ? `(${Math.ceil(mLeft/1000)}s)` : '';
  el('btnMonetag').disabled = mLeft>0;

  const hLeft = Math.max(0, hiltCooldownUntil - now);
  el('hiltTimer').textContent = hLeft>0 ? `(${Math.ceil(hLeft/1000)}s)` : '';
  el('btnHiltoads').disabled = hLeft>0;
}
setInterval(tick, 500);

/* ========= MONETAG (Menghasilkan) ========= */
el('btnMonetag').addEventListener('click', async ()=>{
  const u = auth.currentUser; if(!u) return;
  const now = await getServerTime(u.uid); serverNow = ()=>now;
  await ensureDayKey(u.uid, now);

  const uref = db.collection('users').doc(u.uid);
  try{
    await db.runTransaction(async (tx)=>{
      const snap = await tx.get(uref);
      const d = snap.data();
      const last = d.monetagLast?.toDate?.() || new Date(0);
      const diff = now - last; // ms
      if(diff < 5000) throw new Error(`Tunggu ${Math.ceil((5000-diff)/1000)} dtk`);
      if((d.monetagCount||0) >= 20) throw new Error('Batas harian 20x sudah tercapai');

      const newSaldo = (d.saldo||0) + 30000;
      tx.update(uref,{
        saldo: newSaldo,
        monetagCount: (d.monetagCount||0)+1,
        monetagLast: firebase.firestore.FieldValue.serverTimestamp()
      });
    });
    monoCooldownUntil = Date.now()+5000;
    toast('Berhasil +Rp30.000 (Monetag)');
  }catch(e){ toast(e.message); }
});

/* ========= HILTOADS (Xstra Bonus) ========= */
el('btnHiltoads').addEventListener('click', async ()=>{
  const u=auth.currentUser; if(!u) return;
  const now = await getServerTime(u.uid); serverNow = ()=>now;

  const uref = db.collection('users').doc(u.uid);
  const can = await uref.get().then(s=>{
    const d=s.data(); const last=d.hiltoadsLast?.toDate?.()||new Date(0);
    return (now-last)>=10*60*1000; // 10 menit
  });
  if(!can){ toast('Tunggu cooldown 10 menit'); return; }

  // buka halaman hiltoads & start hold 5s
  showPage('hiltoadsPage');
  const backBtn = el('btnBackClaim');
  backBtn.disabled = true;
  let sec=5;
  backBtn.textContent = `‚è≥ Tunggu ${sec} dtk‚Ä¶`;
  const t = setInterval(()=>{
    sec--; backBtn.textContent = sec>0?`‚è≥ Tunggu ${sec} dtk‚Ä¶`:'‚¨Ö Back & Claim';
    if(sec<=0){ clearInterval(t); backBtn.disabled=false; }
  },1000);

  backBtn.onclick = async ()=>{
    showPage('homePage');
    // claim reward (set hold minimal 5s sudah dipaksa via button disabled)
    try{
      await db.runTransaction(async (tx)=>{
        const snap = await tx.get(uref);
        const d=snap.data();
        const newSaldo = (d.saldo||0)+30000;
        tx.update(uref,{
          saldo:newSaldo,
          hiltoadsLast: firebase.firestore.FieldValue.serverTimestamp()
        });
      });
      hiltCooldownUntil = Date.now() + 10*60*1000;
      toast('Berhasil +Rp30.000 (Hiltoads)');
    }catch(err){ toast('Gagal claim: '+err.message); }
  };
});

/* ========= WITHDRAW (Atomic + Telegram) ========= */
el('btnWD').addEventListener('click', async ()=>{
  const u=auth.currentUser; if(!u) return;
  const amount = parseInt(el('wdAmount').value||'0',10);
  if(amount<30000){ toast('Minimal WD Rp30.000'); return; }
  const walletType = el('walletType').value;
  const walletNumber = el('walletNumber').value.trim();
  if(!walletNumber){ toast('Nomor e-wallet wajib'); return; }

  const uref = db.collection('users').doc(u.uid);
  const wref = db.collection('withdrawals').doc(); // id baru

  try{
    await db.runTransaction(async (tx)=>{
      const us = await tx.get(uref);
      const d = us.data();
      if((d.saldo||0) < amount) throw new Error('Saldo tidak cukup');
      tx.update(uref,{ saldo: (d.saldo||0) - amount });
      tx.set(wref,{
        id: wref.id,
        uid: u.uid,
        tgUsername: d.tgUsername||null,
        email: d.email||null,
        walletType, walletNumber, amount,
        status:'pending',
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
      });
    });
    toast('WD diajukan. Menunggu diproses.');
    // Telegram notif (best-effort)
    try{
      const msg = encodeURIComponent(
        `WD Baru\nUser: @${(await db.collection('users').doc(u.uid).get()).data()?.tgUsername||'-'}\n`+
        `Wallet: ${walletType} ${walletNumber}\nNominal: Rp${amount.toLocaleString('id-ID')}\nDocID: ${wref.id}`
      );
      fetch(`https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage?chat_id=${TELEGRAM_CHAT_ID}&text=${msg}`);
    }catch{}
  }catch(e){ toast(e.message); }
});

/* ========= RIWAYAT WD (Realtime) ========= */
el('btnOpenRiwayat').addEventListener('click', ()=>{
  showPage('riwayatPage');
  const u=auth.currentUser; if(!u) return;
  const list = el('riwayatList');
  list.innerHTML = `<p class="text-gray-400">Memuat‚Ä¶</p>`;
  db.collection('withdrawals')
    .where('uid','==',u.uid)
    .orderBy('createdAt','desc')
    .onSnapshot(snap=>{
      list.innerHTML='';
      if(snap.empty){ list.innerHTML=`<p class="text-gray-400">Belum ada riwayat WD.</p>`; return; }
      snap.forEach(doc=>{
        const d=doc.data();
        const color = d.status==='success'?'text-emerald-400':d.status==='pending'?'text-yellow-400':'text-rose-400';
        const tgl = d.createdAt?.toDate?.().toLocaleString('id-ID') || '-';
        const item = `
          <div class="p-3 rounded-xl bg-slate-800 shadow">
            <div class="flex justify-between">
              <div>
                <div class="font-semibold">${d.walletType} ‚Ä¢ ${d.walletNumber}</div>
                <div>Rp${(d.amount||0).toLocaleString('id-ID')}</div>
              </div>
              <div class="font-bold capitalize ${color}">${d.status}</div>
            </div>
            <div class="text-[11px] text-gray-400 mt-1">${tgl}</div>
          </div>`;
        list.insertAdjacentHTML('beforeend', item);
      });
    });
});
el('btnBackHome').addEventListener('click', ()=>showPage('homePage'));

/* ========= TEMA ========= */
el('btnTheme').addEventListener('click', ()=>{
  document.documentElement.classList.toggle('dark');
  document.body.classList.toggle('bg-white');
  document.body.classList.toggle('text-gray-900');
});

/* ========= UTIL ======== */
function showPage(id){
  ['homePage','riwayatPage','hiltoadsPage'].forEach(x=>{
    el(x).classList.toggle('hidden', x!==id);
  });
}

/* ========= SIMPAN USERNAME TELEGRAM ========= */
el('btnSaveTg').addEventListener('click', async ()=>{
  const u=auth.currentUser; if(!u) return;
  let v = el('inpTg').value.trim();
  if(!v){ toast('Isi @username Telegram'); return; }
  v = v.replace(/^@+/,'');
  await db.collection('users').doc(u.uid).set({ tgUsername:v },{ merge:true });
  el('modalUser').classList.add('hidden');
  toast('Profil diperbarui.');
});

// Tutup modal jika user sudah punya username (safety)
el('modalUser').addEventListener('click', (e)=>{ if(e.target.id==='modalUser') e.currentTarget.classList.add('hidden'); });

</script>
</body>
</html>
