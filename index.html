<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <title>NusaTask - Earning</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
</head>
<body class="bg-gradient-to-r from-purple-50 to-purple-100 min-h-screen flex items-center justify-center">

  <!-- ðŸ”¹ Notifikasi -->
  <div id="notif" class="hidden fixed top-5 right-5 flex items-center gap-2 px-4 py-3 rounded-lg shadow-lg transition-opacity duration-500"></div>

  <!-- ðŸ”¹ Login Page -->
  <div id="loginPage" class="w-full max-w-sm bg-white p-6 rounded-2xl shadow-xl">
    <h1 class="text-2xl font-bold text-center text-purple-600 mb-6">NusaTask - Earning</h1>
    <input id="email" type="email" placeholder="Email" class="w-full border rounded-lg px-3 py-2 mb-3 focus:outline-purple-500" />
    <input id="password" type="password" placeholder="Password" class="w-full border rounded-lg px-3 py-2 mb-4 focus:outline-purple-500" />
    <button onclick="login()" class="w-full bg-purple-600 hover:bg-purple-700 text-white py-2 rounded-lg mb-2">Login</button>
    <button onclick="register()" class="w-full bg-gray-200 hover:bg-gray-300 text-gray-800 py-2 rounded-lg">Daftar</button>
  </div>

  <!-- ðŸ”¹ Dashboard Earning -->
  <div id="dashboard" class="hidden w-full max-w-md bg-white p-6 rounded-2xl shadow-xl">
    <div class="flex justify-between items-center mb-6">
      <h1 class="text-xl font-bold text-purple-600">Earning</h1>
    </div>

    <!-- Saldo -->
    <div class="bg-purple-600 p-6 rounded-xl text-center text-white mb-6 shadow">
      <p class="text-sm">Saldo Anda</p>
      <p id="saldo" class="text-3xl font-bold">Rp0</p>
    </div>

    <!-- Tombol Menghasilkan -->
    <h2 class="font-semibold mb-3">Tugas Harian</h2>
    <button id="earn1" onclick="earn('earn1', 200)" class="w-full bg-green-600 hover:bg-green-700 text-white py-2 rounded-lg mb-3">Menghasilkan 1 (Rp200)</button>
    <button id="earn2" onclick="earn('earn2', 200)" class="w-full bg-green-600 hover:bg-green-700 text-white py-2 rounded-lg mb-3">Menghasilkan 2 (Rp200)</button>

    <!-- Tombol Bonus -->
    <h2 class="font-semibold mt-6 mb-3">Bonus</h2>
    <button id="bonus1" onclick="bonus('bonus1', 500)" class="w-full bg-yellow-500 hover:bg-yellow-600 text-white py-2 rounded-lg mb-3">Xstra Bonus 1 (Rp500)</button>
    <button id="bonus2" onclick="bonus('bonus2', 500)" class="w-full bg-yellow-500 hover:bg-yellow-600 text-white py-2 rounded-lg mb-3">Xstra Bonus 2 (Rp500)</button>

    <p class="text-xs text-gray-500">*Cooldown 2 menit, limit 20x per tombol per hari (reset jam 03:00 WIB)</p>
  </div>

  <script>
    // ðŸ”¹ Firebase Config
    const firebaseConfig = {
      apiKey: "AIzaSyCrFmaHbmL299cum51EtJIjt5NpukpTmho",
      authDomain: "penyimpanansaldo-280df.firebaseapp.com",
      databaseURL: "https://penyimpanansaldo-280df-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "penyimpanansaldo-280df",
      storageBucket: "penyimpanansaldo-280df.firebasestorage.app",
      messagingSenderId: "659609775130",
      appId: "1:659609775130:web:bdd088ca5a877498c5b5a3",
      measurementId: "G-L4TW7E23H2"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.database();

    let currentUser = null;
    let currentSaldo = 0;

    // ðŸ”¹ Notifikasi
    function showNotif(message, type = "error") {
      const notif = document.getElementById("notif");
      notif.className = "fixed top-5 right-5 flex items-center gap-2 px-4 py-3 rounded-lg shadow-lg transition-opacity duration-500";
      if (type === "error") notif.classList.add("bg-red-500","text-white");
      if (type === "success") notif.classList.add("bg-green-500","text-white");
      if (type === "info") notif.classList.add("bg-blue-500","text-white");
      notif.innerHTML = message;
      notif.classList.remove("hidden");
      notif.style.opacity = "1";
      setTimeout(() => { notif.style.opacity = "0"; setTimeout(() => notif.classList.add("hidden"), 500); }, 3000);
    }

    // ðŸ”¹ Auto Login
    auth.onAuthStateChanged(user => {
      if (user) {
        currentUser = user;
        showDashboard();
        loadSaldo();
      } else {
        showLogin();
      }
    });

    function showLogin() {
      document.getElementById("loginPage").classList.remove("hidden");
      document.getElementById("dashboard").classList.add("hidden");
    }

    function showDashboard() {
      document.getElementById("loginPage").classList.add("hidden");
      document.getElementById("dashboard").classList.remove("hidden");
    }

    // ðŸ”¹ Auth
    function login() {
      const email = document.getElementById("email").value;
      const password = document.getElementById("password").value;
      auth.signInWithEmailAndPassword(email, password)
        .then(() => showNotif("Login berhasil!", "success"))
        .catch(err => showNotif(err.message, "error"));
    }

    function register() {
      const email = document.getElementById("email").value;
      const password = document.getElementById("password").value;
      auth.createUserWithEmailAndPassword(email, password)
        .then(() => {
          fetch("https://api.ipify.org?format=json")
            .then(res => res.json())
            .then(data => {
              db.ref("users/" + auth.currentUser.uid).set({
                saldo: 0,
                device: navigator.userAgent,
                ip: data.ip,
                createdAt: Date.now()
              });
            });
          showNotif("Akun berhasil dibuat!", "success");
        })
        .catch(err => showNotif(err.message, "error"));
    }

    // ðŸ”¹ Saldo realtime
    function loadSaldo() {
      db.ref("users/" + currentUser.uid + "/saldo").on("value", snap => {
        currentSaldo = snap.val() || 0;
        document.getElementById("saldo").textContent = "Rp" + currentSaldo.toLocaleString();
      });
    }

    // ðŸ”¹ Set Cooldown UI
    function setCooldown(btnId, seconds) {
      const btn = document.getElementById(btnId);
      btn.disabled = true;
      btn.classList.remove("bg-green-600","bg-yellow-500","hover:bg-green-700","hover:bg-yellow-600");
      btn.classList.add("bg-gray-400","cursor-not-allowed");

      let remaining = seconds;
      const originalText = btn.innerText;
      btn.innerText = `Cooldown (${remaining}s)`;

      const timer = setInterval(() => {
        remaining--;
        btn.innerText = `Cooldown (${remaining}s)`;
        if (remaining <= 0) {
          clearInterval(timer);
          btn.disabled = false;
          btn.innerText = originalText;
          btn.classList.remove("bg-gray-400","cursor-not-allowed");
          if (btnId.startsWith("earn")) btn.classList.add("bg-green-600","hover:bg-green-700");
          else btn.classList.add("bg-yellow-500","hover:bg-yellow-600");
        }
      }, 1000);
    }

    // ðŸ”¹ Check Reset Jam 03:00
    function checkReset(task, callback) {
      const today = new Date();
      const resetTime = new Date(today.getFullYear(), today.getMonth(), today.getDate(), 3, 0, 0); // jam 03:00
      if (today < resetTime) resetTime.setDate(resetTime.getDate() - 1); 
      const resetKey = resetTime.toISOString().split("T")[0]; // YYYY-MM-DD

      const resetRef = db.ref("daily/" + currentUser.uid + "/lastReset");
      resetRef.get().then(snap => {
        let lastReset = snap.val();
        if (lastReset !== resetKey) {
          db.ref("daily/" + currentUser.uid).set({ lastReset: resetKey });
        }
        callback(resetKey);
      });
    }

    // ðŸ”¹ Earn
    function earn(task, amount) {
      const now = Date.now();
      checkReset(task, resetKey => {
        const cdRef = db.ref("cooldowns/" + currentUser.uid + "/" + task);
        const dailyRef = db.ref("daily/" + currentUser.uid + "/" + resetKey + "/" + task);
        cdRef.get().then(snap => {
          let last = snap.val() || 0;
          if (now - last < 120 * 1000) {
            showNotif("Tunggu cooldown sebelum klaim lagi!", "error");
          } else {
            dailyRef.get().then(dSnap => {
              let total = dSnap.val() || 0;
              if (total >= 20) {
                showNotif("Limit harian untuk tombol ini sudah tercapai!", "error");
              } else {
                db.ref("users/" + currentUser.uid + "/saldo").transaction(saldo => (saldo || 0) + amount);
                cdRef.set(now);
                dailyRef.set(total + 1);
                showNotif("Berhasil klaim Rp" + amount, "success");
                setCooldown(task, 120);
                // TODO: pasang script iklan Monetag
              }
            });
          }
        });
      });
    }

    // ðŸ”¹ Bonus
    function bonus(task, amount) {
      const now = Date.now();
      checkReset(task, resetKey => {
        const cdRef = db.ref("cooldowns/" + currentUser.uid + "/" + task);
        const dailyRef = db.ref("daily/" + currentUser.uid + "/" + resetKey + "/" + task);
        cdRef.get().then(snap => {
          let last = snap.val() || 0;
          if (now - last < 120 * 1000) {
            showNotif("Tunggu cooldown sebelum klaim bonus!", "error");
          } else {
            dailyRef.get().then(dSnap => {
              let total = dSnap.val() || 0;
              if (total >= 20) {
                showNotif("Limit harian Bonus sudah tercapai!", "error");
              } else {
                showNotif("Iklan Inpage tampil... tunggu 4 detik", "info");
                setTimeout(() => {
                  db.ref("users/" + currentUser.uid + "/saldo").transaction(saldo => (saldo || 0) + amount);
                  cdRef.set(now);
                  dailyRef.set(total + 1);
                  showNotif("Bonus berhasil klaim Rp" + amount, "success");
                  setCooldown(task, 120);
                  // TODO: pasang script iklan KlikAdilla (Inpage + Popunder)
                }, 4000);
              }
            });
          }
        });
      });
    }
  </script>
</body>
</html>
