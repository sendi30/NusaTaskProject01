<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Penghasil Uang</title>
<style>
  :root{
    --bg:#f5f7fb;--card:#ffffff;--text:#101218;--muted:#6b7280;--pri:#2563eb;--danger:#ef4444;--ok:#16a34a;
  }
  body.dark{--bg:#0f1115;--card:#171a21;--text:#e5e7eb;--muted:#9ca3af;--pri:#3b82f6;--danger:#f87171;--ok:#22c55e;}
  *{box-sizing:border-box} body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,'Helvetica Neue',Arial;
    background:var(--bg);color:var(--text)}
  .wrap{max-width:460px;margin:0 auto;padding:16px}
  .card{background:var(--card);border-radius:14px;box-shadow:0 6px 18px rgba(0,0,0,.06);padding:16px;margin:12px 0}
  .row{display:flex;align-items:center;gap:12px}
  .between{display:flex;justify-content:space-between;align-items:center}
  .avatar{width:44px;height:44px;border-radius:50%;background:var(--pri);color:#fff;display:flex;align-items:center;justify-content:center;font-weight:700}
  .saldo{font-weight:700;font-size:18px}
  .muted{color:var(--muted);font-size:13px}
  .btn{width:100%;padding:12px 14px;border:0;border-radius:10px;font-weight:600;color:#fff;background:var(--pri);cursor:pointer}
  .btn.secondary{background:#334155}
  .btn.danger{background:var(--danger)}
  .btn.ok{background:var(--ok)}
  .btn:disabled{opacity:.55;cursor:not-allowed}
  input,select{width:100%;padding:12px 12px;border-radius:10px;border:1px solid #e5e7eb;background:transparent;color:inherit}
  body.dark input,body.dark select{border-color:#293044}
  .toast{position:fixed;left:50%;bottom:20px;transform:translateX(-50%);background:#111827;color:#fff;padding:10px 16px;border-radius:999px;font-size:14px;display:none}
  body.dark .toast{background:#374151}
  .grid2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  .tag{font-size:12px;padding:4px 8px;border-radius:999px;background:#e5e7eb;color:#111827}
  body.dark .tag{background:#293044;color:#d1d5db}
  /* modal */
  .modal{position:fixed;inset:0;background:rgba(0,0,0,.6);display:none;align-items:center;justify-content:center;padding:16px}
  .modal .box{width:100%;max-width:480px;background:var(--card);border-radius:14px;padding:16px}
  .banners{display:grid;grid-template-columns:1fr;gap:10px}
  .banner{height:80px;border-radius:10px;background:#e5e7eb;display:flex;align-items:center;justify-content:center;font-weight:700}
  body.dark .banner{background:#293044;color:#e5e7eb}
  .cd{font-size:13px;color:var(--muted);margin-top:4px}
</style>
</head>
<body>
<div class="wrap">

  <!-- AUTH -->
  <div id="auth" class="card">
    <h2>Login / Registrasi</h2>
    <input id="email" type="email" placeholder="Email" style="margin-top:6px;margin-bottom:8px">
    <input id="password" type="password" placeholder="Password">
    <div class="grid2" style="margin-top:10px">
      <button class="btn ok" id="btnLogin">Login</button>
      <button class="btn secondary" id="btnReg">Register</button>
    </div>
  </div>

  <!-- DASHBOARD -->
  <div id="app" class="card" style="display:none">
    <div class="between">
      <div class="row">
        <div class="avatar" id="avatar">U</div>
        <div>
          <div id="name">User</div>
          <div class="muted" id="emailShow">-</div>
        </div>
      </div>
      <div style="text-align:right">
        <div class="saldo" id="saldo">Rp0</div>
        <div class="muted" id="taskInfo">Tugas 0/20</div>
      </div>
    </div>

    <div class="card" style="margin-top:14px">
      <button class="btn" id="btnMonetag">üéÅ Klik Iklan Monetag (+Rp30.000)</button>
      <div class="cd" id="cdMonetag"></div>
      <button class="btn" id="btnHiltoads" style="margin-top:10px">üì∫ Iklan Hiltoads (+Rp30.000)</button>
      <div class="cd" id="cdHiltoads"></div>
      <div class="muted" style="margin-top:8px">Reset tugas harian: 03:00 WIB</div>
    </div>

    <div class="card">
      <h3 style="margin:0 0 10px">Withdraw</h3>
      <select id="ewallet">
        <option value="">Pilih E-Wallet</option>
        <option>Dana</option><option>OVO</option><option>Gopay</option>
      </select>
      <input id="ewalletNo" placeholder="Nomor HP E-Wallet" style="margin-top:8px">
      <button class="btn danger" id="btnWD" style="margin-top:10px">üí∏ Ajukan WD</button>
      <div class="muted" style="margin-top:6px">Minimal WD Rp30.000. WD akan tercatat sebagai <span class="tag">pending</span>.</div>
    </div>

    <div class="grid2">
      <button class="btn secondary" id="btnHelp">üì© Help (Telegram)</button>
      <button class="btn secondary" id="btnTheme">üåó Tema</button>
    </div>
    <button class="btn secondary" id="btnLogout" style="margin-top:8px">üö™ Logout</button>
  </div>

  <!-- RIWAYAT WD -->
  <div id="wdCard" class="card" style="display:none">
    <h3 style="margin:0 0 8px">Riwayat WD</h3>
    <div id="wdList" class="muted">Belum ada riwayat.</div>
  </div>
</div>

<div id="toast" class="toast"></div>

<!-- Modal Hiltoads -->
<div id="modal" class="modal" aria-hidden="true">
  <div class="box">
    <h3 style="margin:0 0 8px">Tonton Iklan Hiltoads</h3>
    <div class="banners">
      <div class="banner">Banner 1</div>
      <div class="banner">Banner 2</div>
      <div class="banner">Banner 3</div>
      <div class="banner">Banner 4</div>
      <div class="banner">Banner 5</div>
    </div>
    <div class="cd" id="cdModal" style="margin-top:10px"></div>
    <button class="btn ok" id="btnCloseModal" disabled style="margin-top:12px">Tutup</button>
  </div>
</div>

<!-- Firebase (Compat v9) -->
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
<script>
const firebaseConfig = {
  apiKey: "AIzaSyCrFmaHbmL299cum51EtJIjt5NpukpTmho",
  authDomain: "penyimpanansaldo-280df.firebaseapp.com",
  projectId: "penyimpanansaldo-280df",
  storageBucket: "penyimpanansaldo-280df.appspot.com",
  messagingSenderId: "659609775130",
  appId: "1:659609775130:web:bdd088ca5a877498c5b5a3",
  measurementId: "G-L4TW7E23H2"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

/* ---------- Helpers ---------- */
const TELEGRAM_USERNAME = "usernamekamu"; // ganti dengan username kamu
const REWARD = 30000;
const CD_MONETAG = 5000;      // 5 detik
const CD_HILTOADS = 600000;   // 10 menit
const MAX_DAILY = 20;         // per cycle 03:00 WIB

const $ = (id)=>document.getElementById(id);
const toast = (m)=>{ const t=$("toast"); t.innerText=m; t.style.display="block"; setTimeout(()=>t.style.display="none",2600); };
const toRupiah = n => "Rp" + (n||0).toLocaleString("id-ID");

/* Server time skew (anti manipulasi jam lokal) */
let serverSkew = 0; // serverNow - Date.now()
async function getServerNow(){
  const ref = db.collection("serverTime").doc("now");
  await ref.set({ now: firebase.firestore.FieldValue.serverTimestamp() }, { merge:true });
  const snap = await ref.get();
  const sv = snap.data()?.now?.toMillis?.() || Date.now();
  serverSkew = sv - Date.now();
  return sv;
}
function nowMs(){ return Date.now() + serverSkew; }

/* Cycle key 03:00 WIB */
function cycleKey(ms){
  const jkt = new Date(ms + 7*3600000); // UTC+7
  // jika sebelum 03:00 lokal, pakai hari sebelumnya
  let y=jkt.getUTCFullYear(), m=jkt.getUTCMonth(), d=jkt.getUTCDate();
  if (jkt.getUTCHours() < 3){
    const prev = new Date(Date.UTC(y,m,d) - 24*3600000);
    y=prev.getUTCFullYear(); m=prev.getUTCMonth(); d=prev.getUTCDate();
  }
  return `${y}-${String(m+1).padStart(2,"0")}-${String(d).padStart(2,"0")}`;
}

/* ---------- UI refs ---------- */
const views = {
  auth: $("auth"),
  app: $("app"),
  wdCard: $("wdCard"),
  saldo: $("saldo"),
  name: $("name"),
  emailShow: $("emailShow"),
  avatar: $("avatar"),
  taskInfo: $("taskInfo"),
  btnMonetag: $("btnMonetag"),
  cdMonetag: $("cdMonetag"),
  btnHiltoads: $("btnHiltoads"),
  cdHiltoads: $("cdHiltoads"),
  btnWD: $("btnWD"),
  ewallet: $("ewallet"),
  ewalletNo: $("ewalletNo"),
  wdList: $("wdList"),
  btnTheme: $("btnTheme"),
  btnHelp: $("btnHelp"),
  btnLogout: $("btnLogout"),
  modal: $("modal"),
  btnCloseModal: $("btnCloseModal"),
  cdModal: $("cdModal"),
};

/* ---------- Auth ---------- */
$("btnLogin").onclick = ()=> {
  const email = $("email").value.trim();
  const pass = $("password").value.trim();
  if(!email || !pass) return toast("Isi email & password");
  auth.signInWithEmailAndPassword(email,pass).catch(e=>toast(e.message));
};
$("btnReg").onclick = ()=> {
  const email = $("email").value.trim();
  const pass = $("password").value.trim();
  if(!email || !pass) return toast("Isi email & password");
  auth.createUserWithEmailAndPassword(email,pass)
  .then(async cred=>{
    const uid = cred.user.uid;
    await db.collection("users").doc(uid).set({
      email, saldo:0,
      monetag:{ last:0, count:0, key: cycleKey(await getServerNow()) },
      hiltoads:{ last:0 },
      createdAt: firebase.firestore.FieldValue.serverTimestamp()
    });
  }).catch(e=>toast(e.message));
};

views.btnLogout.onclick = ()=> auth.signOut();

auth.onAuthStateChanged(async (user)=>{
  if(user){
    // get server time & skew
    await getServerNow();
    // ensure doc exists
    const uref = db.collection("users").doc(user.uid);
    const snap = await uref.get();
    if(!snap.exists){
      await uref.set({
        email: user.email || "-",
        saldo: 0,
        monetag:{ last:0, count:0, key: cycleKey(nowMs()) },
        hiltoads:{ last:0 },
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
      });
    }
    // bind UI
    views.auth.style.display="none";
    views.app.style.display="block";
    views.wdCard.style.display="block";
    views.name.textContent = user.email?.split("@")[0] || "User";
    views.emailShow.textContent = user.email || "-";
    views.avatar.textContent = (user.email||"U").charAt(0).toUpperCase();

    // realtime saldo & task
    uref.onSnapshot(d=>{
      const data = d.data() || {};
      views.saldo.textContent = toRupiah(data.saldo||0);
      const m = data.monetag || {count:0,key:cycleKey(nowMs())};
      views.taskInfo.textContent = `Tugas ${Math.min(m.count||0,MAX_DAILY)}/${MAX_DAILY}`;
      // update button disabled states every tick
    });

    // Refresh skew tiap 30 detik
    setInterval(getServerNow, 30000);
    // UI timers tiap 0.5 detik
    setInterval(updateCooldownUI, 500);

    // WD list
    listenWD(user.uid);
  }else{
    views.auth.style.display="block";
    views.app.style.display="none";
    views.wdCard.style.display="none";
  }
});

/* ---------- Cooldown UI updater ---------- */
async function updateCooldownUI(){
  const user = auth.currentUser;
  if(!user) return;
  const docu = await db.collection("users").doc(user.uid).get();
  const data = docu.data() || {};
  const now = nowMs();

  // Monetag
  let m = data.monetag || {last:0,count:0,key:cycleKey(now)};
  const curKey = cycleKey(now);
  if (m.key !== curKey){ m.count = 0; m.key = curKey; await db.collection("users").doc(user.uid).update({ "monetag.key":curKey, "monetag.count":0 }); }
  const remainM = Math.max(0,(m.last||0)+CD_MONETAG - now);
  const leftM = formatRemain(remainM);
  views.cdMonetag.textContent = remainM>0 ? `Cooldown: ${leftM}` : `Sisa tugas hari ini: ${Math.max(0, MAX_DAILY-(m.count||0))}`;
  views.btnMonetag.disabled = remainM>0 || (m.count||0) >= MAX_DAILY;

  // Hiltoads
  const h = data.hiltoads || {last:0};
  const remainH = Math.max(0,(h.last||0)+CD_HILTOADS - now);
  const leftH = formatRemain(remainH);
  views.cdHiltoads.textContent = remainH>0 ? `Cooldown: ${leftH}` : `Siap ditonton`;
  views.btnHiltoads.disabled = remainH>0;
}
function formatRemain(ms){
  const s = Math.ceil(ms/1000);
  const m = Math.floor(s/60), sec = s%60;
  const h = Math.floor(m/60), min = m%60;
  if (h>0) return `${h}j ${min}m ${sec}d`;
  if (m>0) return `${m}m ${sec}d`;
  return `${sec}d`;
}

/* ---------- Actions ---------- */
// Monetag claim (server-validated by timestamps in Firestore)
views.btnMonetag.onclick = async ()=>{
  const user = auth.currentUser; if(!user) return;
  const ref = db.collection("users").doc(user.uid);
  const svNow = await getServerNow();
  const snap = await ref.get();
  const data = snap.data() || {};
  let m = data.monetag || {last:0,count:0,key:cycleKey(svNow)};

  const curKey = cycleKey(svNow);
  if (m.key !== curKey) { m.count=0; m.key=curKey; }

  if ((m.count||0) >= MAX_DAILY) return toast("Limit 20x per hari. Coba lagi setelah 03:00 WIB.");
  if (m.last && (svNow - m.last) < CD_MONETAG) return toast("Tunggu 5 detik untuk klaim berikutnya.");

  await ref.update({
    saldo: firebase.firestore.FieldValue.increment(REWARD),
    "monetag.last": svNow,
    "monetag.count": (m.count||0) + 1,
    "monetag.key": m.key
  });
  toast("Berhasil +Rp30.000 dari Monetag!");
};

// Hiltoads flow: modal 5 detik, lalu reward jika lolos cooldown server
views.btnHiltoads.onclick = async ()=>{
  const user = auth.currentUser; if(!user) return;
  const ref = db.collection("users").doc(user.uid);
  const svNow = await getServerNow();
  const snap = await ref.get();
  const data = snap.data() || {};
  const last = data.hiltoads?.last || 0;
  if (last && (svNow - last) < CD_HILTOADS) return toast("Tunggu 10 menit sebelum menonton lagi.");

  // buka modal
  views.modal.style.display = "flex";
  views.btnCloseModal.disabled = true;
  let left = 5;
  views.cdModal.textContent = `Tunggu ${left} detik...`;
  const t = setInterval(()=> {
    left--;
    views.cdModal.textContent = left>0 ? `Tunggu ${left} detik...` : `Selesai, ambil reward.`;
    if(left<=0){ clearInterval(t); views.btnCloseModal.disabled = false; }
  },1000);

  // saat ditutup ‚Üí verifikasi lagi dengan server time & kasih reward
  const onClose = async ()=>{
    views.btnCloseModal.removeEventListener("click", onClose);
    views.modal.style.display = "none";
    const svNow2 = await getServerNow();
    const snap2 = await ref.get();
    const last2 = snap2.data()?.hiltoads?.last || 0;
    if (last2 && (svNow2 - last2) < CD_HILTOADS) return toast("Cooldown aktif, coba nanti.");
    await ref.update({
      saldo: firebase.firestore.FieldValue.increment(REWARD),
      "hiltoads.last": svNow2
    });
    toast("Berhasil +Rp30.000 dari Hiltoads!");
  };
  views.btnCloseModal.addEventListener("click", onClose);
};

/* WD: kirim ke root collection 'withdrawals' status pending */
views.btnWD.onclick = async ()=>{
  const user = auth.currentUser; if(!user) return;
  const ref = db.collection("users").doc(user.uid);
  const snap = await ref.get();
  const data = snap.data() || {};
  const saldo = data.saldo || 0;
  const ew = views.ewallet.value.trim();
  const no = views.ewalletNo.value.trim();

  if (!ew) return toast("Pilih e-wallet dulu.");
  if (!no) return toast("Isi nomor e-wallet.");
  if (saldo < 30000) return toast("Minimal WD Rp30.000.");
  // WD seluruh saldo agar simpel (bisa ubah ke input jumlah jika perlu)
  const jumlah = saldo;

  // kurangi saldo dulu (atomic enough untuk kasus ini)
  await ref.update({ saldo: Math.max(0, saldo - jumlah) });
  await db.collection("withdrawals").add({
    uid: user.uid,
    email: user.email || "-",
    ewallet: ew,
    number: no,
    amount: jumlah,
    status: "pending",
    createdAt: firebase.firestore.FieldValue.serverTimestamp()
  });
  toast("WD diajukan. Status: pending");
};

/* WD history realtime */
function listenWD(uid){
  db.collection("withdrawals").where("uid","==",uid)
    .orderBy("createdAt","desc")
    .onSnapshot(s=>{
      if(s.empty){ views.wdList.innerHTML = "Belum ada riwayat."; return; }
      let html="";
      s.forEach(d=>{
        const w=d.data();
        const when = w.createdAt?.toDate?.() ? w.createdAt.toDate().toLocaleString("id-ID") : "-";
        const badge = w.status==="approved"?"ok":(w.status==="rejected"?"danger":"secondary");
        html += `
          <div class="card" style="margin:8px 0">
            <div class="between"><div><b>${toRupiah(w.amount)}</b> ‚Üí ${w.ewallet} (${w.number})</div>
            <span class="tag" style="background:${badge==='ok'?'#dcfce7':badge==='danger'?'#fee2e2':'#e5e7eb'};color:#111827;">
              ${w.status}
            </span></div>
            <div class="muted" style="margin-top:4px">${when}</div>
          </div>`;
      });
      views.wdList.innerHTML = html;
    });
}

/* Buttons */
views.btnTheme.onclick = ()=> document.body.classList.toggle("dark");
views.btnHelp.onclick = ()=> window.open(`https://t.me/${TELEGRAM_USERNAME}`,"_blank");
</script>
</body>
</html>
