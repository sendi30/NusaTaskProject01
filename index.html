<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Penghasil Uang — Final All-in-One</title>

<!-- Minimal styling + Inter font -->
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
<style>
:root{--bg:#0b1220;--card:#0f1724;--muted:#9ca3af;--text:#e6eef8;--primary:#2563eb;--accent:#10b981;--danger:#ef4444}
[data-theme="light"]{--bg:#f8fafc;--card:#fff;--muted:#475569;--text:#0b1220;--primary:#1d4ed8;--accent:#059669;--danger:#dc2626}
*{box-sizing:border-box} body{margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;background:var(--bg);color:var(--text);-webkit-font-smoothing:antialiased}
.container{max-width:720px;margin:0 auto;padding:14px}
header{display:flex;justify-content:space-between;align-items:center;gap:12px}
.profile{display:flex;gap:10px;align-items:center}
.avatar{width:46px;height:46px;border-radius:999px;background:#334155;display:grid;place-items:center;font-weight:800;color:#fff}
.name b{font-size:15px}
.name span{font-size:11px;color:var(--muted)}
.balance{display:flex;flex-direction:column;align-items:flex-end}
.balance label{font-size:10px;color:var(--muted);text-transform:uppercase}
.balance .money{font-size:15px;font-weight:800;color:var(--accent)} /* sedikit dikecilkan */
.card{background:var(--card);border-radius:14px;padding:12px;margin-top:12px;border:1px solid rgba(255,255,255,.03);box-shadow:0 6px 24px rgba(2,6,23,.5);transition:transform .18s}
.card:active{transform:translateY(2px)}
.row{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:12px}
.btn{position:relative;border:0;border-radius:12px;padding:12px;background:linear-gradient(180deg,var(--primary),#1e40af);color:#fff;font-weight:800;display:flex;flex-direction:column;align-items:center;gap:6px;cursor:pointer;box-shadow:0 12px 36px rgba(2,6,23,.55);transition:transform .12s,opacity .12s}
.btn.secondary{background:linear-gradient(180deg,#6b7280,#374151)}
.btn.altgray{background:linear-gradient(180deg,#6b7280,#4b5563)}
.btn:hover{transform:translateY(-4px)}
.btn.cooldown{opacity:.85;cursor:not-allowed;filter:grayscale(.06)}
.btn .title{font-size:15px}
.btn .sub{font-size:12px;color:rgba(255,255,255,.9);opacity:.95}
.btn .small{font-size:11px;color:rgba(255,255,255,.9);opacity:.8}
.btn .cd{position:absolute;right:8px;bottom:8px;background:rgba(0,0,0,.25);padding:6px 8px;border-radius:999px;font-weight:800;font-size:12px}
.hint{font-size:12px;color:var(--muted);margin-top:8px}
input,select{width:100%;padding:10px;border-radius:10px;border:1px solid rgba(255,255,255,.05);background:transparent;color:var(--text)}
.sheet{position:fixed;left:0;right:0;bottom:0;transform:translateY(110%);transition:transform .28s;background:var(--card);border-top-left-radius:16px;border-top-right-radius:16px;padding:12px;z-index:80;max-height:86vh;overflow:auto}
.sheet.open{transform:translateY(0)}
.overlay{position:fixed;inset:0;background:rgba(0,0,0,.6);display:none;align-items:center;justify-content:center;z-index:120}
.overlay.open{display:flex}
.modal{background:var(--card);padding:16px;border-radius:12px;max-width:520px;width:92%;border:1px solid rgba(255,255,255,.04)}
.small{font-size:12px;color:var(--muted)}
.float-ad{position:fixed;left:12px;top:12px;z-index:95;background:var(--card);border-radius:12px;padding:8px;box-shadow:0 18px 40px rgba(2,6,23,.6);transform:translateY(-140%);opacity:0;transition:transform .25s,opacity .25s}
.float-ad.show{transform:translateY(0);opacity:1}
.float-ad header{display:flex;justify-content:space-between;align-items:center;gap:8px}
.float-ad .close{padding:6px;border-radius:10px;background:transparent;border:1px solid rgba(255,255,255,.04);font-weight:700;cursor:pointer}
.socials{display:flex;gap:10px;margin-top:6px;flex-wrap:wrap}
.socials a{display:inline-block;padding:8px 10px;border-radius:10px;border:1px solid rgba(255,255,255,.03);text-decoration:none;color:var(--text);font-weight:700}
.toast{position:fixed;left:50%;transform:translateX(-50%);bottom:18px;z-index:140;background:#0b1220;padding:10px;border-radius:12px;border:1px solid rgba(37,99,235,.15);color:#dbeafe}
.pill{padding:4px 8px;border-radius:999px;font-weight:800;font-size:12px}
.pill.pending{background:#fef3c7;color:#92400e}
.pill.success{background:#dcfce7;color:#166534}
.pill.failed{background:#fee2e2;color:#991b1b}
.row-buttons{display:grid;grid-template-columns:repeat(2,1fr);gap:10px}
footer{margin-top:14px;text-align:center;color:var(--muted);font-size:12px}
/* progress bar inside button */
.progress{position:absolute;left:0;bottom:0;height:4px;background:rgba(255,255,255,.08);border-bottom-left-radius:12px;border-bottom-right-radius:12px;transition:width .25s}
@media(min-width:720px){ .container{padding:24px} .row{gap:14px} }
</style>

<!-- Firebase compat -->
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>

<!-- Monetag SDK (tombol Menghasilkan) -->
<script src='//libtl.com/sdk.js' data-zone='9779635' data-sdk='show_9779635'></script>

</head>
<body data-theme="dark">
<div class="container">

  <!-- ENTRY WARNING -->
  <div class="overlay open" id="entryOverlay">
    <div class="modal">
      <h3 style="margin:0 0 8px 0">⚠️ Peringatan Sebelum Masuk</h3>
      <div class="small">Satu IP hanya boleh digunakan untuk satu akun. Jika terdeteksi banyak akun dari 1 IP yang sama, sistem dapat memblokir akun tersebut. Lanjutkan hanya jika kamu setuju.</div>
      <div style="margin-top:12px;display:flex;justify-content:flex-end;gap:8px">
        <button id="btnExit" class="btn secondary" style="padding:8px 12px;background:transparent;border:1px solid rgba(255,255,255,.06)">Keluar</button>
        <button id="btnAgree" class="btn" style="padding:8px 12px">Setuju & Masuk</button>
      </div>
      <div class="small" style="margin-top:8px;color:var(--muted)">IP publik: <span id="userIp">-</span></div>
    </div>
  </div>

  <!-- HEADER -->
  <header>
    <div class="profile">
      <div class="avatar" id="avatar">U</div>
      <div class="name">
        <b id="username">@user</b>
        <span id="uidline">Auto-login aktif</span>
      </div>
    </div>
    <div class="balance">
      <label>SALDO</label>
      <div class="money" id="saldo">Rp 0</div>
    </div>
  </header>

  <!-- Sosial -->
  <div class="card" style="display:flex;justify-content:space-between;align-items:center">
    <div>
      <div style="font-weight:800">Sosial</div>
      <div class="small">Follow kami</div>
    </div>
    <div class="socials">
      <a href="https://www.youtube.com/@NUSATASKPROJECTS" target="_blank">YouTube</a>
      <a href="https://www.instagram.com/nusataskproject?igsh=MTh5Ync0bjhqeGxtdg==" target="_blank">Instagram</a>
    </div>
  </div>

  <!-- Buttons Grid -->
  <div class="card" style="margin-top:12px">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <div style="font-weight:800">Tugas & Bonus</div>
      <div class="small">Reset per hari 03:00 WIB</div>
    </div>

    <!-- Row 1 -->
    <div class="row" style="margin-top:12px">
      <button class="btn" id="btn_earn_1" data-key="earn_1">
        <div class="title">Menghasilkan</div>
        <div class="sub">Monetag — Reward Rp30.000</div>
        <div class="small" id="count_earn_1">0/20</div>
        <div class="cd" style="display:none"></div>
        <div class="progress" style="width:0%"></div>
      </button>

      <button class="btn altgray" id="btn_xstra_1" data-key="xstra_1">
        <div class="title">Xstra Bonus</div>
        <div class="sub">KlikAdila — Reward Rp20.000</div>
        <div class="small" id="count_xstra_1">0/20</div>
        <div class="cd" style="display:none"></div>
        <div class="progress" style="width:0%"></div>
      </button>
    </div>

    <!-- Row 2 -->
    <div class="row" style="margin-top:10px">
      <button class="btn" id="btn_earn_2" data-key="earn_2">
        <div class="title">Menghasilkan</div>
        <div class="sub">Monetag — Reward Rp30.000</div>
        <div class="small" id="count_earn_2">0/20</div>
        <div class="cd" style="display:none"></div>
        <div class="progress" style="width:0%"></div>
      </button>

      <button class="btn altgray" id="btn_xstra_2" data-key="xstra_2">
        <div class="title">Xstra Bonus</div>
        <div class="sub">KlikAdila — Reward Rp20.000</div>
        <div class="small" id="count_xstra_2">0/20</div>
        <div class="cd" style="display:none"></div>
        <div class="progress" style="width:0%"></div>
      </button>
    </div>

    <!-- Row 3 -->
    <div class="row" style="margin-top:10px">
      <button class="btn" id="btn_earn_3" data-key="earn_3">
        <div class="title">Menghasilkan</div>
        <div class="sub">Monetag — Reward Rp30.000</div>
        <div class="small" id="count_earn_3">0/20</div>
        <div class="cd" style="display:none"></div>
        <div class="progress" style="width:0%"></div>
      </button>

      <button class="btn altgray" id="btn_xstra_3" data-key="xstra_3">
        <div class="title">Xstra Bonus</div>
        <div class="sub">KlikAdila — Reward Rp20.000</div>
        <div class="small" id="count_xstra_3">0/20</div>
        <div class="cd" style="display:none"></div>
        <div class="progress" style="width:0%"></div>
      </button>
    </div>

    <div class="hint">Per tombol: cooldown 3 menit. Maks 20x/hari. Tombol "Kembali" pada Xstra memiliki cooldown 6 detik.</div>
  </div>

  <!-- WD -->
  <div class="card" style="margin-top:12px">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <div style="font-weight:800">Withdraw (E-Wallet)</div>
      <div class="small">Minimal Rp30.000 • E-Wallet only</div>
    </div>
    <div style="margin-top:10px;display:grid;grid-template-columns:1fr 1fr;gap:8px">
      <select id="walletType"><option>Dana</option><option>OVO</option><option>GoPay</option><option>ShopeePay</option></select>
      <input id="walletNumber" placeholder="Nomor e-wallet" inputmode="numeric"/>
      <input id="wdAmount" placeholder="Jumlah (mis. 30000)" inputmode="numeric" style="grid-column:1/3"/>
      <button id="btnWD" class="btn" style="grid-column:1/3;background:linear-gradient(180deg,#059669,#047857)">Ajukan WD</button>
    </div>
    <div style="display:flex;justify-content:space-between;align-items:center;margin-top:10px">
      <div class="small">Riwayat WD realtime</div>
      <button id="btnOpenHistory" class="btn secondary small" style="padding:8px 10px">Buka Riwayat</button>
    </div>
  </div>

  <!-- History sheet -->
  <div class="sheet" id="historySheet" aria-hidden="true">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <div style="font-weight:800">Riwayat Withdraw</div>
      <button id="closeHistory" class="btn secondary small" style="padding:6px 10px">Kembali</button>
    </div>
    <div id="historyList" style="margin-top:12px"></div>
  </div>

  <!-- Xstra overlay -->
  <div class="overlay" id="xstraOverlay">
    <div class="modal" style="width:100%;max-width:720px">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div style="font-weight:800">Xstra Bonus</div>
        <div>
          <button id="btnBackFromXstra" class="btn secondary small" style="padding:8px 10px">Kembali</button>
        </div>
      </div>
      <div class="small" style="margin-top:8px">Inpage akan muncul, setelah <b>3 detik</b> popunder dipicu. Kembali memiliki cooldown 6 detik.</div>

      <div class="adbox" style="margin-top:10px;padding:10px;border-radius:10px;border:1px solid rgba(255,255,255,.03);background:rgba(255,255,255,.01)">
        <div style="font-weight:700">InPage (KlikAdila - Spot 1461928)</div>
        <div id="xstra_inpage" style="min-height:140px;margin-top:8px"></div>
      </div>

      <div style="margin-top:8px;display:flex;gap:8px;justify-content:flex-end">
        <button id="btnManualPop" class="btn small" style="background:transparent;border:1px solid rgba(255,255,255,.06)">Buka Popunder</button>
      </div>
    </div>
  </div>

  <!-- float ad -->
  <div class="float-ad" id="floatAd">
    <header>
      <div style="font-weight:800">Promo</div>
      <button id="btnFloatClose" class="close">Tutup <span id="floatCloseCd"></span></button>
    </header>
    <div style="margin-top:8px">
      <div id="float_inpage" style="min-height:100px"></div>
      <div class="small" style="margin-top:8px">Muncul tiap 10 menit. Tombol tutup cooldown 5 detik.</div>
    </div>
  </div>

  <footer>© NusataskProject • App final</footer>
</div>

<!-- toast -->
<div id="toast" class="toast" style="display:none"></div>

<script>
/* =================== CONFIG =================== */
const FIREBASE_CONFIG = {
  apiKey: "AIzaSyCrFmaHbmL299cum51EtJIjt5NpukpTmho",
  authDomain: "penyimpanansaldo-280df.firebaseapp.com",
  databaseURL: "https://penyimpanansaldo-280df-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "penyimpanansaldo-280df",
  storageBucket: "penyimpanansaldo-280df.firebasede.appspot.com",
  messagingSenderId: "659609775130",
  appId: "1:659609775130:web:bdd088ca5a877498c5b5a3",
  measurementId: "G-L4TW7E23H2"
};

const TELEGRAM_BOT_TOKEN = "8236562243:AAFIyLCk2fu9-4GxxYSuIoSKw9DEiv1DVko";
const TELEGRAM_CHAT_ID   = "8322802091";

const REWARD_MONETAG = 30000;
const REWARD_XSTRA = 20000;
const COOLDOWN_MS = 3 * 60 * 1000; // 3 menit
const BACK_COOLDOWN_MS = 6 * 1000;
const FLOAT_INTERVAL_MS = 10 * 60 * 1000;
const DAY_LIMIT = 20;
const DAY_RESET_HOUR_WIB = 3; // reset jam 03:00 WIB

/* ================ HELPERS / UI ================ */
const $ = (s)=>document.querySelector(s);
const $$ = (s)=>Array.from(document.querySelectorAll(s));
function showToast(msg, t=2600){ const el=$("#toast"); el.textContent=msg; el.style.display="block"; el.style.opacity="1"; setTimeout(()=>{ el.style.opacity="0"; setTimeout(()=>el.style.display="none",300)}, t); }
function fmtRp(n){ return "Rp " + (n||0).toLocaleString("id-ID"); }
function wibNow(){ const now=new Date(); const utc=now.getTime()+(now.getTimezoneOffset()*60000); return new Date(utc + 7*3600*1000); }
function dayKeyWIB(){ const d=wibNow(); const isBefore=d.getHours()<DAY_RESET_HOUR_WIB; const base=new Date(d.getFullYear(), d.getMonth(), d.getDate() - (isBefore?1:0)); const y=base.getFullYear(); const m=String(base.getMonth()+1).padStart(2,'0'); const dd=String(base.getDate()).padStart(2,'0'); return `${y}-${m}-${dd}`; }
function msToMMSS(ms){ const s=Math.max(0, Math.ceil(ms/1000)); const m=Math.floor(s/60); const r=s%60; return `${String(m).padStart(2,'0')}:${String(r).padStart(2,'0')}`; }

/* ================ Firebase init ================ */
firebase.initializeApp(FIREBASE_CONFIG);
const auth = firebase.auth();
const db = firebase.firestore();

/* ================ State ================ */
let currentUser=null, userRef=null, limitsRef=null;
let balanceUnsub=null, limitsUnsubs={}, historyUnsub=null;
const KEYS = ["earn_1","xstra_1","earn_2","xstra_2","earn_3","xstra_3"];

/* ================ ENTRY overlay (IP) ================ */
async function fetchIp(){ try{ const r=await fetch("https://api.ipify.org?format=json"); const j=await r.json(); return j.ip; }catch(e){return "unknown";} }
(async ()=>{ const ip = await fetchIp(); $("#userIp").textContent = ip; })();

$("#btnExit").addEventListener("click", ()=> location.href="about:blank");
$("#btnAgree").addEventListener("click", ()=> { $("#entryOverlay").classList.remove("open"); startAuth(); });

/* ================ Auth & setup ================ */
async function startAuth(){
  try{
    await auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL);
    if(!auth.currentUser) await auth.signInAnonymously();
  }catch(e){ console.error(e); showToast("Gagal auto-login"); }

  auth.onAuthStateChanged(async user=>{
    if(!user) return;
    currentUser=user;
    userRef = db.collection("users").doc(user.uid);
    limitsRef = userRef.collection("limits");
    await ensureUserDoc();
    bindUserSnapshot();
    ensureLimitsDocs();
    bindLimitsAll();
    bindHistoryRealtime();
    wireUI();
    mountFloatInpage();
    showToast("Selamat datang!");
  });
}

async function ensureUserDoc(){
  const snap = await userRef.get();
  if(!snap.exists){
    const uname = "@user" + auth.currentUser.uid.slice(0,6);
    await userRef.set({ username: uname, saldo:0, createdAt: firebase.firestore.FieldValue.serverTimestamp(), lastSeen: firebase.firestore.FieldValue.serverTimestamp() }, {merge:true});
    $("#username").textContent = uname;
    $("#avatar").textContent = uname.replace("@","").slice(0,1).toUpperCase();
  } else {
    const d = snap.data()||{};
    $("#username").textContent = d.username || ("@user"+auth.currentUser.uid.slice(0,6));
    $("#avatar").textContent = (d.username||"U").replace("@","").slice(0,1).toUpperCase();
  }
}

/* ================ Balance snapshot ================ */
function bindUserSnapshot(){
  if(balanceUnsub) balanceUnsub();
  balanceUnsub = userRef.onSnapshot(snap=>{
    const d = snap.data()||{};
    $("#saldo").textContent = fmtRp(d.saldo||0);
    $("#uidline").textContent = "ID: " + currentUser.uid.slice(0,6).toUpperCase();
  });
}

/* ================ Limits (per-key docs) ================ */
async function ensureLimitsDocs(){
  for(const k of KEYS){
    const r = limitsRef.doc(k);
    const s = await r.get();
    if(!s.exists) await r.set({ count:0, until:0, dayKey: dayKeyWIB() }, {merge:true});
  }
}
function bindLimit(key){
  const docRef = limitsRef.doc(key);
  if(limitsUnsubs[key]) limitsUnsubs[key]();
  limitsUnsubs[key] = docRef.onSnapshot(snap=>{
    const data = snap.exists ? snap.data() : {count:0, until:0, dayKey: dayKeyWIB()};
    const count = data.count||0, until = data.until||0;
    const elCount = $(`#count_${key}`); if(elCount) elCount.textContent = `${count}/${DAY_LIMIT}`;
    const btn = document.querySelector(`[data-key="${key}"]`);
    const cdEl = btn.querySelector(".cd"); const prog = btn.querySelector(".progress");
    if(until && Date.now() < until){
      btn.classList.add("cooldown"); btn.disabled = true; cdEl.style.display="block"; cdEl.textContent = msToMMSS(until - Date.now());
      if(btn._tick) clearInterval(btn._tick);
      btn._tick = setInterval(()=>{ const left = until - Date.now(); if(left<=0){ clearInterval(btn._tick); btn._tick=null; btn.classList.remove("cooldown"); btn.disabled=false; cdEl.style.display="none"; prog.style.width="0%"; return; } cdEl.textContent = msToMMSS(left); const pct = Math.max(0, Math.min(100, Math.round((1 - (left / COOLDOWN_MS)) * 100))); prog.style.width = pct + "%"; }, 800);
    } else { if(btn._tick) clearInterval(btn._tick); btn._tick=null; btn.classList.remove("cooldown"); btn.disabled=false; cdEl.style.display="none"; prog.style.width="0%"; }
  });
}
function bindLimitsAll(){ for(const k of KEYS) bindLimit(k); }

/* ================ Claim transaction helper ================ */
async function runClaimTransaction(key, reward){
  const limitDoc = limitsRef.doc(key);
  const userDoc = userRef;
  const dayKey = dayKeyWIB();
  const now = Date.now();
  return db.runTransaction(async tx=>{
    const uSnap = await tx.get(userDoc);
    const lSnap = await tx.get(limitDoc);
    if(!uSnap.exists) throw new Error("USER_NOT_FOUND");
    const userData = uSnap.data() || {};
    const limitData = lSnap.exists ? lSnap.data() : {count:0, until:0, dayKey: dayKey};
    let count = limitData.count||0, until = limitData.until||0, savedDay = limitData.dayKey || dayKey;
    if(savedDay !== dayKey){ count = 0; savedDay = dayKey; until = 0; }
    if(count >= DAY_LIMIT) throw new Error("LIMIT_HARIAN");
    if(now < until) throw new Error("COOLDOWN");
    tx.update(userDoc, { saldo: (userData.saldo||0) + reward, lastSeen: firebase.firestore.FieldValue.serverTimestamp() });
    tx.set(limitDoc, { lastAt: firebase.firestore.FieldValue.serverTimestamp(), until: now + COOLDOWN_MS, dayKey: savedDay, count: count+1 }, {merge:true});
    return { nextUntil: now + COOLDOWN_MS, nextCount: count+1 };
  });
}

/* ================ Monetag (Menghasilkan) ================ */
function wireEarnButtons(){
  $$("button[data-key^='earn_']").forEach(btn=>{
    btn.addEventListener("click", async ()=>{
      const key = btn.dataset.key;
      if(btn.classList.contains("cooldown")) { showToast("Masih cooldown"); return; }
      if(typeof show_9779635 !== "function") { showToast("Monetag SDK belum siap"); return; }
      try{
        await show_9779635();
        await runClaimTransaction(key, REWARD_MONETAG);
        showToast(`✅ +${fmtRp(REWARD_MONETAG)}`);
      }catch(e){
        if(e && e.message === "LIMIT_HARIAN"){ showToast("Batas harian tombol ini sudah tercapai"); return; }
        if(e && e.message === "COOLDOWN"){ showToast("Masih cooldown"); return; }
        console.warn("Monetag error:", e); showToast("Iklan gagal atau dibatalkan");
      }
    });
  });
}

/* ================ ADILA SCRIPT (obfuscated) - PROVIDED BY YOU ================ */
/* We'll inject this script only when needed (on Xstra click).
   The exact obfuscated script text you gave is placed in ADILA_SCRIPT_STR.
   WARNING: keep this exact and do not alter it. */
const ADILA_SCRIPT_STR = `<script data-cfasync='false'>function R(K,h){var O=X();return R=function(p,E){p=p-0x87;var Z=O[p];return Z;},R(K,h);}(function(K,h){var Xo=R,O=K();while(!![]){try{var p=parseInt(Xo(0xac))/0x1*(-parseInt(Xo(0x90))/0x2)+parseInt(Xo(0xa5))/0x3*(-parseInt(Xo(0x8d))/0x4)+parseInt(Xo(0xb5))/0x5*(-parseInt(Xo(0x93))/0x6)+parseInt(Xo(0x89))/0x7+-parseInt(Xo(0xa1))/0x8+parseInt(Xo(0xa7))/0x9*(parseInt(Xo(0xb2))/0xa)+parseInt(Xo(0x95))/0xb*(parseInt(Xo(0x9f))/0xc);if(p===h)break;else O['push'](O['shift']());}catch(E){O['push'](O['shift']());}}}(X,0x33565),(function(){var XG=R;function K(){var Xe=R,h=365993,O='a3klsam',p='a',E='db',Z=Xe(0xad),S=Xe(0xb6),o=Xe(0xb0),e='cs',D='k',c='pro',u='xy',Q='su',G=Xe(0x9a),j='se',C='cr',z='et',w='sta',Y='tic',g='adMa',V='nager',A=p+E+Z+S+o,s=p+E+Z+S+e,W=p+E+Z+D+'-'+c+u+'-'+Q+G+'-'+j+C+z,L='/'+w+Y+'/'+g+V+Xe(0x9c),T=A,t=s,I=W,N=null,r=null,n=new Date()[Xe(0x94)]()[Xe(0x8c)]('T')[0x0][Xe(0xa3)](/-/ig,'.')['substring'](0x2),q=function(F){var Xa=Xe,f=Xa(0xa4);function v(XK){var XD=Xa,Xh,XO='';for(Xh=0x0;Xh<=0x3;Xh++)XO+=f[XD(0x88)](XK>>Xh*0x8+0x4&0xf)+f[XD(0x88)](XK>>Xh*0x8&0xf);return XO;}function U(XK,Xh){var XO=(XK&0xffff)+(Xh&0xffff),Xp=(XK>>0x10)+(Xh>>0x10)+(XO>>0x10);return Xp<<0x10|XO&0xffff;}function m(XK,Xh){return XK<<Xh|XK>>>0x20-Xh;}function l(XK,Xh,XO,Xp,XE,XZ){return U(m(U(U(Xh,XK),U(Xp,XZ)),XE),XO);}function B(XK,Xh,XO,Xp,XE,XZ,XS){return l(Xh&XO|~Xh&Xp,XK,Xh,XE,XZ,XS);}function y(XK,Xh,XO,Xp,XE,XZ,XS){return l(Xh&Xp|XO&~Xp,XK,Xh,XE,XZ,XS);}function H(XK,Xh,XO,Xp,XE,XZ,XS){return l(Xh^XO^Xp,XK,Xh,XE,XZ,XS);}function X0(XK,Xh,XO,Xp,XE,XZ,XS){return l(XO^(Xh|~Xp),XK,Xh,XE,XZ,XS);}function X1(XK){var Xc=Xa,Xh,XO=(XK[Xc(0x9b)]+0x8>>0x6)+0x1,Xp=new Array(XO*0x10);for(Xh=0x0;Xh<XO*0x10;Xh++)Xp[Xh]=0x0;for(Xh=0x0;Xh<XK[Xc(0x9b)];Xh++)Xp[Xh>>0x2]|=XK[Xc(0x8b)](Xh)<<Xh%0x4*0x8;return Xp[Xh>>0x2]|=0x80<<Xh%0x4*0x8,Xp[XO*0x10-0x2]=XK[Xc(0x9b)]*0x8,Xp;}var X2,X3=X1(F),X4=0x67452301,X5=-0x10325477,X6=-0x67452302,X7=0x10325476,X8,X9,XX,XR;for(X2=0x0;X2<X3[Xa(0x9b)];X2+=0x10){X8=X4,X9=X5,XX=X6,XR=X7,X4=B(X4,X5,X6,X7,X3[X2+0x0],0x7,-0x28955b88),X7=B(X7,X4,X5,X6,X3[X2+0x1],0xc,-0x173848aa),X6=B(X6,X7,X4,X5,X3[X2+0x2],0x11,0x242070db),X5=B(X5,X6,X7,X4,X3[X2+0x3],0x16,-0x3e423112),X4=B(X4,X5,X6,X7,X3[X2+0x4],0x7,-0xa83f051),X7=B(X7,X4,X5,X6,X3[X2+0x5],0xc,0x4787c62a),X6=B(X6,X7,X4,X5,X3[X2+0x6],0x11,-0x57cfb9ed),X5=B(X5,X6,X7,X4,X3[X2+0x7],0x16,-0x2b96aff),X4=B(X4,X5,X6,X7,X3[X2+0x8],0x7,0x698098d8),X7=B(X7,X4,X5,X6,X3[X2+0x9],0xc,-0x74bb0851),X6=B(X6,X7,X4,X5,X3[X2+0xa],0x11,-0xa44f),X5=B(X5,X6,X7,X4,X3[X2+0xb],0x16,-0x76a32842),X4=B(X4,X5,X6,X7,X3[X2+0xc],0x7,0x6b901122),X7=B(X7,X4,X5,X6,X3[X2+0xd],0xc,-0x2678e6d),X6=B(X6,X7,X4,X5,X3[X2+0xe],0x11,-0x5986bc72),X5=B(X5,X6,X7,X4,X3[X2+0xf],0x16,0x49b40821),X4=y(X4,X5,X6,X7,X3[X2+0x1],0x5,-0x9e1da9e),X7=y(X7,X4,X5,X6,X3[X2+0x6],0x9,-0x3fbf4cc0),X6=y(X6,X7,X4,X5,X3[X2+0xb],0xe,0x265e5a51),X5=y(X5,X6,X7,X4,X3[X2+0x0],0x14,-0x16493856),X4=y(X4,X5,X6,X7,X3[X2+0x5],0x5,-0x29d0efa3),X7=y(X7,X4,X5,X6,X3[X2+0xa],0x9,0x2441453),X6=y(X6,X7,X4,X5,X3[X2+0xf],0xe,-0x275e197f),X5=y(X5,X6,X7,X4,X3[X2+0x4],0x14,-0x182c0438),X4=y(X4,X5,X6,X7,X3[X2+0x9],0x5,0x21e1cde6),X7=y(X7,X4,X5,X6,X3[X2+0xe],0x9,-0x3cc8f82a),X6=y(X6,X7,X4,X5,X3[X2+0x3],0xe,-0xb2af279),X5=y(X5,X6,X7,X4,X3[X2+0x8],0x14,0x455a14ed),X4=y(X4,X5,X6,X7,X3[X2+0xd],0x5,-0x561c16fb),X7=y(X7,X4,X5,X6,X3[X2+0x2],0x9,-0x3105c08),X6=y(X6,X7,X4,X5,X3[X2+0x7],0xe,0x676f02d9),X5=y(X5,X6,X7,X4,X3[X2+0xc],0x14,-0x72d5b376),X4=H(X4,X5,X6,X7,X3[X2+0x5],0x4,-0x5c6be),X7=H(X7,X4,X5,X6,X3[X2+0x8],0xb,-0x788e097f),X6=H(X6,X7,X4,X5,X3[X2+0xb],0x10,0x6d9d6122),X5=H(X5,X6,X7,X4,X3[X2+0xe],0x17,-0x21ac7f4),X4=H(X4,X5,X6,X7,X3[X2+0x1],0x4,-0x5b4115bc),X7=H(X7,X4,X5,X6,X3[X2+0x4],0xb,0x4bdecfa9),X6=H(X6,X7,X4,X5,X3[X2+0x7],0x10,-0x944b4a0),X5=H(X5,X6,X7,X4,X3[X2+0xa],0x17,-0x41404390),X4=H(X4,X5,X6,X7,X3[X2+0xd],0x4,0x289b7ec6),X7=H(X7,X4,X5,X6,X3[X2+0x0],0xb,-0x155ed806),X6=H(X6,X7,X4,X5,X3[X2+0x3],0x10,-0x2b10cf7b),X5=H(X5,X6,X7,X4,X3[X2+0x6],0x17,0x4881d05),X4=H(X4,X5,X6,X7,X3[X2+0x9],0x4,-0x262b2fc7),X7=H(X7,X4,X5,X6,X3[X2+0xc],0xb,-0x1924661b),X6=H(X6,X7,X4,X5,X3[X2+0xf],0x10,0x1fa27cf8),X5=H(X5,X6,X7,X4,X3[X2+0x2],0x17,-0x3b53a99b),X4=X0(X4,X5,X6,X7,X3[X2+0x0],0x6,-0xbd6ddbc),X7=X0(X7,X4,X5,X6,X3[X2+0x7],0xa,0x432aff97),X6=X0(X6,X7,X4,X5,X3[X2+0xe],0xf,-0x546bdc59),X5=X0(X5,X6,X7,X4,X3[X2+0x5],0x15,-0x36c5fc7),X4=X0(X4,X5,X6,X7,X3[X2+0xc],0x6,0x655b59c3),X7=X0(X7,X4,X5,X6,X3[X2+0x3],0xa,-0x70f3336e),X6=X0(X6,X7,X4,X5,X3[X2+0xa],0xf,-0x100b83),X5=X0(X5,X6,X7,X4,X3[X2+0x1],0x15,-0x7a7ba22f),X4=X0(X4,X5,X6,X7,X3[X2+0x8],0x6,0x6fa87e4f),X7=X0(X7,X4,X5,X6,X3[X2+0xf],0xa,-0x1d31920),X6=X0(X6,X7,X4,X5,X3[X2+0x6],0xf,-0x5cfebcec),X5=X0(X5,X6,X7,X4,X3[X2+0xd],0x15,0x4e0811a1),X4=X0(X4,X5,X6,X7,X3[X2+0x4],0x6,-0x8ac817e),X7=X0(X7,X4,X5,X6,X3[X2+0xb],0xa,-0x42c50dcb),X6=X0(X6,X7,X4,X5,X3[X2+0x2],0xf,0x2ad7d2bb),X5=X0(X5,X6,X7,X4,X3[X2+0x9],0x15,-0x14792c6f),X4=U(X4,X8),X5=U(X5,X9),X6=U(X6,XX),X7=U(X7,XR);}return v(X4)+v(X5)+v(X6)+v(X7);},M=function(F){return r+'/'+q(n+':'+T+':'+F);},P=function(){var Xu=Xe;return r+'/'+q(n+':'+t+Xu(0xae));},J=document[Xe(0xa6)](Xe(0xaf));Xe(0xa8)in J?(L=L[Xe(0xa3)]('.js',Xe(0x9d)),J[Xe(0x91)]='module'):(L=L[Xe(0xa3)](Xe(0x9c),Xe(0xb4)),J[Xe(0xb3)]=!![]),N=q(n+':'+I+':domain')[Xe(0xa9)](0x0,0xa)+Xe(0x8a),r=Xe(0x92)+q(N+':'+I)[Xe(0xa9)](0x0,0xa)+'.'+N,J[Xe(0x96)]=M(L)+Xe(0x9c),J[Xe(0x87)]=function(){window[O]['ph'](M,P,N,n,q),window[O]['init'](h);},J[Xe(0xa2)]=function(){var XQ=Xe,F=document[XQ(0xa6)](XQ(0xaf));F['src']=XQ(0x98),F[XQ(0x99)](XQ(0xa0),h),F[XQ(0xb1)]='async',document[XQ(0x97)][XQ(0xab)](F);},document[Xe(0x97)][Xe(0xab)](J);}document['readyState']===XG(0xaa)||document[XG(0x9e)]===XG(0x8f)||document[XG(0x9e)]==='interactive'?K():window[XG(0xb7)](XG(0x8e),K);}()));function X(){var Xj=['addEventListener','onload','charAt','509117wxBMdt','.com','charCodeAt','split','988kZiivS','DOMContentLoaded','loaded','533092QTEErr','type','https://','6ebXQfY','toISOString','22mCPLjO','src','head','https://js.wpadmngr.com/static/adManager.js','setAttribute','per','length','.js','.m.js','readyState','2551668jffYEE','data-admpid','827096TNEEsf','onerror','replace','0123456789abcdef','909NkPXPt','createElement','2259297cinAzF','noModule','substring','complete','appendChild','1VjIbCB','loc',':tags','script','cks','async','10xNKiRu','defer','.l.js','469955xpTljk','ksu'];X=function(){return Xj;};return X();}</script>`;

/* inject Adila script string into DOM as <script> when needed */
let ADILA_INJECTED = false;
function injectAdilaScriptThen(callback){
  if(ADILA_INJECTED){ if(callback) callback(); return; }
  try{
    // create an inline script element with the provided obfuscated code
    const container = document.createElement('div');
    container.innerHTML = ADILA_SCRIPT_STR;
    const scr = container.querySelector('script');
    if(scr){
      document.head.appendChild(scr);
      ADILA_INJECTED = true;
      // small delay to let ad system init
      setTimeout(()=>{ if(callback) callback(); }, 800);
    } else { if(callback) callback(); }
  }catch(e){
    console.error("Inject Adila error", e);
    if(callback) callback();
  }
}

/* ================ Xstra flow ================ */
let currentXstraKey = null;
let backLockUntil = 0;

function openXstra(key){
  currentXstraKey = key;
  $("#xstraOverlay").classList.add("open");
  const cont = $("#xstra_inpage"); cont.innerHTML = "";
  // inject Adila script then mount inpage & popunder sequence
  injectAdilaScriptThen(()=> {
    const el = document.createElement("div"); el.setAttribute("data-admpid","1461928"); el.style.minHeight="120px";
    cont.appendChild(el);
    showToast("Inpage muncul — tunggu 3 detik untuk popunder");
    setTimeout(()=> {
      const pu = document.createElement("div"); pu.setAttribute("data-admpid","1461929"); pu.style.width="1px"; pu.style.height="1px"; pu.style.overflow="hidden";
      cont.appendChild(pu);
      showToast("Popunder dipicu");
    }, 3000);
  });
}

$("#btnManualPop")?.addEventListener("click", ()=>{
  injectAdilaScriptThen(()=> {
    const cont = $("#xstra_inpage");
    const pu = document.createElement("div"); pu.setAttribute("data-admpid","1461929"); pu.style.width="1px"; pu.style.height="1px"; cont.appendChild(pu);
    showToast("Popunder manual dipicu");
  });
});

$("#btnBackFromXstra").addEventListener("click", async ()=>{
  const now = Date.now();
  if(now < backLockUntil){ showToast(`Tunggu ${(Math.ceil((backLockUntil-now)/1000))} dtk`); return; }
  backLockUntil = now + BACK_COOLDOWN_MS;
  $("#xstraOverlay").classList.remove("open");
  if(!currentXstraKey) return;
  try{
    await runClaimTransaction(currentXstraKey, REWARD_XSTRA);
    showToast(`✅ +${fmtRp(REWARD_XSTRA)} (Xstra)`);
  }catch(e){
    if(e && e.message === "LIMIT_HARIAN"){ showToast("Batas harian Xstra tercapai"); return; }
    if(e && e.message === "COOLDOWN"){ showToast("Xstra masih cooldown"); return; }
    console.error("Xstra claim error", e); showToast("Gagal proses Xstra");
  } finally { currentXstraKey = null; }
});

/* wire xstra buttons */
function wireXstraButtons(){
  $$("button[data-key^='xstra_']").forEach(btn=>{
    btn.addEventListener("click", ()=>{
      const k = btn.dataset.key;
      if(btn.classList.contains("cooldown")) { showToast("Masih cooldown"); return; }
      openXstra(k);
    });
  });
}

/* ================ Float ad ================ */
let floatAllowedCloseAt = 0;
function showFloat(){ const el=$("#floatAd"); el.classList.add("show"); floatAllowedCloseAt = Date.now() + 5000; $("#floatCloseCd").textContent = `(${Math.ceil((floatAllowedCloseAt - Date.now())/1000)}s)`; const timer = setInterval(()=>{ const left=floatAllowedCloseAt-Date.now(); if(left<=0){ clearInterval(timer); $("#floatCloseCd").textContent=""; return; } $("#floatCloseCd").textContent=`(${Math.ceil(left/1000)}s)`; },300); }
$("#btnFloatClose").addEventListener("click", ()=>{ if(Date.now() < floatAllowedCloseAt) return; $("#floatAd").classList.remove("show"); });
function mountFloatInpage(){ const el = document.createElement("div"); el.setAttribute("data-admpid","1461928"); el.style.minHeight="90px"; $("#float_inpage").appendChild(el); setTimeout(()=>{ showFloat(); setInterval(showFloat, FLOAT_INTERVAL_MS); }, 12000); }

/* ================ Withdraw & History ================ */
async function sendTelegram(text){
  try{
    const url = `https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage`;
    await fetch(url, { method:"POST", headers:{"Content-Type":"application/json"}, body: JSON.stringify({ chat_id: TELEGRAM_CHAT_ID, text })});
  }catch(e){ console.warn("Telegram error", e); }
}

async function createWithdraw(){
  const amount = parseInt(($("#wdAmount").value||"0").replace(/\D/g,''),10) || 0;
  const wallet = $("#walletType").value;
  const number = $("#walletNumber").value.trim();
  if(amount < 30000){ showToast("Minimal WD Rp30.000"); return; }
  if(!number){ showToast("Nomor e-wallet wajib"); return; }
  try{
    const newId = await db.runTransaction(async tx=>{
      const uSnap = await tx.get(userRef);
      if(!uSnap.exists) throw new Error("USER_NOT_FOUND");
      const saldo = uSnap.data().saldo || 0;
      if(saldo < amount) throw new Error("SALDO_KURANG");
      const wdRef = db.collection("withdrawals").doc();
      tx.update(userRef, { saldo: saldo - amount });
      tx.set(wdRef, {
        id: wdRef.id, uid: currentUser.uid, username: (await userRef.get()).data()?.username || "",
        amount, wallet, number, status: "pending", createdAt: firebase.firestore.FieldValue.serverTimestamp()
      });
      return wdRef.id;
    });
    showToast("✅ WD diajukan (pending)");
    const when = new Date().toLocaleString("id-ID", {timeZone:"Asia/Jakarta"});
    const text = `📤 Permintaan WD Baru\nUser: ${(await userRef.get()).data()?.username || currentUser.uid}\nUID: ${currentUser.uid}\nJumlah: ${fmtRp(amount)}\nE-Wallet: ${wallet} • ${number}\nWaktu: ${when}\nID: ${newId}`;
    sendTelegram(text);
    $("#wdAmount").value=""; $("#walletNumber").value="";
  }catch(e){
    if(e.message === "SALDO_KURANG"){ showToast("Saldo tidak cukup"); return; }
    console.error("WD error", e); showToast("Gagal ajukan WD");
  }
}
$("#btnWD").addEventListener("click", createWithdraw);

/* realtime history of withdrawals */
function bindHistoryRealtime(){
  if(historyUnsub) historyUnsub();
  const q = db.collection("withdrawals").where("uid","==", currentUser.uid).orderBy("createdAt","desc");
  historyUnsub = q.onSnapshot(snap=>{
    const list = $("#historyList"); list.innerHTML = "";
    if(snap.empty){ const el=document.createElement("div"); el.className="small"; el.textContent="Belum ada riwayat WD."; list.appendChild(el); return; }
    snap.forEach(doc=>{
      const d=doc.data(); const when = d.createdAt && d.createdAt.toDate ? d.createdAt.toDate().toLocaleString("id-ID") : "-";
      const item=document.createElement("div"); item.style.marginBottom="8px"; item.style.padding="8px"; item.style.borderRadius="10px"; item.style.border="1px solid rgba(255,255,255,.03)";
      item.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:center"><div style="font-weight:800">${fmtRp(d.amount||0)}</div><div class="small">${when}</div></div><div style="display:flex;justify-content:space-between;align-items:center;margin-top:6px"><div class="small">No: ${d.number||"-"} • ${d.wallet||"-"}</div><div>${d.status ? `<span class="pill ${d.status==='success'?'success': d.status==='failed'?'failed':'pending'}">${d.status}</span>` : ''}</div></div>`;
      list.appendChild(item);
    });
  }, err=> { console.error("History snapshot error", err); showToast("Gagal memuat riwayat (cek index/rules)"); });
}
$("#btnOpenHistory").addEventListener("click", ()=> $("#historySheet").classList.add("open"));
$("#closeHistory").addEventListener("click", ()=> $("#historySheet").classList.remove("open"));

/* ================ UI wiring & startup ================ */
function wireUI(){
  wireEarnButtons(); wireXstraButtons();
  $("#btnAgree").addEventListener("click", ()=>{}); // already handled
  $("#btnExit").addEventListener("click", ()=> {});
  $("#btnManualPop").addEventListener("click", ()=>{}); // handled above
}

/* ================ Start after auth ================ */
auth.onAuthStateChanged(user=>{
  if(user){
    setTimeout(()=>{ ensureLimitsDocs(); bindLimitsAll(); bindHistoryRealtime(); wireUI(); mountFloatInpage(); }, 400);
  }
});

/* ================ Helpers: bind limits on load ================ */
function bindLimitsAll(){
  for(const k of KEYS) bindLimit(k);
}

/* ================ Init: mount earn button wiring once DOM ready ================ */
document.addEventListener("DOMContentLoaded", ()=>{
  // Ensure buttons wired at least
  setTimeout(()=>{ wireEarnButtons(); wireXstraButtons(); }, 600);
});
</script>
</body>
</html>
