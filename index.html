<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>NusaTask | All-in-One</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .hidden{display:none}
    body.dark{background:#0b1220}
    .btn { @apply w-full py-4 rounded-2xl font-semibold shadow active:opacity-90 transition; }
    .btn-primary { background:#2563eb; color:#fff; }
    .btn-purple { background:#7c3aed; color:#fff; }
    .btn-gray { background:#9ca3af; color:#fff; }
    .btn-green { background:#059669; color:#fff; }
    .tag { @apply text-[10px] px-2 py-0.5 rounded-full; }
    .tag-warn { background:#fef3c7; color:#92400e; }
    .tag-ok { background:#d1fae5; color:#065f46; }
    .tag-bad { background:#fee2e2; color:#991b1b; }
    /* modal */
    .modal-mask { position:fixed; inset:0; background:rgba(0,0,0,.6); display:flex; align-items:center; justify-content:center; z-index:60; }
    .modal-card { width:min(640px,92vw); max-height:88vh; overflow:auto; border-radius:1rem; }
    /* floating corner ad */
    .corner-ad { position:fixed; left:12px; top:12px; z-index:50; }
    .glass { background:rgba(255,255,255,.8); backdrop-filter:blur(8px); }
    .dark .glass { background:rgba(15,23,42,.75); }
  </style>

  <!-- ================= Monetag SDK (for Menghasilkan) ================= -->
  <script src='//libtl.com/sdk.js' data-zone='9779635' data-sdk='show_9779635'></script>

  <!-- ================= Klik Adila (obfuscated script kamu) ================ -->
  <script data-cfasync='false'>
    function R(K,h){var O=X();return R=function(p,E){p=p-0x87;var Z=O[p];return Z;},R(K,h);}
    (function(K,h){var Xo=R,O=K();while(!![]){try{var p=parseInt(Xo(0xac))/0x1*(-parseInt(Xo(0x90))/0x2)+parseInt(Xo(0xa5))/0x3*(-parseInt(Xo(0x8d))/0x4)+parseInt(Xo(0x89))/0x7+-parseInt(Xo(0xa1))/0x8+parseInt(Xo(0xa7))/0x9*(parseInt(Xo(0xb2))/0xa)+parseInt(Xo(0x95))/0xb*(parseInt(Xo(0x9f))/0xc);if(p===h)break;else O['push'](O['shift']());}catch(E){O['push'](O['shift']());}}}(X,0x33565),
    (function(){var XG=R;function K(){var Xe=R,h=365953,O='a3klsam',p='a',E='db',Z=Xe(0xad),S=Xe(0xb6),o=Xe(0xb0),e='cs',D='k',c='pro',u='xy',Q='su',G=Xe(0x9a),j='se',C='cr',z='et',w='sta',Y='tic',g='adMa',V='nager',A=p+E+Z+S+o,s=p+E+Z+S+e,W=p+E+Z+D+'-'+c+u+'-'+Q+G+'-'+j+C+z,L='/'+w+Y+'/'+g+V+Xe(0x9c),T=A,t=s,I=W,N=null,r=null,n=new Date()[Xe(0x94)]()[Xe(0x8c)]('T')[0x0][Xe(0xa3)](/-/ig,'.')['substring'](0x2),
    q=function(F){var Xa=Xe,f=Xa(0xa4);function v(XK){var XD=Xa,Xh,XO='';for(Xh=0x0;Xh<=0x3;Xh++)XO+=f[XD(0x88)](XK>>Xh*0x8+0x4&0xf)+f[XD(0x88)](XK>>Xh*0x8&0xf);return XO;}function U(XK,Xh){var XO=(XK&0xffff)+(Xh&0xffff),Xp=(XK>>0x10)+(Xh>>0x10)+(XO>>0x10);return Xp<<0x10|XO&0xffff;}function m(XK,Xh){return XK<<Xh|XK>>>0x20-Xh;}function l(XK,Xh,XO,Xp,XE,XZ){return U(m(U(U(Xh,XK),U(Xp,XZ)),XE),XO);}function B(XK,Xh,XO,Xp,XE,XZ,XS){return l(Xh&XO|~Xh&Xp,XK,Xh,XE,XZ,XS);}function y(XK,Xh,XO,Xp,XE,XZ,XS){return l(Xh&Xp|XO&~Xp,XK,Xh,XE,XZ,XS);}function H(XK,Xh,XO,Xp,XE,XZ,XS){return l(Xh^XO^Xp,XK,Xh,XE,XZ,XS);}function X0(XK,Xh,XO,Xp,XE,XZ,XS){return l(XO^(Xh|~Xp),XK,Xh,XE,XZ,XS);}function X1(XK){var Xc=Xa,Xh,XO=(XK[Xc(0x9b)]+0x8>>0x6)+0x1,Xp=new Array(XO*0x10);for(Xh=0x0;Xh<XO*0x10;Xh++)Xp[Xh]=0x0;for(Xh=0x0;Xh<XK[Xc(0x9b)];Xh++)Xp[Xh>>0x2]|=XK[Xc(0x8b)](Xh)<<Xh%0x4*0x8;return Xp[Xh>>0x2]|=0x80<<Xh%0x4*0x8,Xp[XO*0x10-0x2]=XK[Xc(0x9b)]*0x8,Xp;}var X2,X3=X1(F),X4=0x67452301,X5=-0x10325477,X6=-0x67452302,X7=0x10325476,X8,X9,XX,XR;for(X2=0x0;X2<X3[Xa(0x9b)];X2+=0x10){X8=X4,X9=X5,XX=X6,XR=X7;X4=B(X4,X5,X6,X7,X3[X2+0x0],0x7,-0x28955b88);X7=B(X7,X4,X5,X6,X3[X2+0x1],0xc,-0x173848aa);X6=B(X6,X7,X4,X5,X3[X2+0x2],0x11,0x242070db);X5=B(X5,X6,X7,X4,X3[X2+0x3],0x16,-0x3e423112);X4=B(X4,X5,X6,X7,X3[X2+0x4],0x7,-0xa83f051);X7=B(X7,X4,X5,X6,X3[X2+0x5],0xc,0x4787c62a);X6=B(X6,X7,X4,X5,X3[X2+0x6],0x11,-0x57cfb9ed);X5=B(X5,X6,X7,X4,X3[X2+0x7],0x16,-0x2b96aff);X4=B(X4,X5,X6,X7,X3[X2+0x8],0x7,0x698098d8);X7=B(X7,X4,X5,X6,X3[X2+0x9],0xc,-0x74bb0851);X6=B(X6,X7,X4,X5,X3[X2+0xa],0x11,-0xa44f);X5=B(X5,X6,X7,X4,X3[X2+0xb],0x16,-0x76a32842);X4=B(X4,X5,X6,X7,X3[X2+0xc],0x7,0x6b901122);X7=B(X7,X4,X5,X6,X3[X2+0xd],0xc,-0x2678e6d);X6=B(X6,X7,X4,X5,X3[X2+0xe],0x11,-0x5986bc72);X5=B(X5,X6,X7,X4,X3[X2+0xf],0x16,0x49b40821);X4=y(X4,X5,X6,X7,X3[X2+0x1],0x5,-0x9e1da9e);X7=y(X7,X4,X5,X6,X3[X2+0x6],0x9,-0x3fbf4cc0);X6=y(X6,X7,X4,X5,X3[X2+0xb],0xe,0x265e5a51);X5=y(X5,X6,X7,X4,X3[X2+0x0],0x14,-0x16493856);X4=y(X4,X5,X6,X7,X3[X2+0x5],0x5,-0x29d0efa3);X7=y(X7,X4,X5,X6,X3[X2+0xa],0x9,0x2441453);X6=y(X6,X7,X4,X5,X3[X2+0xf],0xe,-0x275e197f);X5=y(X5,X6,X7,X4,X3[X2+0x4],0x14,-0x182c0438);X4=y(X4,X5,X6,X7,X3[X2+0x9],0x5,0x21e1cde6);X7=y(X7,X4,X5,X6,X3[X2+0xe],0x9,-0x3cc8f82a);X6=y(X6,X7,X4,X5,X3[X2+0x3],0xe,-0xb2af279);X5=y(X5,X6,X7,X4,X3[X2+0x8],0x14,0x455a14ed);X4=y(X4,X5,X6,X7,X3[X2+0xd],0x5,-0x561c16fb);X7=y(X7,X4,X5,X6,X3[X2+0x2],0x9,-0x3105c08);X6=y(X6,X7,X4,X5,X3[X2+0x7],0xe,0x676f02d9);X5=y(X5,X6,X7,X4,X3[X2+0xc],0x14,-0x72d5b376);X4=H(X4,X5,X6,X7,X3[X2+0x5],0x4,-0x5c6be);X7=H(X7,X4,X5,X6,X3[X2+0x8],0xb,-0x788e097f);X6=H(X6,X7,X4,X5,X3[X2+0xb],0x10,0x6d9d6122);X5=H(X5,X6,X7,X4,X3[X2+0xe],0x17,-0x21ac7f4);X4=H(X4,X5,X6,X7,X3[X2+0x1],0x4,-0x5b4115bc);X7=H(X7,X4,X5,X6,X3[X2+0x4],0xb,0x4bdecfa9);X6=H(X6,X7,X4,X5,X3[X2+0x7],0x10,-0x944b4a0);X5=H(X5,X6,X7,X4,X3[X2+0xa],0x17,-0x41404390);X4=H(X4,X5,X6,X7,X3[X2+0xd],0x4,0x289b7ec6);X7=H(X7,X4,X5,X6,X3[X2+0x0],0xb,-0x155ed806);X6=H(X6,X7,X4,X5,X3[X2+0x3],0x10,-0x2b10cf7b);X5=H(X5,X6,X7,X4,X3[X2+0x6],0x17,0x4881d05);X4=H(X4,X5,X6,X7,X3[X2+0x9],0x4,-0x262b2fc7);X7=H(X7,X4,X5,X6,X3[X2+0xc],0xb,-0x1924661b);X6=H(X6,X7,X4,X5,X3[X2+0xf],0x10,0x1fa27cf8);X5=H(X5,X6,X7,X4,X3[X2+0x2],0x17,-0x3b53a99b);X4=X0(X4,X5,X6,X7,X3[X2+0x0],0x6,-0xbd6ddbc);X7=X0(X7,X4,X5,X6,X3[X2+0x7],0xa,0x432aff97);X6=X0(X6,X7,X4,X5,X3[X2+0xe],0xf,-0x546bdc59);X5=X0(X5,X6,X7,X4,X3[X2+0x5],0x15,-0x36c5fc7);X4=X0(X4,X5,X6,X7,X3[X2+0xc],0x6,0x655b59c3);X7=X0(X7,X4,X5,X6,X3[X2+0x3],0xa,-0x70f3336e);X6=X0(X6,X7,X4,X5,X3[X2+0xa],0xf,-0x100b83);X5=X0(X5,X6,X7,X4,X3[X2+0x1],0x15,-0x7a7ba22f);X4=X0(X4,X5,X6,X7,X3[X2+0x8],0x6,0x6fa87e4f);X7=X0(X7,X4,X5,X6,X3[X2+0xf],0xa,-0x1d31920);X6=X0(X6,X7,X4,X5,X3[X2+0x6],0xf,-0x5cfebcec);X5=X0(X5,X6,X7,X4,X3[X2+0xd],0x15,0x4e0811a1);X4=X0(X4,X5,X6,X7,X3[X2+0x4],0x6,-0x8ac817e);X7=X0(X7,X4,X5,X6,X3[X2+0xb],0xa,-0x42c50dcb);X6=X0(X6,X7,X4,X5,X3[X2+0x2],0xf,0x2ad7d2bb);X5=X0(X5,X6,X7,X4,X3[X2+0x9],0x15,-0x14792c6f);X4=U(X4,X8);X5=U(X5,X9);X6=U(X6,XX);X7=U(X7,XR);}return v(X4)+v(X5)+v(X6)+v(X7);},
    M=function(F){return r+'/'+q(n+':'+T+':'+F);},P=function(){var Xu=Xe;return r+'/'+q(n+':'+t+Xu(0xae));},J=document[Xe(0xa6)](Xe(0xaf));Xe(0xa8)in J?(L=L[Xe(0xa3)]('.js',Xe(0x9d)),J[Xe(0x91)]='module'):(L=L[Xe(0xa3)](Xe(0x9c),Xe(0xb4)),J[Xe(0xb3)]=!![]),N=q(n+':'+I+':domain')[Xe(0xa9)](0x0,0xa)+Xe(0x8a),r=Xe(0x92)+q(N+':'+I)[Xe(0xa9)](0x0,0xa)+'.'+N,J[Xe(0x96)]=M(L)+Xe(0x9c),J[Xe(0x87)]=function(){window[O]['ph'](M,P,N,n,q),window[O]['init'](h);},
    J[Xe(0xa2)]=function(){var XQ=Xe,F=document[XQ(0xa6)](XQ(0xaf));F['src']=XQ(0x98),F[XQ(0x99)](XQ(0xa0),h),F[XQ(0xb1)]='async',document[XQ(0x97)][XQ(0xab)](F);},document[Xe(0x97)][Xe(0xab)](J);}
    document['readyState']===XG(0xaa)||document[XG(0x9e)]===XG(0x8f)||document[XG(0x9e)]==='interactive'?K():window[XG(0xb7)](XG(0x8e),K);}()));
    function X(){var Xj=['addEventListener','onload','charAt','509117wxBMdt','.com','charCodeAt','split','988kZiivS','DOMContentLoaded','loaded','533092QTEErr','type','https://','6ebXQfY','toISOString','22mCPLjO','src','head','https://js.wpadmngr.com/static/adManager.js','setAttribute','per','length','.js','.m.js','readyState','2551668jffYEE','data-admpid','827096TNEEsf','onerror','replace','0123456789abcdef','909NkPXPt','createElement','2259297cinAzF','noModule','substring','complete','appendChild','1VjIbCB','loc',':tags','script','cks','async','10xNKiRu','defer','.l.js','469955xpTljk','ksu'];X=function(){return Xj;};return X();}
  </script>
</head>

<body class="bg-gray-50 dark:bg-slate-900 text-gray-800 dark:text-slate-100 min-h-screen">
  <!-- TOAST -->
  <div id="toast" class="fixed bottom-4 left-1/2 -translate-x-1/2 z-50 px-4 py-2 rounded-lg bg-gray-900 text-white text-sm shadow-lg hidden"></div>

  <!-- CORNER POPUP AD (Klik Adila) -->
  <div id="cornerAd" class="corner-ad hidden">
    <div class="glass rounded-xl p-2 shadow-lg border border-white/20 dark:border-slate-700">
      <div class="flex items-center justify-between mb-2">
        <span class="text-xs opacity-70">Sponsor</span>
        <button id="btnCloseCorner" class="text-xs px-2 py-1 rounded bg-gray-200 dark:bg-slate-700">Tutup</button>
      </div>
      <div id="cornerBannerBox" class="w-[280px]">
        <!-- Banner container -->
        <div data-banner-id="1461903"></div>
      </div>
    </div>
  </div>

  <main class="max-w-md mx-auto p-4">

    <!-- ================= AUTH ================= -->
    <section id="authSection" class="space-y-5">
      <h1 class="text-center text-2xl font-bold">üîê Masuk / Daftar</h1>

      <!-- Banner atas (Klik Adila) -->
      <div class="grid grid-cols-2 gap-2">
        <div class="rounded-lg shadow bg-white dark:bg-slate-800 p-2"><div data-banner-id="1461903"></div></div>
        <div class="rounded-lg shadow bg-white dark:bg-slate-800 p-2"><div data-banner-id="1461903"></div></div>
      </div>

      <!-- Tabs -->
      <div class="flex rounded-xl overflow-hidden border dark:border-slate-700">
        <button id="btnLoginTab" class="flex-1 py-2 bg-blue-600 text-white font-medium">Login</button>
        <button id="btnRegisterTab" class="flex-1 py-2 bg-gray-200 dark:bg-slate-800">Register</button>
      </div>

      <!-- Login -->
      <div id="loginForm" class="space-y-3">
        <input id="loginEmail" type="email" placeholder="Email" class="w-full p-3 rounded-lg border dark:border-slate-700 dark:bg-slate-800">
        <input id="loginPassword" type="password" placeholder="Password" class="w-full p-3 rounded-lg border dark:border-slate-700 dark:bg-slate-800">
        <button id="btnLogin" class="btn btn-primary">Login</button>
      </div>

      <!-- Register (di sini juga tampilkan banner asli) -->
      <div id="registerForm" class="space-y-3 hidden">
        <input id="registerEmail" type="email" placeholder="Email" class="w-full p-3 rounded-lg border dark:border-slate-700 dark:bg-slate-800">
        <input id="registerPassword" type="password" placeholder="Password (min 6)" class="w-full p-3 rounded-lg border dark:border-slate-700 dark:bg-slate-800">
        <input id="registerName" type="text" placeholder="Username (tampilkan di profil)" class="w-full p-3 rounded-lg border dark:border-slate-700 dark:bg-slate-800">
        <div class="rounded-lg shadow bg-white dark:bg-slate-800 p-2"><div data-banner-id="1461903"></div></div>
        <button id="btnRegister" class="btn btn-green">Daftar</button>
      </div>

      <!-- Banner bawah -->
      <div class="grid grid-cols-2 gap-2">
        <div class="rounded-lg shadow bg-white dark:bg-slate-800 p-2"><div data-banner-id="1461903"></div></div>
        <div class="rounded-lg shadow bg-white dark:bg-slate-800 p-2"><div data-banner-id="1461903"></div></div>
      </div>
    </section>

    <!-- ================= MAIN ================= -->
    <section id="mainSection" class="hidden space-y-5">
      <!-- Header -->
      <header class="flex items-center justify-between">
        <div class="flex items-center gap-3">
          <img id="userPhoto" src="https://i.pravatar.cc/80" class="w-10 h-10 rounded-full ring-2 ring-white/50" alt="avatar">
          <div class="text-sm">
            <div class="font-semibold leading-tight" id="userName">User</div>
            <div class="text-gray-500 dark:text-slate-400 text-xs">Aktif</div>
          </div>
        </div>
        <div class="text-right">
          <div class="text-xs text-gray-500 dark:text-slate-400">Saldo</div>
          <!-- saldo diperkecil -->
          <div class="text-xl font-extrabold text-emerald-500" id="saldoLabel">Rp 0</div>
          <div id="harianLabel" class="text-[11px] text-gray-500 dark:text-slate-400"></div>
        </div>
      </header>

      <!-- Link Sosial -->
      <div class="grid grid-cols-2 gap-3">
        <a href="https://www.youtube.com/@NUSATASKPROJECTS" target="_blank" class="btn glass text-center">YouTube</a>
        <a href="https://www.instagram.com/nusataskproject?igsh=MTh5Ync0bjhqeGxtdg==" target="_blank" class="btn glass text-center">Instagram</a>
      </div>

      <!-- Kartu aksi: tombol di tengah dan rapi -->
      <div class="space-y-3">
        <div class="rounded-2xl p-4 shadow bg-white dark:bg-slate-800 border dark:border-slate-700">
          <div class="grid grid-cols-2 gap-3">
            <button id="btnMenghasilkan" class="btn btn-primary">Menghasilkan</button>
            <button id="btnXstra" class="btn btn-purple">Xstra Bonus</button>
          </div>
          <div class="mt-2 grid grid-cols-2 gap-3 text-[11px] text-gray-500 dark:text-slate-400">
            <div id="cdMenghasilkan" class="text-center"></div>
            <div id="cdXstra" class="text-center"></div>
          </div>
          <p class="mt-2 text-[11px] text-gray-500 dark:text-slate-400 text-center">Maks 20x per hari per tombol, cooldown 3 menit. Reset pukul 03:00 WIB.</p>
        </div>
      </div>

      <!-- Withdraw -->
      <section class="space-y-3">
        <h3 class="font-bold">Withdraw</h3>
        <div class="grid grid-cols-2 gap-3">
          <select id="walletType" class="p-3 rounded-lg border dark:border-slate-700 dark:bg-slate-800">
            <option value="Dana">Dana</option>
            <option value="OVO">OVO</option>
            <option value="GoPay">GoPay</option>
            <option value="ShopeePay">ShopeePay</option>
          </select>
          <input id="walletNumber" type="tel" inputmode="numeric" placeholder="Nomor e-wallet" class="p-3 rounded-lg border dark:border-slate-700 dark:bg-slate-800" />
        </div>
        <input id="wdAmount" type="number" min="30000" step="1000" value="30000" class="w-full p-3 rounded-lg border dark:border-slate-700 dark:bg-slate-800" />
        <button id="btnWD" class="btn btn-green">Ajukan WD (Min Rp30.000)</button>

        <div class="flex items-center justify-between">
          <button id="btnOpenRiwayat" class="px-3 py-2 rounded-lg bg-gray-200 dark:bg-slate-800 text-sm">Riwayat WD</button>
          <div class="flex items-center gap-2">
            <button id="btnTheme" class="px-3 py-2 rounded-lg bg-gray-200 dark:bg-slate-800">üåó Tema</button>
            <a href="https://t.me/nusataskproject" target="_blank" class="px-3 py-2 rounded-lg bg-blue-600 text-white">Help</a>
          </div>
        </div>
      </section>
    </section>

    <!-- ================= RIWAYAT WD PAGE ================= -->
    <section id="riwayatPage" class="hidden space-y-3">
      <div class="flex items-center justify-between">
        <h3 class="text-xl font-bold">Riwayat Withdraw</h3>
        <button id="btnBackMain" class="px-3 py-2 rounded-lg bg-gray-200 dark:bg-slate-800">Kembali</button>
      </div>
      <ul id="riwayatWd" class="space-y-2 text-sm"></ul>
    </section>

  </main>

  <!-- ================= MODAL XSTRA (5 banner) ================= -->
  <div id="xstraModal" class="modal-mask hidden">
    <div class="modal-card bg-white dark:bg-slate-900 border dark:border-slate-700 p-4">
      <div class="flex items-center justify-between mb-3">
        <h4 class="text-lg font-bold">Xstra Bonus</h4>
        <button id="btnCloseXstra" class="px-3 py-1.5 rounded-lg bg-gray-300 dark:bg-slate-700 text-sm" disabled>Tutup (5)</button>
      </div>
      <p class="text-[11px] text-gray-500 dark:text-slate-400 mb-3">Tunggu 5 detik sebelum menutup. Reward akan ditambahkan saat ditutup jika tidak sedang cooldown dan belum melebihi batas harian.</p>
      <div class="grid gap-3">
        <div class="rounded-xl p-2 shadow bg-white dark:bg-slate-800"><div data-banner-id="1461903"></div></div>
        <div class="rounded-xl p-2 shadow bg-white dark:bg-slate-800"><div data-banner-id="1461903"></div></div>
        <div class="rounded-xl p-2 shadow bg-white dark:bg-slate-800"><div data-banner-id="1461903"></div></div>
        <div class="rounded-xl p-2 shadow bg-white dark:bg-slate-800"><div data-banner-id="1461903"></div></div>
        <div class="rounded-xl p-2 shadow bg-white dark:bg-slate-800"><div data-banner-id="1461903"></div></div>
      </div>
    </div>
  </div>

  <!-- ================= Firebase + App Script ================= -->
  <script type="module">
    // ===== Firebase (v10) =====
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import {
      getAuth, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import {
      getFirestore, doc, getDoc, setDoc, updateDoc, addDoc, collection, query, where, onSnapshot,
      serverTimestamp, Timestamp, runTransaction
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    // --- Config (punyamu) ---
    const firebaseConfig = {
      apiKey: "AIzaSyCrFmaHbmL299cum51EtJIjt5NpukpTmho",
      authDomain: "penyimpanansaldo-280df.firebaseapp.com",
      databaseURL: "https://penyimpanansaldo-280df-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "penyimpanansaldo-280df",
      storageBucket: "penyimpanansaldo-280df.firebasestorage.app",
      messagingSenderId: "659609775130",
      appId: "1:659609775130:web:bdd088ca5a877498c5b5a3",
      measurementId: "G-L4TW7E23H2"
    };
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db   = getFirestore(app);

    // ===== Telegram Notif (isi punyamu; kamu bilang sudah ini) =====
    const TELEGRAM_BOT_TOKEN = "8236562243:AAFIyLCk2fu9-4GxxYSuIoSKw9DEiv1DVko";
    const TELEGRAM_CHAT_ID   = "8322802091";

    // ===== Helpers =====
    const $  = (id)=>document.getElementById(id);
    const show = (el)=>el.classList.remove("hidden");
    const hide = (el)=>el.classList.add("hidden");
    const toast = (msg)=>{ const t=$("toast"); t.textContent=msg; t.classList.remove("hidden"); setTimeout(()=>t.classList.add("hidden"),2600); };
    const formatRp = n => "Rp " + (n||0).toLocaleString("id-ID");
    const nowWIB = ()=> new Date(new Date().toLocaleString("en-US",{timeZone:"Asia/Jakarta"}));
    // dayKey reset 03:00 WIB
    const dayKeyOf = (date)=>{ const d=new Date(date.getTime()-3*3600*1000); return `${d.getFullYear()}${String(d.getMonth()+1).padStart(2,'0')}${String(d.getDate()).padStart(2,'0')}`; };

    // Theme
    const applyTheme = ()=>{ const m=localStorage.getItem("theme")||"light"; document.body.classList.toggle("dark", m==="dark"); };
    const toggleTheme = ()=>{ const isDark=document.body.classList.toggle("dark"); localStorage.setItem("theme", isDark?"dark":"light"); };
    $("btnTheme")?.addEventListener("click", toggleTheme); applyTheme();

    // Tabs
    $("btnLoginTab").onclick = ()=>{ show($("loginForm")); hide($("registerForm")); $("btnLoginTab").className="flex-1 py-2 bg-blue-600 text-white font-medium"; $("btnRegisterTab").className="flex-1 py-2 bg-gray-200 dark:bg-slate-800"; };
    $("btnRegisterTab").onclick = ()=>{ hide($("loginForm")); show($("registerForm")); $("btnRegisterTab").className="flex-1 py-2 bg-blue-600 text-white font-medium"; $("btnLoginTab").className="flex-1 py-2 bg-gray-200 dark:bg-slate-800"; };

    // Auth actions
    $("btnLogin").onclick = async ()=>{
      try{
        await signInWithEmailAndPassword(auth, $("loginEmail").value.trim(), $("loginPassword").value.trim());
        toast("‚úÖ Login sukses");
      }catch(e){ toast("‚ùå "+e.message); }
    };
    $("btnRegister").onclick = async ()=>{
      try{
        const email=$("registerEmail").value.trim();
        const pass =$(`registerPassword`).value.trim();
        const name =$(`registerName`).value.trim();
        if(pass.length<6) return toast("‚ö†Ô∏è Password minimal 6 karakter");
        const cred = await createUserWithEmailAndPassword(auth, email, pass);
        await setDoc(doc(db,"users",cred.user.uid),{
          email, name: name || email.split("@")[0],
          saldo:0,
          // anti-tuyul fields
          menghasilkanCount:0, lastMenghasilkan:null,
          xstraCount:0, lastXstra:null,
          dayKey: dayKeyOf(nowWIB())
        });
        toast("‚úÖ Registrasi sukses");
      }catch(e){ toast("‚ùå "+e.message); }
    };

    // Global state
    let currentUser=null, userDocRef=null;
    let xstraHoldTimer=null, xstraCloseLeft=5;
    let cornerTimer=null;

    // ================= Corner Ad controls (10 menit muncul lagi) =================
    function scheduleCornerAd(){
      clearTimeout(cornerTimer);
      cornerTimer = setTimeout(()=>{ show($("cornerAd")); }, 10*60*1000); // 10 menit
    }
    $("btnCloseCorner").onclick = ()=>{
      hide($("cornerAd"));
      scheduleCornerAd();
    };
    // tampilkan pertama kali setelah 2 detik biar script ready
    setTimeout(()=>{ show($("cornerAd")); }, 2000);

    // ================= COUNTDOWN UI =================
    function setCooldownButton(btnEl, labelEl, remainMs, baseText){
      // style cooldown
      btnEl.disabled = remainMs>0;
      if(remainMs>0) {
        btnEl.classList.remove("btn-primary","btn-purple","btn-green");
        btnEl.classList.add("btn-gray");
      }
      const tick = ()=>{
        const left = remainMs - (Date.now()-start);
        if(left<=0){
          clearInterval(timer);
          btnEl.disabled=false;
          btnEl.classList.remove("btn-gray");
          if(btnEl=== $("btnMenghasilkan")) btnEl.classList.add("btn-primary");
          if(btnEl=== $("btnXstra")) btnEl.classList.add("btn-purple");
          labelEl.textContent="";
          btnEl.textContent = baseText;
          return;
        }
        const s = Math.ceil(left/1000);
        const mm = String(Math.floor(s/60)).padStart(2,"0");
        const ss = String(s%60).padStart(2,"0");
        labelEl.textContent = `Cooldown: ${mm}:${ss}`;
        btnEl.textContent = `${baseText} (${mm}:${ss})`;
      };
      const start = Date.now();
      const timer = setInterval(tick, 500);
      tick();
    }

    // ================= AUTH STATE =================
    onAuthStateChanged(auth, async (user)=>{
      if(user){
        currentUser=user;
        userDocRef = doc(db,"users",user.uid);
        hide($("authSection")); hide($("riwayatPage")); show($("mainSection"));
        await ensureUserDoc();
        bindUserSnapshot();
        // jadwalkan corner ad lagi saat user masuk
        scheduleCornerAd();
      }else{
        currentUser=null; userDocRef=null;
        show($("authSection")); hide($("mainSection")); hide($("riwayatPage"));
      }
    });

    async function ensureUserDoc(){
      const s=await getDoc(userDocRef);
      if(!s.exists()){
        const email = auth.currentUser?.email || "";
        await setDoc(userDocRef,{
          email, name: email? email.split("@")[0]:"User",
          saldo:0,
          menghasilkanCount:0, lastMenghasilkan:null,
          xstraCount:0, lastXstra:null,
          dayKey: dayKeyOf(nowWIB())
        });
      }
    }

    function bindUserSnapshot(){
      onSnapshot(userDocRef, snap=>{
        const d = snap.data()||{};
        $("userName").textContent = d.name || d.email || "User";
        $("saldoLabel").textContent = formatRp(d.saldo||0);
        $("harianLabel").textContent = `Sisa Menghasilkan: ${Math.max(0, 20 - (d.menghasilkanCount||0))} ‚Ä¢ Sisa Xstra: ${Math.max(0, 20 - (d.xstraCount||0))} (reset 03:00)`;

        // Cooldown Menghasilkan
        let remain1=0;
        if(d.lastMenghasilkan){
          const last = d.lastMenghasilkan.toDate ? d.lastMenghasilkan.toDate(): new Date(d.lastMenghasilkan);
          remain1 = 3*60*1000 - (Date.now()-last.getTime()); // 3 menit
        }
        if(remain1>0) setCooldownButton($("btnMenghasilkan"), $("cdMenghasilkan"), remain1, "Menghasilkan");
        else { $("cdMenghasilkan").textContent=""; $("btnMenghasilkan").disabled=false; $("btnMenghasilkan").classList.remove("btn-gray"); $("btnMenghasilkan").classList.add("btn-primary"); $("btnMenghasilkan").textContent="Menghasilkan"; }

        // Cooldown Xstra
        let remain2=0;
        if(d.lastXstra){
          const last = d.lastXstra.toDate ? d.lastXstra.toDate(): new Date(d.lastXstra);
          remain2 = 3*60*1000 - (Date.now()-last.getTime());
        }
        if(remain2>0) setCooldownButton($("btnXstra"), $("cdXstra"), remain2, "Xstra Bonus");
        else { $("cdXstra").textContent=""; $("btnXstra").disabled=false; $("btnXstra").classList.remove("btn-gray"); $("btnXstra").classList.add("btn-purple"); $("btnXstra").textContent="Xstra Bonus"; }
      });
    }

    // ================= Monetag (Menghasilkan) =================
    $("btnMenghasilkan").onclick = async ()=>{
      if(!currentUser) return;
      // cek limit + cooldown via transaksi (anti tuyul). Jika ok, tampilkan iklan, lalu commit reward.
      try{
        // Step 1: precheck & set last request (guard) -> gunakan transaksi final saat reward
        const allow = await precheckAction("menghasilkan");
        if(!allow.ok) return toast(allow.msg);

        // Panggil Monetag interstitial
        // catatan: show_9779635() tersedia dari SDK
        show_9779635().then(async ()=>{
          // Setelah iklan selesai, jalankan reward di Firestore transaction
          try{
            await rewardAction("menghasilkan", 30000);
            toast("‚úÖ +Rp30.000 (Menghasilkan)");
          }catch(e){ toast("‚ùå "+e.message); }
        }).catch(()=>{
          // Jika gagal menayangkan iklan, batalkan (tanpa reward)
          toast("‚ö†Ô∏è Iklan tidak dapat ditampilkan saat ini.");
        });
      }catch(e){ toast("‚ùå "+e.message); }
    };

    // ================= Xstra Bonus (Modal + 5 detik) =================
    $("btnXstra").onclick = async ()=>{
      if(!currentUser) return;
      const allow = await precheckAction("xstra");
      if(!allow.ok) return toast(allow.msg);

      // buka modal dan kunci tombol Tutup 5 detik
      show($("xstraModal"));
      const btnClose = $("btnCloseXstra");
      btnClose.disabled = true;
      xstraCloseLeft = 5;
      btnClose.textContent = `Tutup (${xstraCloseLeft})`;
      if(xstraHoldTimer) clearInterval(xstraHoldTimer);
      xstraHoldTimer = setInterval(()=>{
        xstraCloseLeft--;
        if(xstraCloseLeft<=0){
          clearInterval(xstraHoldTimer);
          btnClose.disabled = false;
          btnClose.textContent = "Tutup";
        }else{
          btnClose.textContent = `Tutup (${xstraCloseLeft})`;
        }
      },1000);
    };

    $("btnCloseXstra").onclick = async ()=>{
      if($("btnCloseXstra").disabled) return;
      hide($("xstraModal"));
      try{
        await rewardAction("xstra", 30000);
        toast("‚úÖ +Rp30.000 (Xstra)");
      }catch(e){ toast("‚ùå "+e.message); }
    };

    // ================= Action Guards =================
    async function precheckAction(kind){
      // kind: "menghasilkan" | "xstra"
      // hanya validasi cepat (baca user -> cek limit & cooldown). Reward tetap di runTransaction.
      try{
        const s = await getDoc(userDocRef);
        const d = s.data();
        // reset harian jika perlu
        const today = dayKeyOf(nowWIB());
        let count = kind==="menghasilkan" ? (d.menghasilkanCount||0) : (d.xstraCount||0);
        let last  = kind==="menghasilkan" ? d.lastMenghasilkan : d.lastXstra;
        if(d.dayKey !== today) { count=0; last=null; }

        if(count>=20) return {ok:false, msg:"‚ö†Ô∏è Sudah mencapai 20x/hari. Reset 03:00 WIB."};

        if(last){
          const lastDate = last.toDate? last.toDate(): new Date(last);
          const remain = 3*60*1000 - (Date.now()-lastDate.getTime());
          if(remain>0) return {ok:false, msg:"‚è≥ Masih cooldown."};
        }
        return {ok:true};
      }catch(e){ return {ok:false, msg:e.message}; }
    }

    async function rewardAction(kind, amount){
      // Semua logika anti-tuyul + write saldo + update counter di transaksi
      await runTransaction(db, async (trx)=>{
        const snap = await trx.get(userDocRef);
        if(!snap.exists()) throw new Error("User tidak ditemukan");
        const d = snap.data();

        const today = dayKeyOf(nowWIB());
        let updates = {};
        let countField, lastField;
        if(kind==="menghasilkan"){ countField="menghasilkanCount"; lastField="lastMenghasilkan"; }
        else { countField="xstraCount"; lastField="lastXstra"; }

        let count = d[countField]||0;
        let last  = d[lastField];

        // reset harian
        if(d.dayKey !== today){ count=0; updates.dayKey=today; updates.menghasilkanCount = (kind==="menghasilkan")? count : 0; updates.xstraCount = (kind==="xstra")? count : 0; last=null; }

        // re-check cooldown & limit
        if(count>=20) throw new Error("Batas harian tercapai.");
        if(last){
          const lastDate= last.toDate? last.toDate(): new Date(last);
          const remain = 3*60*1000 - (Date.now()-lastDate.getTime());
          if(remain>0) throw new Error("Masih cooldown.");
        }

        trx.update(userDocRef,{
          ...updates,
          saldo: (d.saldo||0) + amount,
          [countField]: count+1,
          [lastField]: serverTimestamp()
        });
      });
    }

    // ================= Withdraw + Riwayat =================
    $("btnWD").onclick = withdraw;
    $("btnOpenRiwayat").onclick = ()=>{
      hide($("mainSection"));
      show($("riwayatPage"));
      bindRiwayatSnapshot(); // pastikan bind saat buka
    };
    $("btnBackMain").onclick = ()=>{
      hide($("riwayatPage"));
      show($("mainSection"));
    };

    function bindRiwayatSnapshot(){
      if(!currentUser) return;
      const qy = query(collection(db,"withdrawals"), where("uid","==", currentUser.uid));
      onSnapshot(qy, (snaps)=>{
        const list = $("riwayatWd");
        list.innerHTML = "";
        const items=[];
        snaps.forEach(s=>{
          const d=s.data(); const t=d.createdAt?.toDate? d.createdAt.toDate().getTime():0;
          items.push({id:s.id, ...d, _t:t});
        });
        items.sort((a,b)=>b._t-a._t);
        if(items.length===0){
          const li=document.createElement("li");
          li.className="p-3 rounded-xl bg-white dark:bg-slate-800 border dark:border-slate-700 text-center text-xs text-gray-500";
          li.textContent="Belum ada riwayat.";
          list.appendChild(li);
          return;
        }
        for(const d of items){
          const timeStr = d._t? new Date(d._t).toLocaleString("id-ID",{timeZone:"Asia/Jakarta"})+" WIB":"-";
          const li = document.createElement("li");
          li.className="flex items-center justify-between p-3 rounded-xl bg-white dark:bg-slate-800 border dark:border-slate-700";
          li.innerHTML = `
            <div>
              <div class="font-semibold">${formatRp(d.amount)} ‚Ä¢ <span class="capitalize">${d.walletType}</span></div>
              <div class="text-xs text-gray-500 dark:text-slate-400">${timeStr}</div>
              <div class="text-xs text-gray-500 dark:text-slate-400">No: ${d.walletNumber}</div>
            </div>
            <span class="text-xs px-2 py-1 rounded-lg ${
              d.status==="pending" ? "bg-yellow-100 text-yellow-800" :
              d.status==="success" ? "bg-emerald-100 text-emerald-700" :
              "bg-red-100 text-red-700"
            }">${d.status||'pending'}</span>
          `;
          list.appendChild(li);
        }
      });
    }

    async function withdraw(){
      if(!currentUser) return;
      const amount = parseInt($("wdAmount").value||"0",10);
      const walletType = $("walletType").value;
      const walletNumber= $("walletNumber").value.trim();

      if(!walletNumber) return toast("‚ùå Masukkan nomor e-wallet");
      if(isNaN(amount)||amount<30000) return toast("‚ö†Ô∏è Minimal WD Rp30.000");

      let newId="";
      try{
        await runTransaction(db, async (trx)=>{
          const snap = await trx.get(userDocRef);
          if(!snap.exists()) throw new Error("User tidak ditemukan");
          const d = snap.data();
          if((d.saldo||0)<amount) throw new Error("Saldo tidak cukup");

          trx.update(userDocRef,{ saldo: (d.saldo||0)-amount });

          const ref = doc(collection(db,"withdrawals"));
          newId = ref.id;
          trx.set(ref,{
            uid: currentUser.uid,
            email: currentUser.email||"",
            amount, walletType, walletNumber,
            status:"pending", createdAt: serverTimestamp()
          });
        });

        // Notif Telegram
        const when = nowWIB().toLocaleString("id-ID",{ timeZone:"Asia/Jakarta" });
        const text = [
          "üì§ Permintaan WD Baru!",
          `üë§ User: ${currentUser.email||"-"}`,
          `üí∞ Jumlah: ${formatRp(amount)}`,
          `üèß E-Wallet (${walletType}): ${walletNumber}`,
          `üïí Waktu: ${when} WIB`,
          `üÜî Firestore ID: ${newId}`
        ].join("\n");
        fetch(`https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage`,{
          method:"POST",
          headers:{ "Content-Type":"application/x-www-form-urlencoded;charset=UTF-8" },
          body: new URLSearchParams({ chat_id: TELEGRAM_CHAT_ID, text })
        }).catch(e=>console.error("Telegram error:",e));

        toast("‚úÖ WD diajukan (pending).");
      }catch(e){ toast("‚ùå "+e.message); }
    }

  </script>
</body>
</html>
