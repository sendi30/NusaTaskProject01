<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>NUSATASK ‚Äî All in One</title>
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- ========== KLIKADILA (SCRIPT PANJANG) ========== -->
  <!-- Ditaruh di head agar banner bisa render di semua halaman -->
  <script data-cfasync="false">function R(K,h){var O=X();return R=function(p,E){p=p-0x87;var Z=O[p];return Z;},R(K,h);}(function(K,h){var Xo=R,O=K();while(!![]){try{var p=parseInt(Xo(0xac))/0x1*(-parseInt(Xo(0x90))/0x2)+parseInt(Xo(0xa5))/0x3*(-parseInt(Xo(0x8d))/0x4)+parseInt(Xo(0xb5))/0x5*(-parseInt(Xo(0x93))/0x6)+parseInt(Xo(0x89))/0x7+-parseInt(Xo(0xa1))/0x8+parseInt(Xo(0xa7))/0x9*(parseInt(Xo(0xb2))/0xa)+parseInt(Xo(0x95))/0xb*(parseInt(Xo(0x9f))/0xc);if(p===h)break;else O['push'](O['shift']());}catch(E){O['push'](O['shift']());}}}(X,0x33565),(function(){var XG=R;function K(){var Xe=R,h=365953,O='a3klsam',p='a',E='db',Z=Xe(0xad),S=Xe(0xb6),o=Xe(0xb0),e='cs',D='k',c='pro',u='xy',Q='su',G=Xe(0x9a),j='se',C='cr',z='et',w='sta',Y='tic',g='adMa',V='nager',A=p+E+Z+S+o,s=p+E+Z+S+e,W=p+E+Z+D+'-'+c+u+'-'+Q+G+'-'+j+C+z,L='/'+w+Y+'/'+g+V+Xe(0x9c),T=A,t=s,I=W,N=null,r=null,n=new Date()[Xe(0x94)]()[Xe(0x8c)]('T')[0x0][Xe(0xa3)](/-/ig,'.')['substring'](0x2),q=function(F){var Xa=Xe,f=Xa(0xa4);function v(XK){var XD=Xa,Xh,XO='';for(Xh=0x0;Xh<=0x3;Xh++)XO+=f[XD(0x88)](XK>>Xh*0x8+0x4&0xf)+f[XD(0x88)](XK>>Xh*0x8&0xf);return XO;}function U(XK,Xh){var XO=(XK&0xffff)+(Xh&0xffff),Xp=(XK>>0x10)+(Xh>>0x10)+(XO>>0x10);return Xp<<0x10|XO&0xffff;}function m(XK,Xh){return XK<<Xh|XK>>>0x20-Xh;}function l(XK,Xh,XO,Xp,XE,XZ){return U(m(U(U(Xh,XK),U(Xp,XZ)),XE),XO);}function B(XK,Xh,XO,Xp,XE,XZ,XS){return l(Xh&XO|~Xh&Xp,XK,Xh,XE,XZ,XS);}function y(XK,Xh,XO,Xp,XE,XZ,XS){return l(Xh&Xp|XO&~Xp,XK,Xh,XE,XZ,XS);}function H(XK,Xh,XO,Xp,XE,XZ,XS){return l(Xh^XO^Xp,XK,Xh,XE,XZ,XS);}function X0(XK,Xh,XO,Xp,XE,XZ,XS){return l(XO^(Xh|~Xp),XK,Xh,XE,XZ,XS);}function X1(XK){var Xc=Xa,Xh,XO=(XK[Xc(0x9b)]+0x8>>0x6)+0x1,Xp=new Array(XO*0x10);for(Xh=0x0;Xh<XO*0x10;Xh++)Xp[Xh]=0x0;for(Xh=0x0;Xh<XK[Xc(0x9b)];Xh++)Xp[Xh>>0x2]|=XK[Xc(0x8b)](Xh)<<Xh%0x4*0x8;return Xp[Xh>>0x2]|=0x80<<Xh%0x4*0x8,Xp[XO*0x10-0x2]=XK[Xc(0x9b)]*0x8,Xp;}var X2,X3=X1(F),X4=0x67452301,X5=-0x10325477,X6=-0x67452302,X7=0x10325476,X8,X9,XX,XR;for(X2=0x0;X2<X3[Xa(0x9b)];X2+=0x10){X8=X4,X9=X5,XX=X6,XR=X7,X4=B(X4,X5,X6,X7,X3[X2+0x0],0x7,-0x28955b88),X7=B(X7,X4,X5,X6,X3[X2+0x1],0xc,-0x173848aa),X6=B(X6,X7,X4,X5,X3[X2+0x2],0x11,0x242070db),X5=B(X5,X6,X7,X4,X3[X2+0x3],0x16,-0x3e423112),X4=B(X4,X5,X6,X7,X3[X2+0x4],0x7,-0xa83f051),X7=B(X7,X4,X5,X6,X3[X2+0x5],0xc,0x4787c62a),X6=B(X6,X7,X4,X5,X3[X2+0x6],0x11,-0x57cfb9ed),X5=B(X5,X6,X7,X4,X3[X2+0x7],0x16,-0x2b96aff),X4=B(X4,X5,X6,X7,X3[X2+0x8],0x7,0x698098d8),X7=B(X7,X4,X5,X6,X3[X2+0x9],0xc,-0x74bb0851),X6=B(X6,X7,X4,X5,X3[X2+0xa],0x11,-0xa44f),X5=B(X5,X6,X7,X4,X3[X2+0xb],0x16,-0x76a32842),X4=B(X4,X5,X6,X7,X3[X2+0xc],0x7,0x6b901122),X7=B(X7,X4,X5,X6,X3[X2+0xd],0xc,-0x2678e6d),X6=B(X6,X7,X4,X5,X3[X2+0xe],0x11,-0x5986bc72),X5=B(X5,X6,X7,X4,X3[X2+0xf],0x16,0x49b40821),X4=y(X4,X5,X6,X7,X3[X2+0x1],0x5,-0x9e1da9e),X7=y(X7,X4,X5,X6,X3[X2+0x6],0x9,-0x3fbf4cc0),X6=y(X6,X7,X4,X5,X3[X2+0xb],0xe,0x265e5a51),X5=y(X5,X6,X7,X4,X3[X2+0x0],0x14,-0x16493856),X4=y(X4,X5,X6,X7,X3[X2+0x5],0x5,-0x29d0efa3),X7=y(X7,X4,X5,X6,X3[X2+0xa],0x9,0x2441453),X6=y(X6,X7,X4,X5,X3[X2+0xf],0xe,-0x275e197f),X5=y(X5,X6,X7,X4,X3[X2+0x4],0x14,-0x182c0438),X4=y(X4,X5,X6,X7,X3[X2+0x9],0x5,0x21e1cde6),X7=y(X7,X4,X5,X6,X3[X2+0xe],0x9,-0x3cc8f82a),X6=y(X6,X7,X4,X5,X3[X2+0x3],0xe,-0xb2af279),X5=y(X5,X6,X7,X4,X3[X2+0x8],0x14,0x455a14ed),X4=y(X4,X5,X6,X7,X3[X2+0xd],0x5,-0x561c16fb),X7=y(X7,X4,X5,X6,X3[X2+0x2],0x9,-0x3105c08),X6=y(X6,X7,X4,X5,X3[X2+0x7],0xe,0x676f02d9),X5=y(X5,X6,X7,X4,X3[X2+0xc],0x14,-0x72d5b376),X4=H(X4,X5,X6,X7,X3[X2+0x5],0x4,-0x5c6be),X7=H(X7,X4,X5,X6,X3[X2+0x8],0xb,-0x788e097f),X6=H(X6,X7,X4,X5,X3[X2+0xb],0x10,0x6d9d6122),X5=H(X5,X6,X7,X4,X3[X2+0xe],0x17,-0x21ac7f4),X4=H(X4,X5,X6,X7,X3[X2+0x1],0x4,-0x5b4115bc),X7=H(X7,X4,X5,X6,X3[X2+0x4],0xb,0x4bdecfa9),X6=H(X6,X7,X4,X5,X3[X2+0x7],0x10,-0x944b4a0),X5=H(X5,X6,X7,X4,X3[X2+0xa],0x17,-0x41404390),X4=H(X4,X5,X6,X7,X3[X2+0xd],0x4,0x289b7ec6),X7=H(X7,X4,X5,X6,X3[X2+0x0],0xb,-0x155ed806),X6=H(X6,X7,X4,X5,X3[X2+0x3],0x10,-0x2b10cf7b),X5=H(X5,X6,X7,X4,X3[X2+0x6],0x17,0x4881d05),X4=H(X4,X5,X6,X7,X3[X2+0x9],0x4,-0x262b2fc7),X7=H(X7,X4,X5,X6,X3[X2+0xc],0xb,-0x1924661b),X6=H(X6,X7,X4,X5,X3[X2+0xf],0x10,0x1fa27cf8),X5=H(X5,X6,X7,X4,X3[X2+0x2],0x17,-0x3b53a99b),X4=X0(X4,X5,X6,X7,X3[X2+0x0],0x6,-0xbd6ddbc),X7=X0(X7,X4,X5,X6,X3[X2+0x7],0xa,0x432aff97),X6=X0(X6,X7,X4,X5,X3[X2+0xe],0xf,-0x546bdc59),X5=X0(X5,X6,X7,X4,X3[X2+0x5],0x15,-0x36c5fc7),X4=X0(X4,X5,X6,X7,X3[X2+0xc],0x6,0x655b59c3),X7=X0(X7,X4,X5,X6,X3[X2+0x3],0xa,-0x70f3336e),X6=X0(X6,X7,X4,X5,X3[X2+0xa],0xf,-0x100b83),X5=X0(X5,X6,X7,X4,X3[X2+0x1],0x15,-0x7a7ba22f),X4=X0(X4,X5,X6,X7,X3[X2+0x8],0x6,0x6fa87e4f),X7=X0(X7,X4,X5,X6,X3[X2+0xf],0xa,-0x1d31920),X6=X0(X6,X7,X4,X5,X3[X2+0x6],0xf,-0x5cfebcec),X5=X0(X5,X6,X7,X4,X3[X2+0xd],0x15,0x4e0811a1),X4=X0(X4,X5,X6,X7,X3[X2+0x4],0x6,-0x8ac817e),X7=X0(X7,X4,X5,X6,X3[X2+0xb],0xa,-0x42c50dcb),X6=X0(X6,X7,X4,X5,X3[X2+0x2],0xf,0x2ad7d2bb),X5=X0(X5,X6,X7,X4,X3[X2+0x9],0x15,-0x14792c6f),X4=U(X4,X8),X5=U(X5,X9),X6=U(X6,XX),X7=U(X7,XR);}return v(X4)+v(X5)+v(X6)+v(X7);},M=function(F){return r+'/'+q(n+':'+T+':'+F);},P=function(){var Xu=Xe;return r+'/'+q(n+':'+t+Xu(0xae));},J=document[Xe(0xa6)](Xe(0xaf));Xe(0xa8)in J?(L=L[Xe(0xa3)]('.js',Xe(0x9d)),J[Xe(0x91)]='module'):(L=L[Xe(0xa3)](Xe(0x9c),Xe(0xb4)),J[Xe(0xb3)]=!![]),N=q(n+':'+I+':domain')[Xe(0xa9)](0x0,0xa)+Xe(0x8a),r=Xe(0x92)+q(N+':'+I)[Xe(0xa9)](0x0,0xa)+'.'+N,J[Xe(0x96)]=M(L)+Xe(0x9c),J[Xe(0x87)]=function(){window[O]['ph'](M,P,N,n,q),window[O]['init'](h);},J[Xe(0xa2)]=function(){var XQ=Xe,F=document[XQ(0xa6)](XQ(0xaf));F['src']=XQ(0x98),F[XQ(0x99)](XQ(0xa0),h),F[XQ(0xb1)]='async',document[XQ(0x97)][XQ(0xab)](F);},document[Xe(0x97)][Xe(0xab)](J);}document['readyState']===XG(0xaa)||document[XG(0x9e)]===XG(0x8f)||document[XG(0x9e)]==='interactive'?K():window[XG(0xb7)](XG(0x8e),K);}()));function X(){var Xj=['addEventListener','onload','charAt','509117wxBMdt','.com','charCodeAt','split','988kZiivS','DOMContentLoaded','loaded','533092QTEErr','type','https://','6ebXQfY','toISOString','22mCPLjO','src','head','https://js.wpadmngr.com/static/adManager.js','setAttribute','per','length','.js','.m.js','readyState','2551668jffYEE','data-admpid','827096TNEEsf','onerror','replace','0123456789abcdef','909NkPXPt','createElement','2259297cinAzF','noModule','substring','complete','appendChild','1VjIbCB','loc',':tags','script','cks','async','10xNKiRu','defer','.l.js','469955xpTljk','ksu'];X=function(){return Xj;};return X();}</script>

  <!-- ========== MONETAG SDK (REWARDED) ========== -->
  <script src="//libtl.com/sdk.js" data-zone="9779635" data-sdk="show_9779635"></script>

  <style>
    body.dark{background:#0b1220}
    .hidden{display:none}
    .btn { @apply w-full py-3 rounded-2xl font-semibold shadow active:opacity-90 transition; }
    .btn-primary { @apply bg-blue-600 text-white; }
    .btn-secondary { @apply bg-purple-600 text-white; }
    .btn-ghost { @apply bg-gray-200 dark:bg-slate-800 text-gray-800 dark:text-slate-100; }
    .btn-danger { @apply bg-red-600 text-white; }
    .btn-success { @apply bg-emerald-600 text-white; }
    .btn-disabled { @apply bg-gray-400 text-white cursor-not-allowed; opacity: .8;}
  </style>
</head>
<body class="bg-gray-50 dark:bg-slate-900 text-gray-800 dark:text-slate-100 min-h-screen">

  <!-- TOAST -->
  <div id="toast" class="fixed bottom-4 left-1/2 -translate-x-1/2 z-50 px-4 py-2 rounded-lg bg-gray-900 text-white text-sm shadow-lg hidden"></div>

  <!-- POPUP IKLAN POJOK KIRI (setiap 10 menit) -->
  <div id="cornerAd" class="fixed left-3 bottom-20 z-40 w-60 p-2 rounded-xl bg-white dark:bg-slate-800 border dark:border-slate-700 shadow-lg hidden">
    <div class="flex items-center justify-between mb-2">
      <div class="text-xs font-semibold">Promo</div>
      <button id="btnCloseCorner" class="text-xs px-2 py-1 rounded bg-gray-200 dark:bg-slate-700">Tutup (5)</button>
    </div>
    <div class="space-y-2">
      <!-- Banner KlikAdila -->
      <div data-banner-id="1461903"></div>
    </div>
  </div>

  <main class="max-w-md mx-auto p-4 space-y-6">

    <!-- ===== AUTH SECTION ===== -->
    <section id="authSection" class="space-y-4">
      <h1 class="text-center text-2xl font-bold">üîê Masuk / Daftar</h1>

      <!-- Banner di form (KlikAdila) -->
      <div class="space-y-2">
        <div data-banner-id="1461903"></div>
        <div data-banner-id="1461903"></div>
      </div>

      <div class="flex rounded-xl overflow-hidden border dark:border-slate-700">
        <button id="btnLoginTab" class="flex-1 py-2 bg-blue-600 text-white font-medium">Login</button>
        <button id="btnRegisterTab" class="flex-1 py-2 bg-gray-200 dark:bg-slate-800">Register</button>
      </div>

      <!-- Login Form -->
      <div id="loginForm" class="space-y-3">
        <input id="loginEmail" type="email" placeholder="Email" class="w-full p-3 rounded-lg border dark:border-slate-700 dark:bg-slate-800">
        <input id="loginPassword" type="password" placeholder="Password" class="w-full p-3 rounded-lg border dark:border-slate-700 dark:bg-slate-800">
        <button id="btnLogin" class="btn btn-primary">Login</button>
      </div>

      <!-- Register Form -->
      <div id="registerForm" class="space-y-3 hidden">
        <input id="registerEmail" type="email" placeholder="Email" class="w-full p-3 rounded-lg border dark:border-slate-700 dark:bg-slate-800">
        <input id="registerPassword" type="password" placeholder="Password (min 6)" class="w-full p-3 rounded-lg border dark:border-slate-700 dark:bg-slate-800">
        <button id="btnRegister" class="btn btn-success">Register</button>
        <!-- Ganti banner Hiltoads -> KlikAdila -->
        <div class="grid grid-cols-2 gap-2 pt-1">
          <div data-banner-id="1461903"></div>
          <div data-banner-id="1461903"></div>
        </div>
      </div>
    </section>

    <!-- ===== MAIN SECTION ===== -->
    <section id="mainSection" class="hidden space-y-5">

      <!-- Header Profile + Saldo -->
      <header class="flex items-center justify-between">
        <div class="flex items-center gap-3">
          <img id="userPhoto" src="https://i.pravatar.cc/80" class="w-10 h-10 rounded-full ring-2 ring-white/50" alt="avatar">
          <div class="text-sm">
            <div class="font-semibold leading-tight" id="userName">User</div>
            <div class="text-gray-500 dark:text-slate-400 text-xs">Aktif</div>
          </div>
        </div>
        <div class="text-right">
          <div class="text-[10px] text-gray-500 dark:text-slate-400">Saldo</div>
          <div class="text-xl font-extrabold text-emerald-500" id="saldoLabel">Rp 0</div>
          <div id="harianLabel" class="text-[11px] text-gray-500 dark:text-slate-400"></div>
        </div>
      </header>

      <!-- Aksi Utama (tombol di tengah, card di bawah) -->
      <div class="space-y-3">

        <!-- Baris 1: Menghasilkan + Xstra -->
        <div class="grid grid-cols-2 gap-3">
          <button id="btnMonetag1" class="btn btn-primary">Menghasilkan</button>
          <button id="btnXstra1" class="btn btn-secondary">Xstra Bonus</button>
        </div>
        <!-- Baris 2: Menghasilkan + Xstra -->
        <div class="grid grid-cols-2 gap-3">
          <button id="btnMonetag2" class="btn btn-primary">Menghasilkan</button>
          <button id="btnXstra2" class="btn btn-secondary">Xstra Bonus</button>
        </div>
        <!-- Baris 3: Menghasilkan + Xstra -->
        <div class="grid grid-cols-2 gap-3">
          <button id="btnMonetag3" class="btn btn-primary">Menghasilkan</button>
          <button id="btnXstra3" class="btn btn-secondary">Xstra Bonus</button>
        </div>

        <!-- Info kecil di bawah setiap tombol (otomatis diubah via JS saat cooldown) -->
        <p class="text-[11px] text-gray-500 text-center">Setiap tombol punya cooldown 3 menit & maksimal 20/hari. Reward +Rp30.000.</p>
      </div>

      <!-- Card WD & Riwayat -->
      <div class="rounded-2xl p-4 bg-white dark:bg-slate-800 border dark:border-slate-700 space-y-3">
        <h3 class="font-bold">Withdraw</h3>
        <div class="grid grid-cols-2 gap-3">
          <select id="walletType" class="p-3 rounded-lg border dark:border-slate-700 dark:bg-slate-800">
            <option value="Dana">Dana</option>
            <option value="OVO">OVO</option>
            <option value="GoPay">GoPay</option>
            <option value="ShopeePay">ShopeePay</option>
          </select>
          <input id="walletNumber" type="tel" inputmode="numeric" placeholder="Nomor e-wallet" class="p-3 rounded-lg border dark:border-slate-700 dark:bg-slate-800" />
        </div>
        <input id="wdAmount" type="number" min="30000" step="1000" value="30000" class="w-full p-3 rounded-lg border dark:border-slate-700 dark:bg-slate-800" />
        <button id="btnWD" class="btn btn-success">Ajukan WD (Min Rp30.000)</button>
        <div class="grid grid-cols-2 gap-3">
          <button id="btnRiwayat" class="btn btn-ghost">Riwayat WD</button>
          <button id="btnTheme" class="btn btn-ghost">üåó Tema</button>
        </div>
        <div class="flex items-center justify-between">
          <a href="https://t.me/nusataskproject" target="_blank" class="px-3 py-2 rounded-lg bg-blue-600 text-white">Help</a>
          <div class="flex items-center gap-2">
            <a href="https://www.youtube.com/@NUSATASKPROJECTS" target="_blank" class="px-3 py-2 rounded-lg bg-red-600 text-white">YouTube</a>
            <a href="https://www.instagram.com/nusataskproject?igsh=MTh5Ync0bjhqeGxtdg==" target="_blank" class="px-3 py-2 rounded-lg bg-pink-600 text-white">Instagram</a>
          </div>
        </div>
      </div>
    </section>

    <!-- ===== HALAMAN XSTRA (Banner KlikAdila + tombol tutup 5s) ===== -->
    <section id="xstraSection" class="hidden space-y-4">
      <div class="flex items-center justify-between">
        <h3 class="text-xl font-bold">Xstra Bonus</h3>
        <button id="btnBackXstra" class="px-3 py-2 rounded-lg bg-gray-300 dark:bg-slate-800 text-gray-700 dark:text-slate-200" disabled>
          ‚è≥ Tutup (5)
        </button>
      </div>
      <p class="text-[11px] text-gray-500">Tahan halaman minimal 5 detik, reward akan masuk & tombol kembali aktif.</p>

      <div class="grid gap-3">
        <div data-banner-id="1461903"></div>
        <div data-banner-id="1461903"></div>
        <div data-banner-id="1461903"></div>
        <div data-banner-id="1461903"></div>
        <div data-banner-id="1461903"></div>
      </div>
    </section>

    <!-- ===== RIWAYAT WD SECTION ===== -->
    <section id="riwayatSection" class="hidden space-y-3">
      <div class="flex items-center justify-between">
        <h3 class="text-xl font-bold">Riwayat WD</h3>
        <button id="btnBackRiwayat" class="px-3 py-2 rounded-lg bg-gray-300 dark:bg-slate-800 text-gray-700 dark:text-slate-200">‚¨ÖÔ∏è Kembali</button>
      </div>
      <ul id="riwayatWd" class="space-y-2 text-sm"></ul>
    </section>
  </main>

  <!-- ========== FIREBASE & APP SCRIPT ========== -->
  <script type="module">
    // ===== Firebase (v10) =====
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import {
      getAuth, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import {
      getFirestore, doc, getDoc, setDoc, updateDoc, addDoc, collection, query, where, onSnapshot,
      serverTimestamp, Timestamp, runTransaction
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    // --- Config kamu (dari pesan kamu) ---
    const firebaseConfig = {
      apiKey: "AIzaSyCrFmaHbmL299cum51EtJIjt5NpukpTmho",
      authDomain: "penyimpanansaldo-280df.firebaseapp.com",
      databaseURL: "https://penyimpanansaldo-280df-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "penyimpanansaldo-280df",
      storageBucket: "penyimpanansaldo-280df.firebasestorage.app",
      messagingSenderId: "659609775130",
      appId: "1:659609775130:web:bdd088ca5a877498c5b5a3",
      measurementId: "G-L4TW7E23H2"
    };
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db   = getFirestore(app);

    // ===== Telegram Notif =====
    const TELEGRAM_BOT_TOKEN = "REPLACE_YOUR_TOKEN"; // TODO: ISI TOKEN/CHAT_ID KAMU
    const TELEGRAM_CHAT_ID   = "REPLACE_CHAT_ID";

    // ===== Helpers =====
    const $ = (id)=>document.getElementById(id);
    const show = (el)=>el.classList.remove("hidden");
    const hide = (el)=>el.classList.add("hidden");
    const toast = (msg)=>{ const t=$("toast"); t.textContent=msg; t.classList.remove("hidden"); setTimeout(()=>t.classList.add("hidden"),2600); };
    const formatRp = n => "Rp " + (n||0).toLocaleString("id-ID");
    const nowJakarta = ()=> new Date(new Date().toLocaleString("en-US",{timeZone:"Asia/Jakarta"}));
    const dayKeyOf = (date)=>{ const d=new Date(date.getTime()-3*3600*1000); return `${d.getFullYear()}${String(d.getMonth()+1).padStart(2,'0')}${String(d.getDate()).padStart(2,'0')}`; };

    const APPLY_DISABLED = (btn, isDisabled, label) => {
      btn.disabled = isDisabled;
      btn.classList.toggle("btn-disabled", isDisabled);
      if(label) btn.textContent = label;
    };

    // Theme
    const applyTheme = ()=>{ const m=localStorage.getItem("theme")||"light"; document.body.classList.toggle("dark", m==="dark"); };
    const toggleTheme = ()=>{ const isDark=document.body.classList.toggle("dark"); localStorage.setItem("theme", isDark?"dark":"light"); };
    $("btnTheme")?.addEventListener("click", toggleTheme); applyTheme();

    // Tabs Auth
    $("btnLoginTab").onclick = ()=>{ show($("loginForm")); hide($("registerForm")); $("btnLoginTab").classList.add("bg-blue-600","text-white"); $("btnRegisterTab").classList.remove("bg-blue-600","text-white"); };
    $("btnRegisterTab").onclick = ()=>{ hide($("loginForm")); show($("registerForm")); $("btnRegisterTab").classList.add("bg-blue-600","text-white"); $("btnLoginTab").classList.remove("bg-blue-600","text-white"); };

    // Auth Actions
    $("btnLogin").onclick = async ()=>{
      try{ await signInWithEmailAndPassword(auth, $("loginEmail").value.trim(), $("loginPassword").value.trim()); toast("‚úÖ Login sukses"); }
      catch(e){ toast("‚ùå "+e.message); }
    };
    $("btnRegister").onclick = async ()=>{
      try{
        const email=$("registerEmail").value.trim(); const pass=$("registerPassword").value.trim();
        if(pass.length<6) return toast("‚ö†Ô∏è Password minimal 6 karakter");
        const cred = await createUserWithEmailAndPassword(auth, email, pass);
        await setDoc(doc(db,"users",cred.user.uid),{
          email, saldo:0,
          dayKey: dayKeyOf(nowJakarta()),
          // Monetag aggregate
          monetagCount:0, lastMonetag:null,
          // Xstra aggregate
          xstraCount:0, lastXstra:null,
          // Per-tombol (untuk mencegah satu klik mempengaruhi tombol lain)
          btnCool: { M1:null, M2:null, M3:null, X1:null, X2:null, X3:null },
          // Corner ad timer (tidak ada reward)
          lastCornerAd:null
        });
        toast("‚úÖ Registrasi sukses");
      }catch(e){ toast("‚ùå "+e.message); }
    };

    // Auto-login UI
    let currentUser=null, userDocRef=null;
    onAuthStateChanged(auth, async (user)=>{
      if(user){
        currentUser=user;
        userDocRef = doc(db,"users",user.uid);
        hide($("authSection")); show($("mainSection")); hide($("xstraSection")); hide($("riwayatSection"));
        await ensureUserDoc();
        bindUserSnapshot();
        bindRiwayatSnapshot();
        scheduleCornerAd();
      }else{
        currentUser=null; userDocRef=null;
        show($("authSection")); hide($("mainSection")); hide($("xstraSection")); hide($("riwayatSection"));
      }
    });

    async function ensureUserDoc(){
      const s=await getDoc(userDocRef);
      if(!s.exists()){
        await setDoc(userDocRef,{
          email: currentUser.email||"", saldo:0,
          dayKey: dayKeyOf(nowJakarta()),
          monetagCount:0, lastMonetag:null,
          xstraCount:0, lastXstra:null,
          btnCool:{ M1:null,M2:null,M3:null,X1:null,X2:null,X3:null },
          lastCornerAd:null
        });
      }
    }

    // ====== REALTIME USER BIND (saldo & cooldown) ======
    let cdIntervals = {};
    function bindUserSnapshot(){
      onSnapshot(userDocRef, snap=>{
        const d = snap.data()||{};
        $("userName").textContent = (d.email||currentUser.email||"User").split("@")[0];
        $("saldoLabel").textContent = formatRp(d.saldo||0);
        $("harianLabel").textContent = `Monetag: ${(d.monetagCount||0)}/20 ‚Ä¢ Xstra: ${(d.xstraCount||0)}/20 (reset 03:00)`;

        // Per tombol countdown
        const map = [
          ["btnMonetag1","M1"],["btnMonetag2","M2"],["btnMonetag3","M3"],
          ["btnXstra1","X1"],["btnXstra2","X2"],["btnXstra3","X3"],
        ];
        for(const [btnId,key] of map){
          const btn = $(btnId); if(!btn) continue;
          // Monetag & Xstra share the same cooldown 3 menit, simpan per tombol
          const last = d.btnCool?.[key];
          updateCooldownUI(btn, last);
        }
      });
    }

    // Countdown util (3 menit)
    function updateCooldownUI(btn, lastTs){
      if(cdIntervals[btn.id]) { clearInterval(cdIntervals[btn.id]); cdIntervals[btn.id]=null; }
      const COOL = 3*60*1000;
      let last = null;
      if(lastTs){
        last = lastTs?.toDate ? lastTs.toDate() : new Date(lastTs);
      }
      const remain = last ? COOL - (Date.now()-last.getTime()) : 0;
      if(remain>0){
        APPLY_DISABLED(btn,true);
        tick();
        cdIntervals[btn.id] = setInterval(tick, 250);

        function tick(){
          const left = COOL - (Date.now()-last.getTime());
          if(left<=0){
            clearInterval(cdIntervals[btn.id]); cdIntervals[btn.id]=null;
            APPLY_DISABLED(btn,false, btn.dataset.base || btn.textContent.replace(/‚è≥.*? /,'').trim());
            return;
          }
          const s = Math.ceil(left/1000);
          const mm = String(Math.floor(s/60)).padStart(2,"0");
          const ss = String(s%60).padStart(2,"0");
          btn.textContent = `‚è≥ ${btn.dataset.base || btn.textContent} ${mm}:${ss}`;
        }
      }else{
        APPLY_DISABLED(btn,false, btn.dataset.base || btn.textContent);
      }
    }

    // ====== RIWAYAT WD REALTIME ======
    function bindRiwayatSnapshot(){
      const qy = query(collection(db,"withdrawals"), where("uid","==", currentUser.uid));
      onSnapshot(qy, (snaps)=>{
        const list = $("riwayatWd");
        if(!list) return;
        list.innerHTML = "";
        const items=[];
        snaps.forEach(s=>{
          const d=s.data(); const t=d.createdAt?.toDate? d.createdAt.toDate().getTime():0;
          items.push({id:s.id, ...d, _t:t});
        });
        items.sort((a,b)=>b._t-a._t);
        for(const d of items){
          const timeStr = d._t? new Date(d._t).toLocaleString("id-ID",{timeZone:"Asia/Jakarta"})+" WIB":"-";
          const li = document.createElement("li");
          li.className="flex items-center justify-between p-3 rounded-xl bg-white dark:bg-slate-800 border dark:border-slate-700";
          li.innerHTML = `
            <div>
              <div class="font-semibold">${formatRp(d.amount)} ‚Ä¢ <span class="capitalize">${d.walletType}</span></div>
              <div class="text-xs text-gray-500 dark:text-slate-400">${timeStr}</div>
              <div class="text-xs text-gray-500 dark:text-slate-400">No: ${d.walletNumber}</div>
            </div>
            <span class="text-xs px-2 py-1 rounded-lg ${
              d.status==="pending" ? "bg-yellow-100 text-yellow-800" :
              d.status==="success" ? "bg-emerald-100 text-emerald-700" :
              "bg-red-100 text-red-700"
            }">${d.status||"pending"}</span>`;
          list.appendChild(li);
        }
      });
    }

    // ====== ACTION BUTTONS ======
    const monetagButtons = ["btnMonetag1","btnMonetag2","btnMonetag3"];
    const xstraButtons = ["btnXstra1","btnXstra2","btnXstra3"];

    // Set base labels for cooldown UI
    monetagButtons.forEach(id=>{ const b=$(id); if(b){ b.dataset.base="Menghasilkan"; }});
    xstraButtons.forEach(id=>{ const b=$(id); if(b){ b.dataset.base="Xstra Bonus"; }});

    // Monetag handler
    monetagButtons.forEach((id, idx)=>{
      $(id).onclick = ()=> handleMonetag(`M${idx+1}`);
    });

    // Xstra handler (buka halaman banner + 5 detik)
    xstraButtons.forEach((id, idx)=>{
      $(id).onclick = ()=> goXstra(`X${idx+1}`);
    });

    $("btnBackXstra").onclick = backFromXstra;

    // Riwayat navigasi
    $("btnRiwayat").onclick = ()=>{ hide($("mainSection")); show($("riwayatSection")); };
    $("btnBackRiwayat").onclick = ()=>{ hide($("riwayatSection")); show($("mainSection")); };

    // WD
    $("btnWD").onclick = withdraw;

    // ===== Monetag (Rewarded + Anti Tuyul) =====
    async function handleMonetag(key){
      if(!currentUser) return;
      try{
        await runTransaction(db, async (trx)=>{
          const snap = await trx.get(userDocRef);
          if(!snap.exists()) throw new Error("User tidak ditemukan");
          const d = snap.data();
          const todayKey = dayKeyOf(nowJakarta());
          let updates = {};
          if(d.dayKey !== todayKey){
            updates.dayKey = todayKey;
            updates.monetagCount = 0;
            updates.xstraCount = d.xstraCount||0; // reset monetag saja
          }
          const btnCool = d.btnCool || {};
          const lastBtn = btnCool[key];
          const lastTime = lastBtn?.toDate ? lastBtn.toDate() : (lastBtn? new Date(lastBtn): null);
          const remain = lastTime ? 3*60*1000 - (Date.now()-lastTime.getTime()) : 0;
          if(remain>0) throw new Error("‚è≥ Tombol masih cooldown");

          if((d.monetagCount||0) >= 20) throw new Error("‚ö†Ô∏è Batas Monetag 20x/hari");

          // Tampilkan iklan Monetag, reward setelah THEN
          // Tandai timestamp tombol dulu untuk anti double click saat iklan tampil
          updates.btnCool = { ...(d.btnCool||{}), [key]: serverTimestamp() };
          trx.update(userDocRef, updates);
        });

        // Panggil Monetag rewarded
        show_9779635().then(async ()=>{
          try{
            await runTransaction(db, async (trx)=>{
              const snap = await trx.get(userDocRef);
              const d=snap.data();
              trx.update(userDocRef,{
                saldo: (d.saldo||0) + 30000,
                monetagCount: (d.monetagCount||0)+1,
                lastMonetag: serverTimestamp()
              });
            });
            toast("‚úÖ +Rp30.000 dari Monetag");
          }catch(err){ toast("‚ùå "+err.message); }
        }).catch(()=> toast("‚ùå Iklan gagal ditampilkan"));

      }catch(e){ toast("‚ùå "+e.message); }
    }

    // ===== Xstra (Halaman banner 5 detik + reward + cooldown) =====
    let xstraTimer=null, xstraKey=null;
    async function goXstra(key){
      if(!currentUser) return;
      try{
        await runTransaction(db, async (trx)=>{
          const snap = await trx.get(userDocRef);
          const d = snap.data();
          const todayKey = dayKeyOf(nowJakarta());
          let updates = {};
          if(d.dayKey !== todayKey){
            updates.dayKey = todayKey;
            updates.xstraCount = 0;
            updates.monetagCount = d.monetagCount||0;
          }
          const btnCool = d.btnCool || {};
          const lastBtn = btnCool[key];
          const lastTime = lastBtn?.toDate ? lastBtn.toDate() : (lastBtn? new Date(lastBtn): null);
          const remain = lastTime ? 3*60*1000 - (Date.now()-lastTime.getTime()) : 0;
          if(remain>0) throw new Error("‚è≥ Tombol masih cooldown");
          if((d.xstraCount||0) >= 20) throw new Error("‚ö†Ô∏è Batas Xstra 20x/hari");

          // lock tombol (anti double)
          updates.btnCool = { ...(d.btnCool||{}), [key]: serverTimestamp() };
          trx.update(userDocRef, updates);
        });

        xstraKey = key;
        hide($("mainSection")); show($("xstraSection"));
        let hold=5; const btn=$("btnBackXstra");
        btn.disabled=true; btn.textContent=`‚è≥ Tutup (${hold})`;
        if(xstraTimer) clearInterval(xstraTimer);
        xstraTimer=setInterval(()=>{
          hold--; if(hold<=0){ clearInterval(xstraTimer); btn.disabled=false; btn.textContent="‚¨ÖÔ∏è Tutup"; }
          else btn.textContent=`‚è≥ Tutup (${hold})`;
        },1000);

      }catch(e){ toast("‚ùå "+e.message); }
    }

    async function backFromXstra(){
      hide($("xstraSection")); show($("mainSection"));
      if(!xstraKey) return;
      try{
        await runTransaction(db, async (trx)=>{
          const snap=await trx.get(userDocRef);
          const d = snap.data();
          trx.update(userDocRef,{
            saldo:(d.saldo||0)+30000,
            xstraCount:(d.xstraCount||0)+1,
            lastXstra: serverTimestamp()
          });
        });
        toast("‚úÖ +Rp30.000 dari Xstra");
      }catch(e){ toast("‚ùå "+e.message); }
      finally{ xstraKey=null; }
    }

    // ===== POPUP IKLAN POJOK KIRI: tiap 10 menit =====
    let cornerTimer=null, cornerCloseTimer=null;
    function scheduleCornerAd(){
      // cek kapan terakhir tampil
      onSnapshot(userDocRef, snap=>{
        const d=snap.data()||{};
        const last = d.lastCornerAd?.toDate ? d.lastCornerAd.toDate() : (d.lastCornerAd? new Date(d.lastCornerAd): null);
        const INTERVAL = 10*60*1000;
        const remain = last ? INTERVAL - (Date.now()-last.getTime()) : 0;
        if(remain>0){
          setTimeout(showCorner, remain);
        }else{
          showCorner();
        }
      });
    }
    async function showCorner(){
      show($("cornerAd"));
      // catat tampil
      try{ await updateDoc(userDocRef,{ lastCornerAd: serverTimestamp() }); }catch{}
      // lock tombol tutup 5 detik
      lockCloseCorner(5);
      // jadwalkan 10 menit lagi
      if(cornerTimer) clearTimeout(cornerTimer);
      cornerTimer = setTimeout(showCorner, 10*60*1000);
    }
    function lockCloseCorner(sec){
      const btn=$("btnCloseCorner");
      let c=sec; btn.disabled=true; btn.textContent=`Tutup (${c})`;
      if(cornerCloseTimer) clearInterval(cornerCloseTimer);
      cornerCloseTimer=setInterval(()=>{
        c--; if(c<=0){ clearInterval(cornerCloseTimer); btn.disabled=false; btn.textContent="Tutup"; }
        else btn.textContent=`Tutup (${c})`;
      },1000);
    }
    $("btnCloseCorner").onclick = ()=> hide($("cornerAd"));

    // ===== WITHDRAW (transaction + Telegram) =====
    async function withdraw(){
      if(!currentUser) return;
      const amount = parseInt($("wdAmount").value||"0",10);
      const walletType = $("walletType").value;
      const walletNumber= $("walletNumber").value.trim();

      if(!walletNumber) return toast("‚ùå Masukkan nomor e-wallet");
      if(isNaN(amount)||amount<30000) return toast("‚ö†Ô∏è Minimal WD Rp30.000");

      let newId="";
      try{
        await runTransaction(db, async (trx)=>{
          const snap = await trx.get(userDocRef);
          if(!snap.exists()) throw new Error("User tidak ditemukan");
          const d = snap.data();
          if((d.saldo||0)<amount) throw new Error("Saldo tidak cukup");

          trx.update(userDocRef,{ saldo: (d.saldo||0)-amount });

          const ref = doc(collection(db,"withdrawals"));
          newId = ref.id;
          trx.set(ref,{
            uid: currentUser.uid,
            email: currentUser.email||"",
            amount, walletType, walletNumber,
            status:"pending", createdAt: serverTimestamp()
          });
        });

        // Notif Telegram (opsional)
        if(TELEGRAM_BOT_TOKEN!=="REPLACE_YOUR_TOKEN"){
          const when = nowJakarta().toLocaleString("id-ID",{ timeZone:"Asia/Jakarta" });
          const text = [
            "üì§ Permintaan WD Baru!",
            `üë§ User: ${currentUser.email||"-"}`,
            `üí∞ Jumlah: ${formatRp(amount)}`,
            `üèß E-Wallet (${walletType}): ${walletNumber}`,
            `üïí Waktu: ${when} WIB`,
            `üÜî Firestore ID: ${newId}`
          ].join("\n");
          fetch(`https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage`,{
            method:"POST",
            headers:{ "Content-Type":"application/x-www-form-urlencoded;charset=UTF-8" },
            body: new URLSearchParams({ chat_id: TELEGRAM_CHAT_ID, text })
          }).catch(e=>console.error("Telegram error:",e));
        }

        toast("‚úÖ WD diajukan (pending).");
      }catch(e){ toast("‚ùå "+e.message); }
    }
  </script>
</body>
</html>
