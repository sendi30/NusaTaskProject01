<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Penghasil Uang</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body.dark { background:#0b1220; }
    .hidden { display:none; }
    .btn-disabled { background-color: #9ca3af !important; cursor: not-allowed; }
    .btn-active { opacity: 1; }
    .btn-cooldown { background-color: #6b7280 !important; opacity: 0.8; }
    #toast { transition: all .3s ease; }
    .saldo-text { font-size: 1.2rem; font-weight: bold; }
  </style>
</head>
<body class="bg-gray-50 dark:bg-slate-900 text-gray-800 dark:text-slate-100 min-h-screen">

  <!-- Toast -->
  <div id="toast" class="fixed bottom-4 left-1/2 -translate-x-1/2 z-50 px-4 py-2 rounded-lg bg-gray-900 text-white text-sm shadow-lg hidden"></div>

  <main class="max-w-md mx-auto p-4">

    <!-- AUTH -->
    <section id="authSection" class="space-y-5">
      <h1 class="text-center text-2xl font-bold">🔐 Masuk / Daftar</h1>

      <div class="flex rounded-xl overflow-hidden border dark:border-slate-700">
        <button id="btnLoginTab" class="flex-1 py-2 bg-blue-600 text-white font-medium">Login</button>
        <button id="btnRegisterTab" class="flex-1 py-2 bg-gray-200 dark:bg-slate-800">Register</button>
      </div>

      <!-- Login -->
      <div id="loginForm" class="space-y-3">
        <input id="loginEmail" type="email" placeholder="Email" class="w-full p-3 rounded-lg border dark:border-slate-700 dark:bg-slate-800">
        <input id="loginPassword" type="password" placeholder="Password" class="w-full p-3 rounded-lg border dark:border-slate-700 dark:bg-slate-800">
        <button id="btnLogin" class="w-full py-3 rounded-xl bg-blue-600 text-white font-semibold">Login</button>
      </div>

      <!-- Register -->
      <div id="registerForm" class="space-y-3 hidden">
        <input id="registerEmail" type="email" placeholder="Email" class="w-full p-3 rounded-lg border dark:border-slate-700 dark:bg-slate-800">
        <input id="registerPassword" type="password" placeholder="Password (min 6)" class="w-full p-3 rounded-lg border dark:border-slate-700 dark:bg-slate-800">
        <button id="btnRegister" class="w-full py-3 rounded-xl bg-emerald-600 text-white font-semibold">Register</button>
      </div>
    </section>

    <!-- MAIN -->
    <section id="mainSection" class="hidden space-y-5">
      <!-- Header -->
      <header class="flex items-center justify-between">
        <div>
          <div class="font-semibold" id="userName">User</div>
        </div>
        <div class="text-right">
          <div class="text-xs text-gray-500">Saldo</div>
          <div id="saldoLabel" class="saldo-text text-emerald-500">Rp 0</div>
        </div>
      </header>

      <!-- Buttons -->
      <div class="grid gap-3">
        <!-- Row 1 -->
        <div class="grid grid-cols-2 gap-3">
          <button id="btnRichAds" class="py-4 rounded-xl bg-blue-600 text-white font-semibold">💰 Menghasilkan</button>
          <button id="btnExtra1" class="py-4 rounded-xl bg-purple-600 text-white font-semibold">🎁 Xstra Bonus</button>
        </div>
        <div class="flex justify-between text-xs">
          <div id="timerRichAds" class="text-gray-500"></div>
          <div id="timerExtra1" class="text-gray-500"></div>
        </div>

        <!-- Row 2 -->
        <div class="grid grid-cols-2 gap-3">
          <button id="btnMonetag" class="py-4 rounded-xl bg-blue-600 text-white font-semibold">💰 Menghasilkan</button>
          <button id="btnExtra2" class="py-4 rounded-xl bg-purple-600 text-white font-semibold">🎁 Xstra Bonus</button>
        </div>
        <div class="flex justify-between text-xs">
          <div id="timerMonetag" class="text-gray-500"></div>
          <div id="timerExtra2" class="text-gray-500"></div>
        </div>

        <!-- Row 3 -->
        <div class="grid grid-cols-2 gap-3">
          <button id="btnAdexium" class="py-4 rounded-xl bg-blue-600 text-white font-semibold">💰 Menghasilkan</button>
          <button id="btnExtra3" class="py-4 rounded-xl bg-purple-600 text-white font-semibold">🎁 Xstra Bonus</button>
        </div>
        <div class="flex justify-between text-xs">
          <div id="timerAdexium" class="text-gray-500"></div>
          <div id="timerExtra3" class="text-gray-500"></div>
        </div>
      </div>

      <!-- Withdraw -->
      <section class="space-y-3">
        <h3 class="font-bold">Withdraw</h3>
        <div class="grid grid-cols-2 gap-3">
          <select id="walletType" class="p-3 rounded-lg border dark:border-slate-700 dark:bg-slate-800">
            <option value="Dana">Dana</option>
            <option value="OVO">OVO</option>
            <option value="GoPay">GoPay</option>
            <option value="ShopeePay">ShopeePay</option>
          </select>
          <input id="walletNumber" type="tel" placeholder="Nomor e-wallet" class="p-3 rounded-lg border dark:border-slate-700 dark:bg-slate-800">
        </div>
        <input id="wdAmount" type="number" min="30000" step="1000" value="30000" class="w-full p-3 rounded-lg border dark:border-slate-700 dark:bg-slate-800">
        <button id="btnWD" class="w-full py-3 rounded-xl bg-emerald-600 text-white font-semibold">Ajukan WD</button>
      </section>

      <!-- Riwayat -->
      <section>
        <h3 class="font-bold mb-2">Riwayat WD</h3>
        <ul id="riwayatWd" class="space-y-2 text-sm"></ul>
      </section>

      <!-- Footer -->
      <footer class="flex items-center justify-between pt-4 border-t dark:border-slate-800">
        <button id="btnTheme" class="px-3 py-2 rounded-lg bg-gray-200 dark:bg-slate-800">🌗 Tema</button>
        <div class="flex gap-2">
          <a href="https://t.me/nusataskproject" target="_blank" class="px-3 py-2 rounded-lg bg-blue-600 text-white">Help</a>
          <a href="https://www.youtube.com/@NUSATASKPROJECTS" target="_blank" class="px-3 py-2 rounded-lg bg-red-600 text-white">YouTube</a>
          <a href="https://www.instagram.com/nusataskproject?igsh=MTh5Ync0bjhqeGxtdg==" target="_blank" class="px-3 py-2 rounded-lg bg-pink-500 text-white">Instagram</a>
        </div>
      </footer>
    </section>
  </main>

  <!-- Firebase + Ads SDK -->
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script src="https://richinfo.co/richpartners/telegram/js/tg-ob.js"></script>
  <script src="//libtl.com/sdk.js" data-zone="9779635" data-sdk="show_9779635"></script>
  <script src="https://cdn.tgads.space/assets/js/adexium-widget.min.js"></script>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import { getFirestore, doc, getDoc, setDoc, updateDoc, addDoc, collection, query, where, onSnapshot, serverTimestamp, runTransaction } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    // Firebase config (pakai punyamu)
    const firebaseConfig = {
      apiKey: "AIzaSyCrFmaHbmL299cum51EtJIjt5NpukpTmho",
      authDomain: "penyimpanansaldo-280df.firebaseapp.com",
      projectId: "penyimpanansaldo-280df",
      storageBucket: "penyimpanansaldo-280df.appspot.com",
      messagingSenderId: "659609775130",
      appId: "1:659609775130:web:bdd088ca5a877498c5b5a3"
    };
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db   = getFirestore(app);

    // Telegram notif
    const BOT_TOKEN = "8236562243:AAFIyLCk2fu9-4GxxYSuIoSKw9DEiv1DVko";
    const CHAT_ID   = "8322802091";

    const $ = id => document.getElementById(id);
    const toast = msg => { const t=$("toast"); t.textContent=msg; t.classList.remove("hidden"); setTimeout(()=>t.classList.add("hidden"),2500); };
    const formatRp = n => "Rp " + (n||0).toLocaleString("id-ID");
    const nowJakarta = () => new Date(new Date().toLocaleString("en-US",{timeZone:"Asia/Jakarta"}));
    const dayKeyOf = (d)=>{ const x=new Date(d.getTime()-3*3600*1000); return `${x.getFullYear()}${String(x.getMonth()+1).padStart(2,'0')}${String(x.getDate()).padStart(2,'0')}`; };

    let currentUser=null, userDocRef=null;

    // Tabs
    $("btnLoginTab").onclick=()=>{ $("loginForm").classList.remove("hidden"); $("registerForm").classList.add("hidden"); };
    $("btnRegisterTab").onclick=()=>{ $("registerForm").classList.remove("hidden"); $("loginForm").classList.add("hidden"); };

    // Login/Register
    $("btnLogin").onclick=()=>signInWithEmailAndPassword(auth,$("loginEmail").value,$("loginPassword").value).catch(e=>toast(e.message));
    $("btnRegister").onclick=async()=>{ try{
      const cred=await createUserWithEmailAndPassword(auth,$("registerEmail").value,$("registerPassword").value);
      await setDoc(doc(db,"users",cred.user.uid),{ email:cred.user.email,saldo:0,counts:{rich:0,extra1:0,monetag:0,extra2:0,adex:0,extra3:0},last:{},dayKey:dayKeyOf(nowJakarta()) });
    }catch(e){toast(e.message);} };

    // Auto-login
    onAuthStateChanged(auth,u=>{ if(u){ currentUser=u; userDocRef=doc(db,"users",u.uid); $("authSection").classList.add("hidden"); $("mainSection").classList.remove("hidden"); bindUser(); bindRiwayat(); } else { $("authSection").classList.remove("hidden"); $("mainSection").classList.add("hidden"); } });

    function bindUser(){ onSnapshot(userDocRef,s=>{ const d=s.data(); $("userName").textContent=d?.email||currentUser.email; $("saldoLabel").textContent=formatRp(d?.saldo||0); }); }
    function bindRiwayat(){ const q=query(collection(db,"withdrawals"),where("uid","==",currentUser.uid)); onSnapshot(q,sn=>{ $("riwayatWd").innerHTML=""; sn.forEach(docSnap=>{ const d=docSnap.data(); const li=document.createElement("li"); li.textContent=`${formatRp(d.amount)} - ${d.walletType} (${d.status})`; $("riwayatWd").appendChild(li); }); }); }

    // Tombol iklan (contoh untuk RichAds, semua tombol mirip, cooldown 3 menit)
    $("btnRichAds").onclick=()=>handleTask("rich",30000,$("btnRichAds"),$("timerRichAds"));
    $("btnExtra1").onclick=()=>handleTask("extra1",15000,$("btnExtra1"),$("timerExtra1"));
    $("btnMonetag").onclick=()=>{ show_9779635().then(()=>{ handleTask("monetag",30000,$("btnMonetag"),$("timerMonetag")); }); };
    $("btnExtra2").onclick=()=>handleTask("extra2",15000,$("btnExtra2"),$("timerExtra2"));
    $("btnAdexium").onclick=()=>handleTask("adex",30000,$("btnAdexium"),$("timerAdexium"));
    $("btnExtra3").onclick=()=>handleTask("extra3",15000,$("btnExtra3"),$("timerExtra3"));

    async function handleTask(key,reward,btn,timerEl){
      if(!currentUser) return;
      try{
        await runTransaction(db,async trx=>{
          const snap=await trx.get(userDocRef); let d=snap.data(); const today=dayKeyOf(nowJakarta());
          if(d.dayKey!==today){ d.counts={rich:0,extra1:0,monetag:0,extra2:0,adex:0,extra3:0}; d.dayKey=today; }
          if(d.counts[key]>=20) throw new Error("Batas harian tercapai");
          trx.update(userDocRef,{saldo:(d.saldo||0)+reward,[`counts.${key}`]:d.counts[key]+1, [`last.${key}`]:serverTimestamp(),dayKey:today});
        });
        startCooldown(btn,timerEl,180000);
        toast(`+${formatRp(reward)}`);
      }catch(e){toast(e.message);}
    }

    function startCooldown(btn,label,ms){ btn.disabled=true; btn.classList.add("btn-cooldown"); const end=Date.now()+ms; const t=setInterval(()=>{ const left=end-Date.now(); if(left<=0){clearInterval(t); btn.disabled=false; btn.classList.remove("btn-cooldown"); label.textContent=""; return;} const s=Math.ceil(left/1000); const m=Math.floor(s/60); const sec=s%60; label.textContent=`Cooldown: ${m}:${String(sec).padStart(2,"0")}`; },1000); }

    // Withdraw
    $("btnWD").onclick=async()=>{ const amount=parseInt($("wdAmount").value),type=$("walletType").value,num=$("walletNumber").value; if(amount<30000||!num)return toast("Input salah"); let newId=""; try{ await runTransaction(db,async trx=>{ const snap=await trx.get(userDocRef); const d=snap.data(); if(d.saldo<amount) throw new Error("Saldo kurang"); trx.update(userDocRef,{saldo:d.saldo-amount}); const ref=doc(collection(db,"withdrawals")); newId=ref.id; trx.set(ref,{uid:currentUser.uid,email:currentUser.email,amount,walletType:type,walletNumber:num,status:"pending",createdAt:serverTimestamp()}); }); fetch(`https://api.telegram.org/bot${BOT_TOKEN}/sendMessage`,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:new URLSearchParams({chat_id:CHAT_ID,text:`WD Baru\nUser:${currentUser.email}\nJumlah:${formatRp(amount)}\n${type}:${num}`})}); toast("WD diajukan"); }catch(e){toast(e.message);} };

    // Tema
    $("btnTheme").onclick=()=>{ document.body.classList.toggle("dark"); };
  </script>
</body>
</html>
